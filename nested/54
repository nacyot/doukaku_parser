
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja"> 
  <head>

<script type="text/javascript" src="/static/js/analytics.js" ></script>
<link type="text/css" rel="stylesheet" href="/static/css/banner-styles.css"/>




    <meta http-equiv="Content-type" content="text/html; charset=UTF-8" />
    <title>
一部のHTMLタグを通すフィルタ
どう書く？org </title>

    <link rel="stylesheet" type="text/css"
	href="/web/20100821161904cs_/http://ja.doukaku.org/static/style/reset-fonts-grids.css" />
    <link rel="stylesheet" type="text/css"
	href="/web/20100821161904cs_/http://ja.doukaku.org/static/style/style.css" />
	
    <link rel="stylesheet" type="text/css"
	href="/web/20100821161904cs_/http://ja.doukaku.org/static/style/pygments.css" />


	
    <!--<script src="/static/js/ieerbug/ieerbug.js" type="text/javascript"></script>-->


<script src="/web/20100821161904js_/http://ja.doukaku.org/static/js/jquery-1.1.3.1.js" type="text/javascript"></script>
<script src="/web/20100821161904js_/http://ja.doukaku.org/static/js/rating.js" type="text/javascript"></script>
<script src="/web/20100821161904js_/http://ja.doukaku.org/static/js/addtag.js" type="text/javascript"></script>

<script type="text/javascript">
is_key_navigation_enable = true;
</script>
<script src="/web/20100821161904js_/http://ja.doukaku.org/static/js/utils.js" type="text/javascript"></script>

</head>


<body id="doukaku_org">
<!-- BEGIN WAYBACK TOOLBAR INSERT -->
<script> if (window.archive_analytics) { window.archive_analytics.values['server_name']="wwwb-app16.us.archive.org";}; </script>

<script type="text/javascript" src="/static/js/disclaim-element.js" ></script>
<script type="text/javascript" src="/static/js/graph-calc.js" ></script>
<script type="text/javascript" src="/static/jflot/jquery.min.js" ></script>
<script type="text/javascript">
//<![CDATA[
var firstDate = 820454400000;
var lastDate = 1388534399999;
var wbPrefix = "/web/";
var wbCurrentUrl = "http:\/\/ja.doukaku.org\/54\/nested\/";

var curYear = -1;
var curMonth = -1;
var yearCount = 18;
var firstYear = 1996;
var imgWidth = 450;
var yearImgWidth = 25;
var monthImgWidth = 2;
var trackerVal = "none";
var displayDay = "21";
var displayMonth = "Aug";
var displayYear = "2010";
var prettyMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

function showTrackers(val) {
	if(val == trackerVal) {
		return;
	}
	if(val == "inline") {
		document.getElementById("displayYearEl").style.color = "#ec008c";
		document.getElementById("displayMonthEl").style.color = "#ec008c";
		document.getElementById("displayDayEl").style.color = "#ec008c";		
	} else {
		document.getElementById("displayYearEl").innerHTML = displayYear;
		document.getElementById("displayYearEl").style.color = "#ff0";
		document.getElementById("displayMonthEl").innerHTML = displayMonth;
		document.getElementById("displayMonthEl").style.color = "#ff0";
		document.getElementById("displayDayEl").innerHTML = displayDay;
		document.getElementById("displayDayEl").style.color = "#ff0";
	}
   document.getElementById("wbMouseTrackYearImg").style.display = val;
   document.getElementById("wbMouseTrackMonthImg").style.display = val;
   trackerVal = val;
}
function getElementX2(obj) {
	var thing = jQuery(obj);
	if((thing == undefined) 
			|| (typeof thing == "undefined") 
			|| (typeof thing.offset == "undefined")) {
		return getElementX(obj);
	}
	return Math.round(thing.offset().left);
}
function trackMouseMove(event,element) {

   var eventX = getEventX(event);
   var elementX = getElementX2(element);
   var xOff = eventX - elementX;
	if(xOff < 0) {
		xOff = 0;
	} else if(xOff > imgWidth) {
		xOff = imgWidth;
	}
   var monthOff = xOff % yearImgWidth;

   var year = Math.floor(xOff / yearImgWidth);
	var yearStart = year * yearImgWidth;
   var monthOfYear = Math.floor(monthOff / monthImgWidth);
   if(monthOfYear > 11) {
       monthOfYear = 11;
   }
   // 1 extra border pixel at the left edge of the year:
   var month = (year * 12) + monthOfYear;
   var day = 1;
	if(monthOff % 2 == 1) {
		day = 15;
	}
	var dateString = 
		zeroPad(year + firstYear) + 
		zeroPad(monthOfYear+1,2) +
		zeroPad(day,2) + "000000";

	var monthString = prettyMonths[monthOfYear];
	document.getElementById("displayYearEl").innerHTML = year + 1996;
	document.getElementById("displayMonthEl").innerHTML = monthString;
	// looks too jarring when it changes..
	//document.getElementById("displayDayEl").innerHTML = zeroPad(day,2);

	var url = wbPrefix + dateString + '/' +  wbCurrentUrl;
	document.getElementById('wm-graph-anchor').href = url;

   //document.getElementById("wmtbURL").value="evX("+eventX+") elX("+elementX+") xO("+xOff+") y("+year+") m("+month+") monthOff("+monthOff+") DS("+dateString+") Moy("+monthOfYear+") ms("+monthString+")";
   if(curYear != year) {
       var yrOff = year * yearImgWidth;
       document.getElementById("wbMouseTrackYearImg").style.left = yrOff + "px";
       curYear = year;
   }
   if(curMonth != month) {
       var mtOff = year + (month * monthImgWidth) + 1;
       document.getElementById("wbMouseTrackMonthImg").style.left = mtOff + "px";
       curMonth = month;
   }
}
//]]>
</script>

<style type="text/css">body{margin-top:0!important;padding-top:0!important;min-width:800px!important;}#wm-ipp a:hover{text-decoration:underline!important;}</style>
<div id="wm-ipp" lang="en" class="__wb_banner_div" style="display:none; position:relative;padding:0 5px;min-height:70px;min-width:800px">


<div id="wm-ipp-inside" class="__wb_banner_div" style="position:fixed;padding:0!important;margin:0!important;width:97%;min-width:780px;border:5px solid #000;border-top:none;background-image:url(/static/images/toolbar/wm_tb_bk_trns.png);text-align:center;-moz-box-shadow:1px 1px 3px #333;-webkit-box-shadow:1px 1px 3px #333;box-shadow:1px 1px 3px #333;font-size:11px!important;font-family:'Lucida Grande','Arial',sans-serif!important;">
   <table style="border-collapse:collapse;margin:0;padding:0;width:100%;"><tbody><tr>
   <td style="padding:10px;vertical-align:top;min-width:110px;">
   <a href="/web/" title="Wayback Machine home page" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wayback-toolbar-logo.png" alt="Wayback Machine" width="110" height="39" border="0"/></a>
   </td>
   <td style="padding:0!important;text-align:center;vertical-align:top;width:100%;">

       <table style="border-collapse:collapse;margin:0 auto;padding:0;width:570px;"><tbody><tr>
       <td style="padding:3px 0;" colspan="2">
       <form target="_top" method="get" action="/web/form-submit.jsp" name="wmtb" id="wmtb" style="margin:0!important;padding:0!important;"><input type="text" name="url" id="wmtbURL" value="http://ja.doukaku.org/54/nested/" style="width:400px;font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;" onfocus="javascript:this.focus();this.select();" /><input type="hidden" name="type" value="replay" /><input type="hidden" name="date" value="20100821161904" /><input type="submit" value="Go" style="font-size:11px;font-family:'Lucida Grande','Arial',sans-serif;margin-left:5px;width: inherit !important" /><span id="wm_tb_options" style="display:block;"></span></form>
       </td>
       <td style="vertical-align:bottom;padding:5px 0 0 0!important;" rowspan="2">
           <table style="border-collapse:collapse;width:110px;color:#99a;font-family:'Helvetica','Lucida Grande','Arial',sans-serif;"><tbody>
			
           <!-- NEXT/PREV MONTH NAV AND MONTH INDICATOR -->
           <tr style="width:110px;height:16px;font-size:10px!important;">
           	<td style="padding-right:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20100611020809/http://ja.doukaku.org/54/nested/" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="11 Jun 2010"><strong>JUN</strong></a>
		                
               </td>
               <td id="displayMonthEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight:bold;text-transform:uppercase;width:34px;height:15px;padding-top:1px;text-align:center;" title="You are here: 16:19:04 Aug 21, 2010">AUG</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight:bold;text-transform:uppercase;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
                       Sep
                       
               </td>
           </tr>

           <!-- NEXT/PREV CAPTURE NAV AND DAY OF MONTH INDICATOR -->
           <tr>
               <td style="padding-right:9px;white-space:nowrap;overflow:visible;text-align:right!important;vertical-align:middle!important;" nowrap="nowrap">
               
		                <a href="/web/20100611020809/http://ja.doukaku.org/54/nested/" title="2:08:09 Jun 11, 2010" style="background-color:transparent;border:none;"><img src="/static/images/toolbar/wm_tb_prv_on.png" alt="Previous capture" width="14" height="16" border="0" /></a>
		                
               </td>
               <td id="displayDayEl" style="background:#000;color:#ff0;width:34px;height:24px;padding:2px 0 0 0;text-align:center;font-size:24px;font-weight: bold;" title="You are here: 16:19:04 Aug 21, 2010">21</td>
				<td style="padding-left:9px;white-space:nowrap;overflow:visible;text-align:left!important;vertical-align:middle!important;" nowrap="nowrap">
               
                       <img src="/static/images/toolbar/wm_tb_nxt_off.png" alt="Next capture" width="14" height="16" border="0"/>
                       
			    </td>
           </tr>

           <!-- NEXT/PREV YEAR NAV AND YEAR INDICATOR -->
           <tr style="width:110px;height:13px;font-size:9px!important;">
				<td style="padding-right:9px;font-size:11px!important;font-weight: bold;text-align:right;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
		                <a href="/web/20090810152630/http://ja.doukaku.org/54/nested/" style="text-decoration:none;color:#33f;font-weight:bold;background-color:transparent;border:none;" title="10 Aug 2009"><strong>2009</strong></a>
		                
               </td>
               <td id="displayYearEl" style="background:#000;color:#ff0;font-size:11px!important;font-weight: bold;padding-top:1px;width:34px;height:13px;text-align:center;" title="You are here: 16:19:04 Aug 21, 2010">2010</td>
				<td style="padding-left:9px;font-size:11px!important;font-weight: bold;white-space:nowrap;overflow:visible;" nowrap="nowrap">
               
                       2011
                       
				</td>
           </tr>
           </tbody></table>
       </td>

       </tr>
       <tr>
       <td style="vertical-align:middle;padding:0!important;">
           <a href="/web/20100821161904*/http://ja.doukaku.org/54/nested/" style="color:#33f;font-size:11px;font-weight:bold;background-color:transparent;border:none;" title="See a list of every capture for this URL"><strong>12 captures</strong></a>
           <div class="__wb_banner_div" style="margin:0!important;padding:0!important;color:#666;font-size:9px;padding-top:2px!important;white-space:nowrap;" title="Timespan for captures of this URL">13 May 07 - 21 Aug 10</div>
       </td>
       <td style="padding:0!important;">
       <a style="position:relative; white-space:nowrap; width:450px;height:27px;" href="" id="wm-graph-anchor">
       <div class="__wb_banner_div" id="wm-ipp-sparkline" style="position:relative; white-space:nowrap; width:450px;height:27px;background-color:#fff;cursor:pointer;border-right:1px solid #ccc;" title="Explore captures for this URL">
			<img id="sparklineImgId" style="position:absolute; z-index:9012; top:0px; left:0px;"
				onmouseover="showTrackers('inline');" 
				onmouseout="showTrackers('none');"
				onmousemove="trackMouseMove(event,this)"
				alt="sparklines"
				width="450"
				height="27"
				border="0"
				src="/web/jsp/graph.jsp?graphdata=450_27_1996:-1:000000000000_1997:-1:000000000000_1998:-1:000000000000_1999:-1:000000000000_2000:-1:000000000000_2001:-1:000000000000_2002:-1:000000000000_2003:-1:000000000000_2004:-1:000000000000_2005:-1:000000000000_2006:-1:000000000000_2007:-1:000010000000_2008:-1:010100000101_2009:-1:000000022000_2010:7:000002010000_2011:-1:000000000000_2012:-1:000000000000_2013:-1:000000000000"></img>
			<img id="wbMouseTrackYearImg" 
				style="display:none; position:absolute; z-index:9010;"
				width="25" 
				height="27"
				border="0"
				src="/static/images/toolbar/transp-yellow-pixel.png"></img>
			<img id="wbMouseTrackMonthImg"
				style="display:none; position:absolute; z-index:9011; " 
				width="2"
				height="27" 
				border="0"
				src="/static/images/toolbar/transp-red-pixel.png"></img>
       </div>
		</a>

       </td>
       </tr></tbody></table>
   </td>
   <td style="text-align:right;padding:5px;width:65px;font-size:11px!important;">
       <a href="javascript:;" onclick="document.getElementById('wm-ipp').style.display='none';" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_close.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;margin-bottom:23px;background-color:transparent;border:none;" title="Close the toolbar">Close</a>
       <a href="http://faq.web.archive.org/" style="display:block;padding-right:18px;background:url(/static/images/toolbar/wm_tb_help.png) no-repeat 100% 0;color:#33f;font-family:'Lucida Grande','Arial',sans-serif;background-color:transparent;border:none;" title="Get some help using the Wayback Machine">Help</a>
   </td>
   </tr></tbody></table>

</div>
</div>
<script type="text/javascript">
 var wmDisclaimBanner = document.getElementById("wm-ipp");
 if(wmDisclaimBanner != null) {
   disclaimElement(wmDisclaimBanner);
 }
</script>
<!-- END WAYBACK TOOLBAR INSERT -->


<div id="page_head" class="compact">
  <h1 class="compact">
    <a href="/web/20100821161904/http://ja.doukaku.org/">どう書く？org</a><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/beta.png" alt="beta">
  </h1>
</div>

<div id="page_body" class="compact">
<div id="content" class="compact">




<h2 class="compact">
<img src='/web/20100821161904im_/http://ja.doukaku.org/static/image/star_gold.png' alt=challenge>
<a href="/web/20100821161904/http://ja.doukaku.org/54/">一部のHTMLタグを通すフィルタ</a>
</h2>

    




<div class="comment" id="comment3410"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/1/" target="_top">にしお</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/3410/">#3410</a>(<script language="JavaScript">print_time(new Date("2007/08/30 23:31 GMT"));</script><noscript>2007/08/30 23:31 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #efffef;">1/1=1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  ユーザが入力した文字列から、一部のタグだけを許可して他をエスケープするコードを書いてください。要件は次のようになります。
<ul>
<li>通すタグはAとBRとSTRONGのみ。大文字小文字は区別しない。
<li>それ以外のタグとして意味を持ちうる文字列は&lt;を&amp;lt;に変換することで無効化する(削除するのではない。&gt;は変換してもしなくてもよい)
<li>Aタグのhrefとname以外の属性は削除する。BRやSTRONGの属性はすべて削除する。
</ul>

<p>
このお題はperezvonさんの提案を元にしています。ありがとうございました。
ただ、いきなりだと難しいかと思ったので、肝の部分以外を先に出題しました。このお題は続編で徐々に難しくなっていきます。

<p>
<pre>
追記：属性に&lt;や&gt;が含まれてしまうケースに漏れのある解答が多いようなのでテストケースを追加します。
これは「この出力なら十分」という意味です。この出力の通りでなければいけないという意味ではありません。

&lt;script foo="&lt;script&gt;alert('bar')&lt;/script&gt;"&gt;alert('foo')&lt;/script&gt;
&amp;lt;script foo="&amp;lt;script&amp;gt;alert('bar')&amp;lt;/script&amp;gt;"&amp;gt;alert('foo')&amp;lt;/script&amp;gt;


&lt;script foo="&lt;a href='link'&gt;link&lt;/a&gt;"&gt;alert('foo')&lt;/script&gt;
&amp;lt;script foo="&amp;lt;a href='link'&amp;gt;link&amp;lt;/a&amp;gt;"&amp;gt;alert('foo')&amp;lt;/script&amp;gt;

&lt;a href='www.g&gt;oogle.com'&gt;link&lt;/a&gt;

&lt;a href="./www.g%3Eoogle.com"&gt;link&lt;/a&gt;
</pre>
	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/3410/addtag/" class="addtag" id="addtag_3410">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #efffef;"
  >1/1=1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_3410"
  >-</span><span
  class="button yellow"
  id="rating_z_3410"
  >0</span><span 
  class="button green"
  id="rating_p_3410"
  >+</span></span></span>
  
<p>

  

  

  [<a href="/web/20100821161904/http://reply_to/3410/">
  返信
  </a>]
  </div>
</div>
</div>



  



<div class="indent">
<a href="/web/20100821161904/http://ja.doukaku.org/54/post_comment/">
コメントを投稿する
</a>
</div>


<h2>投稿されたコメント - ネスト表示</h2>
<a href="/web/20100821161904/http://ja.doukaku.org/54/flatten/">フラット表示</a> 
<a href="/web/20100821161904/http://ja.doukaku.org/54/">非表示</a> 


  

  

  

  
    




<div class="comment" id="comment3789"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/26/" target="_top">dankogai</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/3789/">#3789</a>(<script language="JavaScript">print_time(new Date("2007/11/10 01:05 GMT"));</script><noscript>2007/11/10 01:05 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/perl/">
	  Perl
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #efffef;">1/1=1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>HTML::Parserで割ときっちりと。
Dan the Perl Monger</pre>
	</div>
	
	<p class="link">
	  参考: <a href="/web/20100821161904/http://search.cpan.org/perldoc?HTML::Parser">HTML::Parser</a>
	</p>  
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46</pre></td><td class="code"><div class="highlight"><pre><span class="c1">#!/usr/local/bin/perl</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">HTML::</span><span class="n">Parser</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">HTML::</span><span class="n">Entities</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">parse</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$str</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@parsed</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$p</span> <span class="o">=</span> <span class="nn">HTML::</span><span class="n">Parser</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
        <span class="n">start_h</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="k">sub </span><span class="p">{</span>
                <span class="k">my</span> <span class="p">(</span> <span class="nv">$t</span><span class="p">,</span> <span class="nv">$a</span><span class="p">,</span> <span class="nv">$text</span> <span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$t</span> <span class="ow">eq</span> <span class="s">&#39;a&#39;</span><span class="p">){</span>
                    <span class="k">my</span> <span class="nv">@a</span> <span class="o">=</span>
                        <span class="nb">map</span> <span class="p">{</span> <span class="n">qq</span><span class="sr">/$_=&quot;/</span> <span class="o">.</span> <span class="n">encode_entities</span><span class="p">(</span><span class="nv">$a</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$_</span><span class="p">})</span> <span class="o">.</span> <span class="n">qq</span><span class="sr">/&quot;/</span> <span class="p">}</span>
                            <span class="nb">grep</span> <span class="sr">/^name|href$/</span><span class="p">,</span> <span class="nb">keys</span> <span class="nv">%$a</span><span class="p">;</span>
                    <span class="nb">push</span> <span class="nv">@parsed</span><span class="p">,</span> <span class="s">&quot;&lt;a &quot;</span><span class="o">.</span><span class="nb">join</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="nv">@a</span><span class="p">)</span><span class="o">.</span> <span class="s">&quot;&gt;&quot;</span>
                <span class="p">}</span><span class="k">elsif</span><span class="p">(</span><span class="nv">$t</span> <span class="ow">eq</span> <span class="s">&#39;br&#39;</span> <span class="o">||</span> <span class="nv">$t</span> <span class="ow">eq</span> <span class="s">&#39;strong&#39;</span><span class="p">){</span>
                    <span class="nb">push</span> <span class="nv">@parsed</span><span class="p">,</span> <span class="s">&quot;&lt;$t&gt;&quot;</span>
                <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                    <span class="nb">push</span> <span class="nv">@parsed</span><span class="p">,</span> <span class="n">encode_entities</span><span class="p">(</span><span class="nv">$text</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">},</span> <span class="s">&quot;tagname, attr, text&quot;</span>
        <span class="p">],</span>
        <span class="n">end_h</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="k">sub </span><span class="p">{</span>
                <span class="k">my</span> <span class="nv">$t</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
                <span class="nb">push</span> <span class="nv">@parsed</span><span class="p">,</span> <span class="nv">$t</span> <span class="o">=~</span><span class="sr"> /^a|br|strong$/</span> <span class="p">?</span> <span class="s">&quot;&lt;/$t&gt;&quot;</span> <span class="p">:</span> <span class="s">&quot;&amp;lt&#39;/$t&amp;gt;&quot;</span><span class="p">;</span>
            <span class="p">},</span> <span class="s">&quot;tagname&quot;</span>
        <span class="p">],</span>
        <span class="n">text_h</span> <span class="o">=&gt;</span> <span class="p">[</span>
            <span class="k">sub </span><span class="p">{</span>
                <span class="k">my</span> <span class="nv">$t</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
                <span class="nv">$t</span> <span class="o">=~</span> <span class="n">s</span><span class="p">{</span><span class="o">\</span><span class="n">n</span><span class="p">}{</span><span class="o">&lt;/</span><span class="n">br</span><span class="o">&gt;</span><span class="p">}</span><span class="n">g</span><span class="p">;</span>
                <span class="nb">push</span> <span class="nv">@parsed</span><span class="p">,</span> <span class="nv">$t</span><span class="p">;</span>
            <span class="p">},</span> <span class="s">&quot;text&quot;</span>
        <span class="p">]</span>
    <span class="p">)</span><span class="o">-&gt;</span><span class="n">parse</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span>
    <span class="nb">join</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="nv">@parsed</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1"># for test</span>
<span class="nb">local</span> <span class="vg">$/</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$str</span> <span class="o">=</span> <span class="o">&lt;&gt;</span><span class="p">;</span>
<span class="k">print</span> <span class="n">parse</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/3789/addtag/" class="addtag" id="addtag_3789">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/perl/">
		Perl
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/3789/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/3789/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #efffef;"
  >1/1=1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_3789"
  >-</span><span
  class="button yellow"
  id="rating_z_3789"
  >0</span><span 
  class="button green"
  id="rating_p_3789"
  >+</span></span></span>
  
<p>

  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/3789/">
  返信
  </a>]
  </div>
</div>
</div>



  


  

  

  
    




<div class="comment" id="comment2911"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/164/" target="_top">kozima</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2911/">#2911</a>(<script language="JavaScript">print_time(new Date("2007/09/05 03:05 GMT"));</script><noscript>2007/09/05 03:05 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/ocaml/">
	  OCaml
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>ocamllex で。
こんなに長くなるとは思わなかった。</pre>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120</pre></td><td class="code"><div class="highlight"><pre><span class="k">{</span>
<span class="kr">type</span> <span class="n">attributes</span> <span class="k">=</span> <span class="k">(</span><span class="n">string</span> <span class="k">*</span> <span class="n">string</span><span class="k">)</span> <span class="n">list</span> <span class="c">(* name, value *)</span>
<span class="kr">type</span> <span class="n">input</span> <span class="k">=</span>
    <span class="k">|</span> <span class="n">String</span> <span class="kr">of</span> <span class="n">string</span>
    <span class="k">|</span> <span class="n">SingleTag</span> <span class="kr">of</span> <span class="n">string</span> <span class="k">*</span> <span class="n">attributes</span> <span class="k">*</span> <span class="n">int</span> <span class="k">*</span> <span class="n">int</span>
    <span class="k">|</span> <span class="n">OpenTag</span> <span class="kr">of</span> <span class="n">string</span> <span class="k">*</span> <span class="n">attributes</span> <span class="k">*</span> <span class="n">int</span> <span class="k">*</span> <span class="n">int</span>
    <span class="k">|</span> <span class="n">CloseTag</span> <span class="kr">of</span> <span class="n">string</span> <span class="k">*</span> <span class="n">int</span> <span class="k">*</span> <span class="n">int</span>
    <span class="k">|</span> <span class="n">Eof</span>
<span class="k">}</span>

<span class="kr">let</span> <span class="n">tag_start</span> <span class="k">=</span> <span class="s2">&quot;&lt;&quot;</span>
<span class="kr">let</span> <span class="n">close_tag_start</span> <span class="k">=</span> <span class="s2">&quot;&lt;/&quot;</span>
<span class="kr">let</span> <span class="n">tag_end</span> <span class="k">=</span> <span class="s2">&quot;&gt;&quot;</span>
<span class="kr">let</span> <span class="n">single_tag_end</span> <span class="k">=</span> <span class="s2">&quot;/&gt;&quot;</span>
<span class="kr">let</span> <span class="n">tag_constituent</span> <span class="k">=</span> <span class="k">[</span><span class="sc">&#39;a&#39;</span> <span class="k">-</span> <span class="sc">&#39;z&#39;</span> <span class="sc">&#39;A&#39;</span> <span class="k">-</span> <span class="sc">&#39;Z&#39;</span><span class="k">]</span>
<span class="kr">let</span> <span class="n">attr_constituent</span> <span class="k">=</span> <span class="k">[</span><span class="sc">&#39;a&#39;</span> <span class="k">-</span> <span class="sc">&#39;z&#39;</span> <span class="sc">&#39;A&#39;</span> <span class="k">-</span> <span class="sc">&#39;Z&#39;</span> <span class="sc">&#39;-&#39;</span><span class="k">]</span>
<span class="kr">let</span> <span class="n">white</span> <span class="k">=</span> <span class="k">[</span><span class="sc">&#39; &#39;</span> <span class="sc">&#39;\t&#39;</span> <span class="sc">&#39;\n&#39;</span> <span class="sc">&#39;\r&#39;</span><span class="k">]</span>
<span class="kr">let</span> <span class="n">quote_omittable</span> <span class="k">=</span> <span class="k">[</span><span class="sc">&#39;a&#39;</span> <span class="k">-</span> <span class="sc">&#39;z&#39;</span> <span class="sc">&#39;A&#39;</span> <span class="k">-</span> <span class="sc">&#39;Z&#39;</span> <span class="sc">&#39;0&#39;</span> <span class="k">-</span> <span class="sc">&#39;9&#39;</span> <span class="sc">&#39;.&#39;</span> <span class="sc">&#39;-&#39;</span><span class="k">]</span>

<span class="n">rule</span> <span class="n">main</span> <span class="k">=</span> <span class="n">parse</span>
  <span class="k">|</span> <span class="n">tag_start</span>           <span class="k">{</span> <span class="n">tag</span> <span class="k">(</span><span class="n">Lexing</span><span class="k">.</span><span class="n">lexeme_start</span> <span class="n">lexbuf</span><span class="k">)</span> <span class="n">lexbuf</span> <span class="k">}</span>
  <span class="k">|</span> <span class="n">close_tag_start</span>     <span class="k">{</span> <span class="n">close_tag</span> <span class="k">(</span><span class="n">Lexing</span><span class="k">.</span><span class="n">lexeme_start</span> <span class="n">lexbuf</span><span class="k">)</span> <span class="n">lexbuf</span> <span class="k">}</span>
  <span class="k">|</span> <span class="k">[</span><span class="o">^</span><span class="sc">&#39;&lt;&#39;</span><span class="k">]+</span> <span class="kr">as</span> <span class="n">s</span>        <span class="k">{</span> <span class="n">String</span> <span class="n">s</span> <span class="k">}</span>
  <span class="k">|</span> <span class="n">eof</span>                 <span class="k">{</span> <span class="n">Eof</span> <span class="k">}</span>
<span class="kr">and</span> <span class="n">tag</span> <span class="n">p</span> <span class="k">=</span> <span class="n">parse</span>
  <span class="k">|</span> <span class="n">tag_constituent</span><span class="k">+</span> <span class="kr">as</span> <span class="n">name</span>    <span class="k">{</span> <span class="n">attr_list</span> <span class="n">p</span> <span class="n">name</span> <span class="k">[]</span> <span class="n">lexbuf</span> <span class="k">}</span>
  <span class="k">|</span> <span class="k">(_#</span><span class="n">tag_constituent</span><span class="k">)+</span> <span class="kr">as</span> <span class="n">s</span>   <span class="k">{</span> <span class="n">String</span> <span class="k">(</span><span class="s2">&quot;&lt;&quot;</span><span class="o">^</span><span class="n">s</span><span class="k">)</span> <span class="k">}</span>
<span class="kr">and</span> <span class="n">attr_list</span> <span class="n">p</span> <span class="n">tagname</span> <span class="n">attrs</span> <span class="k">=</span> <span class="n">parse</span>
  <span class="k">|</span> <span class="n">white</span><span class="k">+</span>                      <span class="k">{</span> <span class="n">attr_list</span> <span class="n">p</span> <span class="n">tagname</span> <span class="n">attrs</span> <span class="n">lexbuf</span> <span class="k">}</span>
  <span class="k">|</span> <span class="k">(</span><span class="n">attr_constituent</span><span class="k">+</span> <span class="kr">as</span> <span class="n">name</span><span class="k">)</span> <span class="n">white</span><span class="k">*</span> <span class="sc">&#39;=&#39;</span> <span class="k">{</span>
      <span class="kr">let</span> <span class="n">value</span> <span class="k">=</span> <span class="n">attr_value</span> <span class="n">lexbuf</span> <span class="kr">in</span>
        <span class="n">attr_list</span> <span class="n">p</span> <span class="n">tagname</span> <span class="k">((</span><span class="n">name</span><span class="k">,</span> <span class="n">value</span><span class="k">)::</span><span class="n">attrs</span><span class="k">)</span> <span class="n">lexbuf</span>
    <span class="k">}</span>
  <span class="k">|</span> <span class="n">tag_end</span>             <span class="k">{</span>
      <span class="kr">let</span> <span class="n">endpos</span> <span class="k">=</span> <span class="n">Lexing</span><span class="k">.</span><span class="n">lexeme_end</span> <span class="n">lexbuf</span> <span class="kr">in</span>
        <span class="n">OpenTag</span><span class="k">(</span><span class="n">tagname</span><span class="k">,</span> <span class="n">List</span><span class="k">.</span><span class="n">rev</span> <span class="n">attrs</span><span class="k">,</span> <span class="n">p</span><span class="k">,</span> <span class="n">endpos</span><span class="k">)</span>
    <span class="k">}</span>
  <span class="k">|</span> <span class="n">single_tag_end</span>      <span class="k">{</span>
      <span class="kr">let</span> <span class="n">endpos</span> <span class="k">=</span> <span class="n">Lexing</span><span class="k">.</span><span class="n">lexeme_end</span> <span class="n">lexbuf</span> <span class="kr">in</span>
        <span class="n">SingleTag</span><span class="k">(</span><span class="n">tagname</span><span class="k">,</span> <span class="n">List</span><span class="k">.</span><span class="n">rev</span> <span class="n">attrs</span><span class="k">,</span> <span class="n">p</span><span class="k">,</span> <span class="n">endpos</span><span class="k">)</span>
    <span class="k">}</span>
  <span class="k">|</span> <span class="k">_</span>                   <span class="k">{</span> <span class="n">attr_list</span> <span class="n">p</span> <span class="n">tagname</span> <span class="n">attrs</span> <span class="n">lexbuf</span> <span class="k">}</span>
<span class="kr">and</span> <span class="n">attr_value</span> <span class="k">=</span> <span class="n">parse</span>
  <span class="k">|</span> <span class="n">white</span><span class="k">+</span>                      <span class="k">{</span> <span class="n">attr_value</span> <span class="n">lexbuf</span> <span class="k">}</span>
  <span class="k">|</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="k">([</span><span class="o">^</span><span class="sc">&#39;\&#39;&#39;</span><span class="k">]*</span> <span class="kr">as</span> <span class="n">value</span><span class="k">)</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="k">{</span> <span class="n">value</span> <span class="k">}</span>
  <span class="k">|</span> <span class="sc">&#39;&quot;&#39;</span> <span class="k">([</span><span class="o">^</span><span class="sc">&#39;&quot;&#39;</span><span class="k">]*</span> <span class="kr">as</span> <span class="n">value</span><span class="k">)</span> <span class="sc">&#39;&quot;&#39;</span>  <span class="k">{</span> <span class="n">value</span> <span class="k">}</span>
  <span class="k">|</span> <span class="k">(</span><span class="n">quote_omittable</span><span class="k">*</span> <span class="kr">as</span> <span class="n">value</span><span class="k">)</span> <span class="k">{</span> <span class="n">value</span> <span class="k">}</span>
  <span class="k">|</span> <span class="k">_</span>                           <span class="k">{</span> <span class="n">attr_value</span> <span class="n">lexbuf</span> <span class="k">}</span>
<span class="kr">and</span> <span class="n">close_tag</span> <span class="n">p</span> <span class="k">=</span> <span class="n">parse</span>
  <span class="k">|</span> <span class="k">(</span><span class="n">tag_constituent</span><span class="k">+</span> <span class="kr">as</span> <span class="n">name</span><span class="k">)</span> <span class="k">[</span><span class="o">^</span><span class="sc">&#39;&gt;&#39;</span><span class="k">]*</span> <span class="n">tag_end</span>  <span class="k">{</span>
      <span class="n">CloseTag</span> <span class="k">(</span><span class="n">name</span><span class="k">,</span> <span class="n">p</span><span class="k">,</span> <span class="n">Lexing</span><span class="k">.</span><span class="n">lexeme_start</span> <span class="n">lexbuf</span><span class="k">)</span>
    <span class="k">}</span>
  <span class="k">|</span> <span class="k">(_#</span><span class="n">tag_constituent</span><span class="k">)+</span> <span class="kr">as</span> <span class="n">text</span>                <span class="k">{</span>
      <span class="n">String</span> <span class="k">(</span><span class="s2">&quot;&lt;/&quot;</span><span class="o">^</span><span class="n">text</span><span class="k">)</span>
    <span class="k">}</span>

<span class="k">{</span>
<span class="kr">let</span> <span class="n">parse_input</span> <span class="n">s</span> <span class="k">=</span>
  <span class="kr">let</span> <span class="n">lexbuf</span> <span class="k">=</span> <span class="n">Lexing</span><span class="k">.</span><span class="n">from_string</span> <span class="n">s</span> <span class="kr">in</span>
  <span class="kr">let</span> <span class="kr">rec</span> <span class="n">loop</span> <span class="n">inputs</span> <span class="k">=</span>
    <span class="kr">match</span> <span class="n">main</span> <span class="n">lexbuf</span> <span class="kr">with</span>
      <span class="k">|</span> <span class="n">Eof</span> <span class="k">-&gt;</span> <span class="n">List</span><span class="k">.</span><span class="n">rev</span> <span class="n">inputs</span>
      <span class="k">|</span> <span class="n">x</span> <span class="k">-&gt;</span> <span class="n">loop</span> <span class="k">(</span><span class="n">x</span><span class="k">::</span><span class="n">inputs</span><span class="k">)</span>
  <span class="kr">in</span> <span class="n">loop</span> <span class="k">[]</span>

<span class="kr">let</span> <span class="k">(===)</span> <span class="n">s1</span> <span class="n">s2</span> <span class="k">=</span> <span class="n">String</span><span class="k">.</span><span class="n">uppercase</span> <span class="n">s1</span> <span class="k">=</span> <span class="n">String</span><span class="k">.</span><span class="n">uppercase</span> <span class="n">s2</span>

<span class="kr">let</span> <span class="n">is_allowed_tag</span> <span class="n">tagname</span> <span class="k">=</span>
  <span class="n">List</span><span class="k">.</span><span class="n">exists</span> <span class="k">(</span><span class="kr">fun</span> <span class="n">s</span> <span class="k">-&gt;</span> <span class="n">tagname</span> <span class="k">===</span> <span class="n">s</span><span class="k">)</span> <span class="k">[</span><span class="s2">&quot;a&quot;</span><span class="k">;</span> <span class="s2">&quot;br&quot;</span><span class="k">;</span> <span class="s2">&quot;strong&quot;</span><span class="k">]</span>

<span class="kr">let</span> <span class="n">is_allowed_attribute</span> <span class="n">tagname</span> <span class="n">attrname</span> <span class="k">=</span>
  <span class="c">(* めんどくさくなったので ad-hoc *)</span>
  <span class="n">tagname</span> <span class="k">===</span> <span class="s2">&quot;a&quot;</span> <span class="k">&amp;&amp;</span> <span class="k">(</span><span class="n">attrname</span> <span class="k">===</span> <span class="s2">&quot;href&quot;</span> <span class="k">||</span> <span class="n">attrname</span> <span class="k">===</span> <span class="s2">&quot;name&quot;</span><span class="k">)</span>

<span class="kr">let</span> <span class="n">sanitizing_output</span> <span class="n">buf</span> <span class="n">string</span> <span class="n">p</span> <span class="n">q</span> <span class="k">=</span>
  <span class="kr">for</span> <span class="n">x</span> <span class="k">=</span> <span class="n">p</span> <span class="kr">to</span> <span class="n">q</span><span class="k">-</span><span class="mi">1</span> <span class="kr">do</span>
    <span class="kr">match</span> <span class="n">string</span><span class="k">.[</span><span class="n">x</span><span class="k">]</span> <span class="kr">with</span>
      <span class="k">|</span> <span class="sc">&#39;&lt;&#39;</span> <span class="k">-&gt;</span> <span class="n">Buffer</span><span class="k">.</span><span class="n">add_string</span> <span class="n">buf</span> <span class="s2">&quot;&amp;lt;&quot;</span>
      <span class="k">|</span> <span class="sc">&#39;&gt;&#39;</span> <span class="k">-&gt;</span> <span class="n">Buffer</span><span class="k">.</span><span class="n">add_string</span> <span class="n">buf</span> <span class="s2">&quot;&amp;gt;&quot;</span>
      <span class="k">|</span> <span class="sc">&#39;&amp;&#39;</span> <span class="k">-&gt;</span> <span class="n">Buffer</span><span class="k">.</span><span class="n">add_string</span> <span class="n">buf</span> <span class="s2">&quot;&amp;amp;&quot;</span>
      <span class="k">|</span> <span class="n">c</span> <span class="k">-&gt;</span> <span class="n">Buffer</span><span class="k">.</span><span class="n">add_char</span> <span class="n">buf</span> <span class="n">c</span>
  <span class="kr">done</span>

<span class="kr">let</span> <span class="n">output_attribute_if_allowed</span> <span class="n">buf</span> <span class="n">tagname</span> <span class="k">(</span><span class="n">attrname</span><span class="k">,</span> <span class="n">value</span><span class="k">)</span> <span class="k">=</span>
  <span class="kr">if</span> <span class="n">is_allowed_attribute</span> <span class="n">tagname</span> <span class="n">attrname</span> <span class="kr">then</span>
    <span class="kr">let</span> <span class="n">quote</span> <span class="k">=</span> <span class="kr">if</span> <span class="n">String</span><span class="k">.</span><span class="n">contains</span> <span class="n">value</span> <span class="sc">&#39;&quot;&#39;</span> <span class="kr">then</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="kr">else</span> <span class="sc">&#39;&quot;&#39;</span> <span class="kr">in</span>
      <span class="n">Printf</span><span class="k">.</span><span class="n">bprintf</span> <span class="n">buf</span> <span class="s2">&quot; %s=%c%s%c&quot;</span> <span class="n">attrname</span> <span class="n">quote</span> <span class="n">value</span> <span class="n">quote</span>

<span class="kr">let</span> <span class="n">output_tag</span> <span class="n">buf</span> <span class="n">name</span> <span class="n">attrs</span> <span class="n">is_single</span> <span class="k">=</span>
  <span class="n">Printf</span><span class="k">.</span><span class="n">bprintf</span> <span class="n">buf</span> <span class="s2">&quot;&lt;%s&quot;</span> <span class="n">name</span><span class="k">;</span>
  <span class="n">List</span><span class="k">.</span><span class="n">iter</span> <span class="k">(</span><span class="n">output_attribute_if_allowed</span> <span class="n">buf</span> <span class="n">name</span><span class="k">)</span> <span class="n">attrs</span><span class="k">;</span>
  <span class="kr">if</span> <span class="n">is_single</span> <span class="kr">then</span> <span class="n">Buffer</span><span class="k">.</span><span class="n">add_char</span> <span class="n">buf</span> <span class="sc">&#39;/&#39;</span><span class="k">;</span>
  <span class="n">Buffer</span><span class="k">.</span><span class="n">add_char</span> <span class="n">buf</span> <span class="sc">&#39;&gt;&#39;</span>

<span class="kr">let</span> <span class="n">output_text_fragment</span> <span class="n">buf</span> <span class="n">src</span> <span class="k">=</span> <span class="kr">function</span>
  <span class="k">|</span> <span class="n">String</span> <span class="n">s</span> <span class="k">-&gt;</span>
      <span class="n">sanitizing_output</span> <span class="n">buf</span> <span class="n">s</span> <span class="mi">0</span> <span class="k">(</span><span class="n">String</span><span class="k">.</span><span class="n">length</span> <span class="n">s</span><span class="k">)</span>
  <span class="k">|</span> <span class="n">SingleTag</span> <span class="k">(</span><span class="n">s</span><span class="k">,</span> <span class="n">attrs</span><span class="k">,</span> <span class="n">p</span><span class="k">,</span> <span class="n">q</span><span class="k">)</span> <span class="k">-&gt;</span>
      <span class="kr">if</span> <span class="n">is_allowed_tag</span> <span class="n">s</span> <span class="kr">then</span>
        <span class="n">output_tag</span> <span class="n">buf</span> <span class="n">s</span> <span class="n">attrs</span> <span class="kr">true</span>
      <span class="kr">else</span>
        <span class="n">sanitizing_output</span> <span class="n">buf</span> <span class="n">src</span> <span class="n">p</span> <span class="n">q</span>
  <span class="k">|</span> <span class="n">OpenTag</span> <span class="k">(</span><span class="n">s</span><span class="k">,</span> <span class="n">attrs</span><span class="k">,</span> <span class="n">p</span><span class="k">,</span> <span class="n">q</span><span class="k">)</span> <span class="k">-&gt;</span>
      <span class="kr">if</span> <span class="n">is_allowed_tag</span> <span class="n">s</span> <span class="kr">then</span>
        <span class="n">output_tag</span> <span class="n">buf</span> <span class="n">s</span> <span class="n">attrs</span> <span class="kr">false</span>
      <span class="kr">else</span>
        <span class="n">sanitizing_output</span> <span class="n">buf</span> <span class="n">src</span> <span class="n">p</span> <span class="n">q</span>
  <span class="k">|</span> <span class="n">CloseTag</span> <span class="k">(</span><span class="n">s</span><span class="k">,</span> <span class="n">p</span><span class="k">,</span> <span class="n">q</span><span class="k">)</span> <span class="k">-&gt;</span>
      <span class="kr">if</span> <span class="n">is_allowed_tag</span> <span class="n">s</span> <span class="kr">then</span>
        <span class="n">Printf</span><span class="k">.</span><span class="n">bprintf</span> <span class="n">buf</span> <span class="s2">&quot;&lt;/%s&gt;&quot;</span> <span class="n">s</span>
      <span class="kr">else</span>
        <span class="n">sanitizing_output</span> <span class="n">buf</span> <span class="n">src</span> <span class="n">p</span> <span class="n">q</span>
  <span class="k">|</span> <span class="n">Eof</span> <span class="k">-&gt;</span> <span class="k">()</span>

<span class="kr">let</span> <span class="n">filter_text</span> <span class="n">text</span> <span class="k">=</span>
  <span class="kr">let</span> <span class="n">list</span> <span class="k">=</span> <span class="n">parse_input</span> <span class="n">text</span> <span class="kr">in</span>
  <span class="kr">let</span> <span class="n">buf</span> <span class="k">=</span> <span class="n">Buffer</span><span class="k">.</span><span class="n">create</span> <span class="k">(</span><span class="n">String</span><span class="k">.</span><span class="n">length</span> <span class="n">text</span><span class="k">)</span> <span class="kr">in</span>
    <span class="n">List</span><span class="k">.</span><span class="n">iter</span> <span class="k">(</span><span class="n">output_text_fragment</span> <span class="n">buf</span> <span class="n">text</span><span class="k">)</span> <span class="n">list</span><span class="k">;</span>
    <span class="n">Buffer</span><span class="k">.</span><span class="n">contents</span> <span class="n">buf</span>
<span class="k">}</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2911/addtag/" class="addtag" id="addtag_2911">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/ocaml/">
		OCaml
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2911/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2911/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2911"
  >-</span><span
  class="button yellow"
  id="rating_z_2911"
  >0</span><span 
  class="button green"
  id="rating_p_2911"
  >+</span></span></span>
  
<p>

  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2911/">
  返信
  </a>]
  </div>
</div>
</div>



  


  

  
    




<div class="comment" id="comment6746"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/840/" target="_top">leque</a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/6746/">#6746</a>(<script language="JavaScript">print_time(new Date("2008/07/16 04:36 GMT"));</script><noscript>2008/07/16 04:36 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/scheme/">
	  Scheme
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <p>Gauche で書いてみました。まず、 HTML を HtmlPrag を使って SXML 形式に変換し、その上で属性のフィルタリングをします。タグの &lt; や &gt; を &amp;lt;、 &amp;gt; に変換するのは正規表現を使っています。ひとつのタグが複数行に分けて書かれている場合には対応していません。</p>

	</div>
	
	<p class="link">
	  参考: <a href="/web/20100821161904/http://www.neilvandyke.org/htmlprag/">HtmlPrag</a>
	</p>  
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></td><td class="code"><div class="highlight"><pre><span class="p">(</span><span class="nb">load </span><span class="s">&quot;htmlprag&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nf">use</span> <span class="nv">util</span><span class="o">.</span><span class="nv">list</span><span class="p">)</span>
<span class="p">(</span><span class="nf">use</span> <span class="nv">sxml</span><span class="o">.</span><span class="nv">serializer</span><span class="p">)</span>
<span class="p">(</span><span class="nf">use</span> <span class="nv">sxml</span><span class="o">.</span><span class="nv">sxpath</span><span class="p">)</span>
<span class="p">(</span><span class="nf">use</span> <span class="nv">sxml</span><span class="o">.</span><span class="nv">tools</span><span class="p">)</span>
<span class="p">(</span><span class="nf">use</span> <span class="nv">sxml</span><span class="o">.</span><span class="nv">tree-trans</span><span class="p">)</span>

<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">filter-html</span> <span class="nv">shtml</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">pre-post-order</span> <span class="nv">shtml</span>
    <span class="o">`</span><span class="p">((</span><span class="nf">*default*</span> <span class="o">.</span> <span class="o">,</span><span class="p">(</span><span class="k">lambda </span><span class="nv">c</span> <span class="nv">c</span><span class="p">))</span>
      <span class="p">(</span><span class="nf">*text*</span> <span class="o">.</span> <span class="o">,</span><span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">_</span> <span class="nv">c</span><span class="p">)</span> <span class="nv">c</span><span class="p">))</span>
      <span class="p">(</span><span class="nf">br</span> <span class="o">.</span> <span class="o">,</span><span class="p">(</span><span class="k">lambda </span><span class="nv">br</span>
               <span class="p">(</span><span class="nf">sxml:change-attrlist!</span> <span class="nv">br</span> <span class="o">&#39;</span><span class="p">())</span>
               <span class="nv">br</span><span class="p">))</span>
      <span class="p">(</span><span class="nf">strong</span> <span class="o">.</span> <span class="o">,</span><span class="p">(</span><span class="k">lambda </span><span class="nv">strong</span>
                   <span class="p">(</span><span class="nf">sxml:change-attrlist!</span> <span class="nv">strong</span> <span class="o">&#39;</span><span class="p">())</span>
                   <span class="nv">strong</span><span class="p">))</span>
      <span class="p">(</span><span class="nf">a</span> <span class="o">.</span> <span class="o">,</span><span class="p">(</span><span class="k">lambda </span><span class="nv">a</span>
              <span class="p">(</span><span class="nf">sxml:change-attrlist!</span> <span class="nv">a</span>
                                     <span class="p">(</span><span class="nf">cond-list</span>
                                      <span class="p">(((</span><span class="nf">if-car-sxpath</span> <span class="s">&quot;./@href&quot;</span><span class="p">)</span> <span class="nv">a</span><span class="p">)</span> <span class="k">=&gt; </span><span class="nv">values</span><span class="p">)</span>
                                      <span class="p">(((</span><span class="nf">if-car-sxpath</span> <span class="s">&quot;./@name&quot;</span><span class="p">)</span> <span class="nv">a</span><span class="p">)</span> <span class="k">=&gt; </span><span class="nv">values</span><span class="p">)))</span>
              <span class="nv">a</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">main</span> <span class="nv">args</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">display</span>
   <span class="p">(</span><span class="nb">call-with-input-file </span><span class="p">(</span><span class="nb">cadr </span><span class="nv">args</span><span class="p">)</span>
     <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">iport</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">regexp-replace-all</span>
        <span class="o">#</span><span class="nv">/&lt;</span><span class="p">((</span><span class="nf">?!</span><span class="err">\</span><span class="nv">/?a</span><span class="err">\</span><span class="nv">b</span><span class="err">|\</span><span class="nv">/?br</span><span class="err">\</span><span class="nv">b</span><span class="err">|\</span><span class="nv">/?strong</span><span class="err">\</span><span class="nv">b</span><span class="err">|</span><span class="nv">!--</span><span class="p">)</span><span class="err">[</span><span class="nv">^&gt;</span><span class="err">]</span><span class="nv">*</span><span class="p">(</span><span class="nf">?!--</span><span class="p">))</span><span class="nv">&gt;/</span>
        <span class="p">(</span><span class="nf">srl:sxml-&gt;xml</span> <span class="p">(</span><span class="nf">filter-html</span> <span class="p">(</span><span class="nf">html-&gt;sxml</span> <span class="nv">iport</span><span class="p">)))</span>
        <span class="s">&quot;&amp;lt;\\1&amp;gt;&quot;</span><span class="p">)))))</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/6746/addtag/" class="addtag" id="addtag_6746">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/scheme/">
		Scheme
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/6746/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/6746/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_6746"
  >-</span><span
  class="button yellow"
  id="rating_z_6746"
  >0</span><span 
  class="button green"
  id="rating_p_6746"
  >+</span></span></span>
  
<p>

  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/6746/">
  返信
  </a>]
  </div>
</div>
</div>



  


  

  

  

  

  
    




<div class="comment" id="comment2717"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/105/" target="_top">rubikitch</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2717/">#2717</a>(<script language="JavaScript">print_time(new Date("2007/08/31 04:02 GMT"));</script><noscript>2007/08/31 04:02 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/ruby/">
	  Ruby
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffefcf;">-1/3=-0.33</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  CGI.escapeElementが使えるかなと思ったが微妙に要求が異なる
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
  <span class="n">html</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">%r!&lt;((/?)([a-z]+)[^&gt;/]*(/?)&gt;)!i</span><span class="p">){</span>
    <span class="n">rest</span><span class="p">,</span> <span class="n">endtagp</span><span class="p">,</span> <span class="n">tagname</span><span class="p">,</span> <span class="n">slash</span> <span class="o">=</span> <span class="no">Regexp</span><span class="o">.</span><span class="n">last_match</span><span class="o">.</span><span class="n">captures</span>
    <span class="k">case</span> <span class="n">tagname</span>
    <span class="k">when</span> <span class="s2">&quot;br&quot;</span><span class="p">,</span> <span class="s2">&quot;BR&quot;</span><span class="p">,</span> <span class="s2">&quot;strong&quot;</span><span class="p">,</span> <span class="s2">&quot;STRONG&quot;</span>
      <span class="s2">&quot;&lt;</span><span class="si">#{</span><span class="n">endtagp</span><span class="si">}#{</span><span class="n">tagname</span><span class="si">}#{</span><span class="n">slash</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
    <span class="k">when</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span>
      <span class="n">endtagp</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="s2">&quot;&lt;a </span><span class="si">#{</span><span class="vg">$&amp;</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/(?:href|name)=(?:&quot;.+?&quot;|&#39;.+?&#39;|[^ &gt;]+)/</span><span class="p">)</span><span class="o">.</span><span class="n">join</span> <span class="s1">&#39; &#39;</span><span class="si">}</span><span class="s2">&gt;&quot;</span> <span class="p">:</span> <span class="s1">&#39;&lt;/a&gt;&#39;</span>
    <span class="k">else</span>
      <span class="s2">&quot;&amp;lt;</span><span class="si">#{</span><span class="n">rest</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2717/addtag/" class="addtag" id="addtag_2717">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/ruby/">
		Ruby
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2717/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2717/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffefcf;"
  >-1/3=-0.33</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2717"
  >-</span><span
  class="button yellow"
  id="rating_z_2717"
  >0</span><span 
  class="button green"
  id="rating_p_2717"
  >+</span></span></span>
  
<p>

  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2717/">
    2
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2717/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2723"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/105/" target="_top">rubikitch</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2723/">#2723</a>(<script language="JavaScript">print_time(new Date("2007/08/31 05:42 GMT"));</script><noscript>2007/08/31 05:42 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/ruby/">
	  Ruby
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffefef;">-1/1=-1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>修正。</pre>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
  <span class="n">html</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">%r!&lt;((/?)([a-z]+)[^&gt;/]*(/?)&gt;)!i</span><span class="p">){</span>
    <span class="n">rest</span><span class="p">,</span> <span class="n">endslash</span><span class="p">,</span> <span class="n">tagname</span><span class="p">,</span> <span class="n">slash</span> <span class="o">=</span> <span class="no">Regexp</span><span class="o">.</span><span class="n">last_match</span><span class="o">.</span><span class="n">captures</span>
    <span class="k">case</span> <span class="n">tagname</span><span class="o">.</span><span class="n">downcase</span>
    <span class="k">when</span> <span class="s2">&quot;br&quot;</span><span class="p">,</span> <span class="s2">&quot;strong&quot;</span>
      <span class="s2">&quot;&lt;</span><span class="si">#{</span><span class="n">endslash</span><span class="si">}#{</span><span class="n">tagname</span><span class="si">}#{</span><span class="n">slash</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
    <span class="k">when</span> <span class="s2">&quot;a&quot;</span>
      <span class="n">endslash</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="s2">&quot;&lt;a </span><span class="si">#{</span><span class="vg">$&amp;</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/(?:href|name)=(?:&quot;.+?&quot;|&#39;.+?&#39;|[^ &gt;]+)/i</span><span class="p">)</span><span class="o">.</span><span class="n">join</span> <span class="s1">&#39; &#39;</span><span class="si">}</span><span class="s2">&gt;&quot;</span> <span class="p">:</span> <span class="s1">&#39;&lt;/a&gt;&#39;</span>
    <span class="k">else</span>
      <span class="s2">&quot;&amp;lt;</span><span class="si">#{</span><span class="n">rest</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2723/addtag/" class="addtag" id="addtag_2723">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/ruby/">
		Ruby
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2723/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2723/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffefef;"
  >-1/1=-1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2723"
  >-</span><span
  class="button yellow"
  id="rating_z_2723"
  >0</span><span 
  class="button green"
  id="rating_p_2723"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2717/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2723/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2723/">
  返信
  </a>]
  </div>
</div>
</div>



  


    </div>
  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2721"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/82/" target="_top">yuin</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2721/">#2721</a>(<script language="JavaScript">print_time(new Date("2007/08/31 05:20 GMT"));</script><noscript>2007/08/31 05:20 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #dfffdf;">2/2=1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  タグに大文字小文字が混在している場合や、属性が大文字の場合が考慮されていないのでは？少なくともtagnameはdowncaseしてから比較したほうがよい気がします。
	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2721/addtag/" class="addtag" id="addtag_2721">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #dfffdf;"
  >2/2=1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2721"
  >-</span><span
  class="button yellow"
  id="rating_z_2721"
  >0</span><span 
  class="button green"
  id="rating_p_2721"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2717/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2721/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2721/">
  返信
  </a>]
  </div>
</div>
</div>



  


    </div>
  


  

  

  

  
    




<div class="comment" id="comment2925"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/31/" target="_top">smeghead</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2925/">#2925</a>(<script language="JavaScript">print_time(new Date("2007/09/06 09:11 GMT"));</script><noscript>2007/09/06 09:11 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/commonlisp/">
	  Common Lisp
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  html-parseを使用しました。確認はclispで行ないました。<br/>HTMLの属性値の変換は、&lt;&nbsp;&gt;&nbsp;&amp;&nbsp;"&nbsp;のHTML&nbsp;escapeだけを行なってます。<br/><br/>(html-filter&nbsp;<br/>"&lt;a&nbsp;href=\"www.google.com\"&gt;link&lt;/a&gt;&nbsp;&lt;blink&gt;and&lt;/blink&gt;\n&lt;strong&nbsp;onClick='alert(\"NG\")'&gt;click&lt;br&gt;me!&lt;/strong&gt;")<br/>&nbsp;&nbsp;=&gt;&nbsp;"&lt;a&nbsp;href=\"www.google.com\"&gt;link&lt;/a&gt;&amp;lt;blink&amp;gt;and&amp;lt;/blink&amp;gt;\n&lt;strong&gt;click&lt;br/&gt;me!&lt;/strong&gt;"&nbsp;<br/>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95</pre></td><td class="code"><div class="highlight"><pre>(asdf:oos &#39;asdf:load-op :cl-html-parse)

(defconstant *enable-tags* &#39;((&quot;a&quot; &quot;href&quot; &quot;name&quot;)
                             (&quot;br&quot;)
                             (&quot;strong&quot;)))

(defun html-filter (html)
  (html-element-filter (html-parse:parse-html html)))

(defun html-element-filter (elements)
  (cond 
    ((stringp elements)
     (convert-not-tag elements))
    ((symbolp elements)
     (convert-tag elements nil))
    (t

      (let* ((element-type (cond ((and (listp (car elements))
                                       (symbolp (caar elements))
                                       (not (null (cadar elements)))
                                       (symbolp (cadar elements)))
                                  :tag-attr)
                                 ((symbolp (car elements)) :tag)
                                 (t :not-tag)))
             (tag (case element-type
                    (:tag-attr (caar elements))
                    (:tag      (car elements))))
             (attr-lst (if (equal element-type :tag-attr)
                         (cdar elements)))
             (elems (case element-type
                      (:tag-attr (cdr elements))
                      (:tag      (cdr elements))
                      (:not-tag  elements))))
        (case element-type
          (:tag-attr (convert-tag-attr tag attr-lst elems))
          (:tag      (convert-tag tag elems))
          (:not-tag  (string-join (mapcar #&#39;html-element-filter elems))))))))

(defun convert-tag (tag elems)
  (let* ((enable-tag (assoc (string-downcase tag) *enable-tags* :test #&#39;equal))
         (&lt; (if enable-tag &quot;&lt;&quot; &quot;&amp;lt;&quot;))
         (&gt; (if enable-tag &quot;&gt;&quot; &quot;&amp;gt;&quot;)))
    (cond ((null elems)
           (format nil &quot;~a~(~a~)/~a&quot; &lt; tag &gt;))
          (t
            (string-join
              (format nil &quot;~a~(~a~)~a&quot; &lt; tag &gt;)
              (html-element-filter elems)
              (format nil &quot;~a/~(~a~)~a&quot; &lt; tag &gt;))))))

(defun convert-tag-attr (tag attr-lst elems)
  (let* ((enable-tag (assoc (string-downcase tag) *enable-tags* :test #&#39;equal))
         (&lt; (if enable-tag &quot;&lt;&quot; &quot;&amp;lt;&quot;))
         (&gt; (if enable-tag &quot;&gt;&quot; &quot;&amp;gt;&quot;))
         (attr (loop for e in attr-lst by #&#39;cddr
                     when (or (null enable-tag)
                              (member (string-downcase e) (cdr enable-tag)
                                      :test #&#39;equal))
                     collect (format nil &quot;~(~a~)=\&quot;~a\&quot;&quot;
                                     e
                                     (escape-html (getf attr-lst e))))))
    (cond 
      (elems
        (string-join
          (if attr
            (format nil &quot;~a~(~a~) ~{~a~^, ~}~a&quot; &lt; tag attr &gt;)
            (format nil &quot;~a~(~a~)~a&quot; &lt; tag &gt;))
          (html-element-filter elems)
          (format nil &quot;~a/~(~a~)~a&quot; &lt; tag &gt;)))
      (t
        (if attr
          (format nil &quot;~a~(~a~) ~{~a~^, ~}/~a&quot; &lt; tag attr &gt;)
          (format nil &quot;~a~(~a~)/~a&quot; &lt; tag &gt;))))))

(defun convert-not-tag (element)
  (format nil &quot;~a&quot; (escape-html element)))

(defun string-join (&amp;rest lst)
  (let ((l (if (listp (car lst))
             (car lst)
             lst)))
    (apply #&#39;concatenate (cons &#39;string l))))

(defun escape-html (str)
  (let ((in (make-string-input-stream str))
        (out (make-string-output-stream)))
    (loop for c = (read-char in nil nil)
          while c
          do (case c
               (#\&lt; (write-string &quot;&amp;lt;&quot; out))
               (#\&gt; (write-string &quot;&amp;gt;&quot; out))
               (#\&amp; (write-string &quot;&amp;amp;&quot; out))
               (#\&quot; (write-string &quot;&amp;quot;&quot; out))
               (t (write-char c out)))
          finally (return (get-output-stream-string out)))))
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2925/addtag/" class="addtag" id="addtag_2925">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/commonlisp/">
		Common Lisp
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2925/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2925/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2925"
  >-</span><span
  class="button yellow"
  id="rating_z_2925"
  >0</span><span 
  class="button green"
  id="rating_p_2925"
  >+</span></span></span>
  
<p>

  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2925/">
  返信
  </a>]
  </div>
</div>
</div>



  


  

  
    




<div class="comment" id="comment2705"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/98/" target="_top">nobsun</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2705/">#2705</a>(<script language="JavaScript">print_time(new Date("2007/08/31 01:33 GMT"));</script><noscript>2007/08/31 01:33 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/haskell/">
	  Haskell
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #dfffdf;">2/2=1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>validityチェックなしの手抜きですが。。。
Tag Soup というライブラリを使う</pre>
	</div>
	
	<p class="link">
	  参考: <a href="/web/20100821161904/http://www.cs.york.ac.uk/fp/haddock/tagsoup/index.html">Tag Soup</a>
	</p>  
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre></td><td class="code"><div class="highlight"><pre><span class="kr">import</span> <span class="n">Data</span><span class="o">.</span><span class="n">Char</span>
<span class="kr">import</span> <span class="n">Text</span><span class="o">.</span><span class="n">HTML</span><span class="o">.</span><span class="n">TagSoup</span>

<span class="nv">proc</span> <span class="o">::</span> <span class="n">Tag</span> <span class="n">Char</span> <span class="o">-&gt;</span> <span class="n">Tag</span> <span class="n">Char</span>
<span class="nv">proc</span> <span class="nv">tag</span><span class="o">@</span><span class="p">(</span><span class="n">TagOpen</span> <span class="nv">t</span> <span class="nv">attrs</span><span class="p">)</span>
 <span class="o">|</span> <span class="nv">t&#39;</span> <span class="o">==</span> <span class="s">&quot;a&quot;</span>      <span class="o">=</span> <span class="n">TagOpen</span> <span class="nv">t</span> <span class="p">(</span><span class="nv">filter</span> <span class="nv">allowA</span> <span class="nv">attrs</span><span class="p">)</span>
 <span class="o">|</span> <span class="nv">t&#39;</span> <span class="o">==</span> <span class="s">&quot;br&quot;</span>     <span class="o">=</span> <span class="n">TagOpen</span> <span class="nv">t</span> <span class="p">[]</span>
 <span class="o">|</span> <span class="nv">t&#39;</span> <span class="o">==</span> <span class="s">&quot;strong&quot;</span> <span class="o">=</span> <span class="n">TagOpen</span> <span class="nv">t</span> <span class="p">[]</span>
 <span class="o">|</span> <span class="nv">otherwise</span>      <span class="o">=</span> <span class="nv">tag</span>
 <span class="kr">where</span> <span class="nv">t&#39;</span> <span class="o">=</span> <span class="nv">map</span> <span class="nv">toLower</span> <span class="nv">t</span>
<span class="nv">proc</span> <span class="nv">tag</span> <span class="o">=</span> <span class="nv">tag</span>

<span class="nv">allowA</span> <span class="p">(</span><span class="nv">a</span><span class="p">,</span><span class="kr">_</span><span class="p">)</span> <span class="o">=</span> <span class="nv">a</span> <span class="o">==</span> <span class="s">&quot;href&quot;</span> <span class="o">||</span> <span class="nv">a</span> <span class="o">==</span> <span class="s">&quot;name&quot;</span>

<span class="nv">pprTags</span> <span class="o">::</span> <span class="p">[</span><span class="n">Tag</span> <span class="n">Char</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">String</span>
<span class="nv">pprTags</span> <span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
<span class="nv">pprTags</span> <span class="nv">tags</span><span class="o">@</span><span class="p">(</span><span class="n">TagOpen</span> <span class="nv">s</span> <span class="nv">attrs</span> <span class="o">:</span> <span class="n">TagClose</span> <span class="nv">e</span> <span class="o">:</span> <span class="nv">ts</span><span class="p">)</span>
 <span class="o">|</span> <span class="nv">map</span> <span class="nv">toLower</span> <span class="nv">s</span> <span class="o">==</span> <span class="s">&quot;br&quot;</span> <span class="o">=</span> <span class="s">&quot;&lt;br/&gt;&quot;</span> <span class="o">++</span> <span class="nv">pprTags</span> <span class="nv">ts</span>
<span class="nv">pprTags</span> <span class="p">(</span><span class="nv">t</span><span class="o">:</span><span class="nv">ts</span><span class="p">)</span> <span class="o">=</span> <span class="nv">pprTag</span> <span class="nv">t</span> <span class="o">++</span> <span class="nv">pprTags</span> <span class="nv">ts</span>

<span class="nv">pprTag</span> <span class="o">::</span> <span class="n">Tag</span> <span class="n">Char</span> <span class="o">-&gt;</span> <span class="n">String</span>
<span class="nv">pprTag</span> <span class="nv">tag</span> <span class="o">=</span> <span class="kr">case</span> <span class="nv">tag</span> <span class="kr">of</span>
  <span class="n">TagOpen</span> <span class="nv">t</span> <span class="nv">attrs</span> <span class="o">|</span> <span class="nv">ignore</span> <span class="nv">t</span>  <span class="o">-&gt;</span> <span class="s">&quot;&amp;lt;&quot;</span><span class="o">++</span><span class="nv">pprOpen&#39;</span> <span class="nv">t</span> <span class="nv">attrs</span><span class="o">++</span><span class="s">&quot;&gt;&quot;</span>
                  <span class="o">|</span> <span class="nv">otherwise</span> <span class="o">-&gt;</span> <span class="nv">pprOpen</span> <span class="nv">t</span> <span class="nv">attrs</span>
  <span class="n">TagClose</span> <span class="nv">t</span>      <span class="o">|</span> <span class="nv">ignore</span> <span class="nv">t</span>  <span class="o">-&gt;</span> <span class="s">&quot;&amp;lt;&quot;</span><span class="o">++</span><span class="nv">pprClose&#39;</span> <span class="nv">t</span><span class="o">++</span><span class="s">&quot;&gt;&quot;</span>
                  <span class="o">|</span> <span class="nv">otherwise</span> <span class="o">-&gt;</span> <span class="nv">pprClose</span> <span class="nv">t</span>
  <span class="n">TagText</span> <span class="nv">s</span>                   <span class="o">-&gt;</span> <span class="nv">s</span>
  <span class="n">TagComment</span> <span class="nv">s</span>                <span class="o">-&gt;</span> <span class="s">&quot;&lt;!--&quot;</span><span class="o">++</span><span class="nv">s</span><span class="o">++</span><span class="s">&quot;--&gt;&quot;</span>
  <span class="n">TagSpecial</span> <span class="nv">s</span> <span class="nv">c</span>              <span class="o">-&gt;</span> <span class="s">&quot;&lt;!&quot;</span><span class="o">++</span><span class="nv">s</span><span class="o">++</span><span class="sc">&#39; &#39;</span><span class="o">:</span><span class="nv">c</span><span class="o">++</span><span class="s">&quot;&gt;&quot;</span>
  <span class="n">TagWarning</span> <span class="nv">s</span>                <span class="o">-&gt;</span> <span class="s">&quot;&quot;</span>

<span class="nv">pprOpen&#39;</span> <span class="nv">t</span> <span class="p">[]</span>    <span class="o">=</span> <span class="nv">t</span>
<span class="nv">pprOpen&#39;</span> <span class="nv">t</span> <span class="nv">attrs</span> <span class="o">=</span> <span class="nv">t</span><span class="o">++</span><span class="sc">&#39; &#39;</span><span class="o">:</span><span class="nv">unwords</span> <span class="p">(</span><span class="nv">map</span> <span class="nv">pprAttr</span> <span class="nv">attrs</span><span class="p">)</span>
<span class="nv">pprOpen</span>  <span class="nv">t</span> <span class="nv">attrs</span> <span class="o">=</span> <span class="s">&quot;&lt;&quot;</span> <span class="o">++</span> <span class="nv">pprOpen&#39;</span> <span class="nv">t</span> <span class="nv">attrs</span> <span class="o">++</span><span class="s">&quot;&gt;&quot;</span>

<span class="nv">pprClose&#39;</span> <span class="nv">t</span> <span class="o">=</span> <span class="nv">t</span>
<span class="nv">pprClose</span>  <span class="nv">t</span> <span class="o">=</span> <span class="s">&quot;&lt;/&quot;</span> <span class="o">++</span> <span class="nv">t</span> <span class="o">++</span> <span class="s">&quot;&gt;&quot;</span>

<span class="nv">pprAttr</span> <span class="p">(</span><span class="nv">a</span><span class="p">,</span><span class="nv">v</span><span class="p">)</span> <span class="o">=</span> <span class="nv">a</span><span class="o">++</span><span class="s">&quot;=&#39;&quot;</span><span class="o">++</span><span class="nv">v</span><span class="o">++</span><span class="s">&quot;&#39;&quot;</span>

<span class="nv">ignore</span> <span class="o">::</span> <span class="n">String</span> <span class="o">-&gt;</span> <span class="n">Bool</span>
<span class="nv">ignore</span> <span class="nv">t</span> <span class="o">=</span> <span class="nv">notElem</span> <span class="p">(</span><span class="nv">map</span> <span class="nv">toLower</span> <span class="nv">t</span><span class="p">)</span> <span class="p">[</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="s">&quot;strong&quot;</span><span class="p">,</span><span class="s">&quot;br&quot;</span><span class="p">]</span> 

<span class="nv">testdata</span><span class="o">=</span><span class="s">&quot;&lt;a href=&#39;www.google.com&#39;&gt;link&lt;/a&gt; &lt;blink&gt;and&lt;/blink&gt; &lt;strong onClick=&#39;alert(\&quot;</span><span class="n">NG</span><span class="o">\</span><span class="s">&quot;)&#39;&gt;click&lt;br/&gt;me!&lt;/strong&gt;&quot;</span>

<span class="c1">-- main = putStrLn . pprTags . map proc . parseTags =&lt;&lt; getContents</span>
<span class="nv">main</span> <span class="o">=</span> <span class="nv">putStrLn</span> <span class="o">.</span> <span class="nv">pprTags</span> <span class="o">.</span> <span class="nv">map</span> <span class="nv">proc</span> <span class="o">.</span> <span class="nv">parseTags</span> <span class="o">$</span> <span class="nv">testdata</span>

<span class="cm">{-</span>
<span class="cm">*Main&gt; :main</span>
<span class="cm">&lt;a href=&#39;www.google.com&#39;&gt;link&lt;/a&gt; &amp;lt;blink&gt;and&amp;lt;blink&gt; &lt;strong&gt;click&lt;br/&gt;me!&lt;/strong&gt;</span>
<span class="cm">-}</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2705/addtag/" class="addtag" id="addtag_2705">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/haskell/">
		Haskell
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2705/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2705/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #dfffdf;"
  >2/2=1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2705"
  >-</span><span
  class="button yellow"
  id="rating_z_2705"
  >0</span><span 
  class="button green"
  id="rating_p_2705"
  >+</span></span></span>
  
<p>

  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2705/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2705/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2757"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/98/" target="_top">nobsun</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2757/">#2757</a>(<script language="JavaScript">print_time(new Date("2007/08/31 13:50 GMT"));</script><noscript>2007/08/31 13:50 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/haskell/">
	  Haskell
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>1. パーザ (文字列→構文木)
2. トランスレータ (構文木→構文木)
3. プリンタ (構文木→文字列)
と分けて

パーザは Tag Soupライブラリのものを使い、
タグのエスケープはトランスレータで行うようにし、
プリンタは自前で書いてみました。
コメントは保存されます。

こちらの方が前の投稿のものよりモジュラリティが
高くなった気がします。

urlエンコーディングによるuriの値表現の
validatingは手を抜いておこなっていません。
(元元要求にはなかったような気がしますと言い訳してみる:p)</pre>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93</pre></td><td class="code"><div class="highlight"><pre><span class="kr">module</span> <span class="n">Main</span> <span class="p">(</span><span class="nv">main</span><span class="p">)</span> <span class="kr">where</span>

<span class="kr">import</span> <span class="n">Data</span><span class="o">.</span><span class="n">Char</span>
<span class="kr">import</span> <span class="n">Data</span><span class="o">.</span><span class="n">Maybe</span>
<span class="kr">import</span> <span class="n">Text</span><span class="o">.</span><span class="n">HTML</span><span class="o">.</span><span class="n">TagSoup</span>

<span class="c1">-- Parsing</span>
<span class="c1">-- Text.HTML.TagSoup.parseTags :: String -&gt; [Tag Char]</span>

<span class="c1">-- Translating</span>
<span class="nv">translate</span> <span class="o">::</span> <span class="p">[</span><span class="n">Tag</span> <span class="n">Char</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">Tag</span> <span class="n">Char</span><span class="p">]</span>
<span class="nv">translate</span> <span class="o">=</span> <span class="nv">map</span> <span class="nv">trans</span>

<span class="nv">trans</span> <span class="o">::</span> <span class="n">Tag</span> <span class="n">Char</span> <span class="o">-&gt;</span> <span class="n">Tag</span> <span class="n">Char</span>
<span class="nv">trans</span> <span class="nv">tag</span> <span class="o">=</span> <span class="kr">case</span> <span class="nv">tag</span> <span class="kr">of</span>
  <span class="n">TagOpen</span> <span class="nv">t</span> <span class="nv">attrs</span> <span class="o">|</span> <span class="nv">ignore</span> <span class="nv">t</span>  <span class="o">-&gt;</span> <span class="nv">escapeTagOpen</span> <span class="nv">t</span> <span class="nv">attrs</span>
                  <span class="o">|</span> <span class="nv">otherwise</span> <span class="o">-&gt;</span> <span class="n">TagOpen</span> <span class="nv">t</span> <span class="p">(</span><span class="nv">filterAttr</span> <span class="nv">t</span> <span class="nv">attrs</span><span class="p">)</span>
  <span class="n">TagClose</span> <span class="nv">t</span>      <span class="o">|</span> <span class="nv">ignore</span> <span class="nv">t</span>  <span class="o">-&gt;</span> <span class="nv">escapeTagClose</span> <span class="nv">t</span>
  <span class="kr">_</span>                           <span class="o">-&gt;</span> <span class="nv">tag</span>

<span class="nv">ignore</span> <span class="o">::</span> <span class="n">String</span> <span class="o">-&gt;</span> <span class="n">Bool</span>
<span class="nv">ignore</span> <span class="o">=</span> <span class="nv">flip</span> <span class="nv">notElem</span> <span class="p">(</span><span class="nv">map</span> <span class="nv">fst</span> <span class="nv">filterTable</span><span class="p">)</span> <span class="o">.</span> <span class="nv">map</span> <span class="nv">toLower</span>

<span class="nv">escapeTagOpen</span> <span class="nv">t</span> <span class="nv">attrs</span>
 <span class="o">=</span> <span class="n">TagText</span> <span class="o">$</span> <span class="s">&quot;&amp;lt;&quot;</span><span class="o">++</span><span class="nv">t</span><span class="o">++</span><span class="nv">escape</span> <span class="p">(</span><span class="sc">&#39; &#39;</span><span class="o">:</span><span class="nv">unwords</span> <span class="p">(</span><span class="nv">map</span> <span class="nv">showAttr</span> <span class="nv">attrs</span><span class="p">))</span><span class="o">++</span><span class="s">&quot;&amp;gt;&quot;</span>
<span class="nv">escapeTagClose</span> <span class="nv">t</span>
 <span class="o">=</span> <span class="n">TagText</span> <span class="o">$</span> <span class="s">&quot;&amp;lt;/&quot;</span><span class="o">++</span><span class="nv">t</span><span class="o">++</span><span class="s">&quot;&amp;gt;&quot;</span>

<span class="nv">filterAttr</span> <span class="o">::</span> <span class="n">String</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">Attribute</span> <span class="n">Char</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">Attribute</span> <span class="n">Char</span><span class="p">]</span>
<span class="nv">filterAttr</span> <span class="nv">t</span> <span class="o">=</span> <span class="nv">filter</span> <span class="p">((</span><span class="nv">maybe</span> <span class="p">(</span><span class="nv">const</span> <span class="n">True</span><span class="p">)</span> <span class="nv">id</span> <span class="p">(</span><span class="nv">lookup</span> <span class="nv">t</span> <span class="nv">filterTable</span><span class="p">))</span> <span class="o">.</span> <span class="nv">fst</span><span class="p">)</span>

<span class="nv">filterTable</span> <span class="o">::</span> <span class="p">[(</span><span class="n">String</span><span class="p">,</span><span class="n">String</span><span class="o">-&gt;</span><span class="n">Bool</span><span class="p">)]</span>
<span class="nv">filterTable</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="nv">flip</span> <span class="nv">elem</span> <span class="p">[</span><span class="s">&quot;href&quot;</span><span class="p">,</span><span class="s">&quot;name&quot;</span><span class="p">])</span>
	      <span class="p">,(</span><span class="s">&quot;strong&quot;</span><span class="p">,</span><span class="nv">const</span> <span class="n">False</span><span class="p">)</span>
	      <span class="p">,(</span><span class="s">&quot;br&quot;</span><span class="p">,</span><span class="nv">const</span> <span class="n">False</span><span class="p">)]</span>

<span class="c1">-- Showing</span>

<span class="nv">showTags</span> <span class="o">::</span> <span class="p">[</span><span class="n">Tag</span> <span class="n">Char</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">String</span>
<span class="nv">showTags</span> <span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
<span class="nv">showTags</span> <span class="p">(</span><span class="n">TagOpen</span> <span class="nv">s</span> <span class="nv">attrs</span> <span class="o">:</span> <span class="n">TagClose</span> <span class="nv">e</span> <span class="o">:</span> <span class="nv">ts</span><span class="p">)</span> <span class="o">|</span> <span class="nv">isEmptyTag</span> <span class="nv">e</span> 
 <span class="o">=</span> <span class="nv">angle</span> <span class="p">(</span><span class="nv">s</span> <span class="o">++</span> <span class="sc">&#39; &#39;</span><span class="o">:</span><span class="nv">unwords</span> <span class="p">(</span><span class="nv">map</span> <span class="nv">showAttr</span> <span class="nv">attrs</span><span class="p">)</span><span class="o">++</span><span class="s">&quot; /&quot;</span><span class="p">)</span><span class="o">++</span><span class="nv">showTags</span> <span class="nv">ts</span>
<span class="nv">showTags</span> <span class="p">(</span><span class="nv">t</span><span class="o">:</span><span class="nv">ts</span><span class="p">)</span> 
 <span class="o">=</span> <span class="nv">showTag</span> <span class="nv">t</span> <span class="o">++</span> <span class="nv">showTags</span> <span class="nv">ts</span>

<span class="nv">showTag</span> <span class="nv">tag</span> <span class="o">=</span> <span class="kr">case</span> <span class="nv">tag</span> <span class="kr">of</span>
  <span class="n">TagOpen</span> <span class="nv">t</span> <span class="nv">attrs</span> <span class="o">-&gt;</span> <span class="nv">angle</span> <span class="o">$</span> <span class="nv">t</span> <span class="o">++</span> <span class="sc">&#39; &#39;</span><span class="o">:</span><span class="nv">unwords</span> <span class="p">(</span><span class="nv">map</span> <span class="nv">showAttr</span> <span class="nv">attrs</span><span class="p">)</span>
  <span class="n">TagClose</span> <span class="nv">t</span>      <span class="o">-&gt;</span> <span class="nv">angle</span> <span class="o">$</span> <span class="nv">t</span> <span class="o">++</span> <span class="s">&quot;/&quot;</span>
  <span class="n">TagText</span> <span class="nv">s</span>       <span class="o">-&gt;</span> <span class="nv">s</span>
  <span class="n">TagComment</span> <span class="nv">c</span>    <span class="o">-&gt;</span> <span class="nv">angle</span> <span class="o">$</span> <span class="s">&quot;!--&quot;</span> <span class="o">++</span> <span class="nv">c</span> <span class="o">++</span> <span class="s">&quot;--&quot;</span>
  <span class="n">TagSpecial</span> <span class="nv">s</span> <span class="nv">t</span>  <span class="o">-&gt;</span> <span class="nv">angle</span> <span class="o">$</span> <span class="s">&quot;!&quot;</span> <span class="o">++</span> <span class="nv">s</span> <span class="o">++</span> <span class="sc">&#39; &#39;</span><span class="o">:</span><span class="nv">t</span>
  <span class="n">TagWarning</span> <span class="nv">s</span>    <span class="o">-&gt;</span> <span class="s">&quot;&quot;</span>

<span class="nv">angle</span> <span class="o">::</span> <span class="n">String</span> <span class="o">-&gt;</span> <span class="n">String</span>
<span class="nv">angle</span> <span class="nv">s</span> <span class="o">=</span> <span class="s">&quot;&lt;&quot;</span><span class="o">++</span><span class="nv">s</span><span class="o">++</span><span class="s">&quot;&gt;&quot;</span>

<span class="nv">isEmptyTag</span> <span class="o">::</span> <span class="n">String</span> <span class="o">-&gt;</span> <span class="n">Bool</span>
<span class="nv">isEmptyTag</span> <span class="o">=</span> <span class="nv">flip</span> <span class="nv">elem</span> <span class="p">[</span><span class="s">&quot;br&quot;</span><span class="p">,</span><span class="s">&quot;hr&quot;</span><span class="p">]</span>     <span class="c1">-- not full fledged</span>

<span class="nv">showAttr</span> <span class="o">::</span> <span class="n">Attribute</span> <span class="n">Char</span> <span class="o">-&gt;</span> <span class="n">String</span>
<span class="nv">showAttr</span> <span class="p">(</span><span class="nv">a</span><span class="p">,</span><span class="nv">v</span><span class="p">)</span> <span class="o">=</span> <span class="nv">a</span> <span class="o">++</span> <span class="s">&quot;=&quot;</span> <span class="o">++</span> <span class="nv">q</span> <span class="nv">v</span>
  <span class="kr">where</span> <span class="nv">q</span> <span class="nv">v</span> <span class="o">=</span> <span class="kr">if</span> <span class="nv">elem</span> <span class="nv">sq</span> <span class="nv">v</span> <span class="kr">then</span> <span class="nv">dq</span><span class="o">:</span><span class="nv">v</span><span class="o">++</span><span class="p">[</span><span class="nv">dq</span><span class="p">]</span>
              <span class="kr">else</span> <span class="nv">sq</span><span class="o">:</span><span class="nv">v</span><span class="o">++</span><span class="p">[</span><span class="nv">sq</span><span class="p">]</span>
        <span class="nv">sq</span> <span class="o">=</span> <span class="sc">&#39;\&#39;&#39;</span>
<span class="sc">        dq = &#39;</span><span class="o">\</span><span class="s">&quot;&#39;</span>

<span class="s">escape :: String -&gt; String</span>
<span class="s">escape = concatMap esc</span>
<span class="s"> where esc &#39;&lt;&#39; = &quot;</span><span class="o">&amp;</span><span class="nv">lt</span><span class="p">;</span><span class="s">&quot;</span>
<span class="s">       esc &#39;&gt;&#39; = &quot;</span><span class="o">&amp;</span><span class="nv">gt</span><span class="p">;</span><span class="s">&quot;</span>
<span class="s">       esc &#39;&amp;&#39; = &quot;</span><span class="o">&amp;</span><span class="nv">amp</span><span class="p">;</span><span class="s">&quot;</span>
<span class="s">       esc c   = [c]</span>

<span class="s">--</span>

<span class="s">main :: IO ()</span>
<span class="s">-- main = putStrLn . showTags . translate . parseTags =&lt;&lt; getContents</span>

<span class="s">main = do { putStrLn . showTags . translate . parseTags $ testdata1</span>
<span class="s">          ; putStrLn . showTags . translate . parseTags $ testdata2</span>
<span class="s">          ; putStrLn . showTags . translate . parseTags $ testdata3</span>
<span class="s">	  }</span>

<span class="s">testdata1 = &quot;</span><span class="o">&lt;</span><span class="nv">script</span> <span class="nv">foo</span><span class="o">=\</span><span class="s">&quot;&lt;script&gt;alert(&#39;bar&#39;)&lt;/script&gt;\&quot;</span><span class="o">&gt;</span><span class="nv">alert</span><span class="p">(</span><span class="sc">&#39;foo&#39;</span><span class="p">)</span><span class="o">&lt;/</span><span class="nv">script</span><span class="o">&gt;</span><span class="s">&quot;</span>
<span class="s">testdata2 = &quot;</span><span class="o">&lt;</span><span class="nv">script</span> <span class="nv">foo</span><span class="o">=\</span><span class="s">&quot;&lt;a href=&#39;link&#39;&gt;link&lt;/a&gt;\&quot;</span><span class="o">&gt;</span><span class="nv">alert</span><span class="p">(</span><span class="sc">&#39;foo&#39;</span><span class="p">)</span><span class="o">&lt;/</span><span class="nv">script</span><span class="o">&gt;</span><span class="s">&quot;</span>
<span class="s">testdata3 = &quot;</span><span class="o">&lt;</span><span class="nv">a</span> <span class="nv">href</span><span class="o">=</span><span class="sc">&#39;www.g&gt;oogle.com&#39;</span><span class="o">&gt;</span><span class="nv">link</span><span class="o">&lt;/</span><span class="nv">a</span><span class="o">&gt;</span><span class="s">&quot;</span>

<span class="s">{-</span>
<span class="s">*Main&gt; :main</span>
<span class="s">&amp;lt;script foo=&quot;</span><span class="o">&amp;</span><span class="nv">lt</span><span class="p">;</span><span class="nv">script</span><span class="o">&amp;</span><span class="nv">gt</span><span class="p">;</span><span class="nv">alert</span><span class="p">(</span><span class="sc">&#39;bar&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="nv">lt</span><span class="p">;</span><span class="o">/</span><span class="nv">script</span><span class="o">&amp;</span><span class="nv">gt</span><span class="p">;</span><span class="s">&quot;&amp;gt;alert(&#39;foo&#39;)&amp;lt;/script&amp;gt;</span>
<span class="s">&amp;lt;script foo=&quot;</span><span class="o">&amp;</span><span class="nv">lt</span><span class="p">;</span><span class="nv">a</span> <span class="nv">href</span><span class="o">=</span><span class="sc">&#39;link&#39;</span><span class="o">&amp;</span><span class="nv">gt</span><span class="p">;</span><span class="nv">link</span><span class="o">&amp;</span><span class="nv">lt</span><span class="p">;</span><span class="o">/</span><span class="nv">a</span><span class="o">&amp;</span><span class="nv">gt</span><span class="p">;</span><span class="s">&quot;&amp;gt;alert(&#39;foo&#39;)&amp;lt;/script&amp;gt;</span>
<span class="s">&lt;a href=&#39;www.g&gt;oogle.com&#39;&gt;link&lt;a/&gt;</span>
<span class="s">-}</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2757/addtag/" class="addtag" id="addtag_2757">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/haskell/">
		Haskell
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2757/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2757/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2757"
  >-</span><span
  class="button yellow"
  id="rating_z_2757"
  >0</span><span 
  class="button green"
  id="rating_p_2757"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2705/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2757/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2757/">
  返信
  </a>]
  </div>
</div>
</div>



  


    </div>
  


  

  
    




<div class="comment" id="comment2706"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/82/" target="_top">yuin</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2706/">#2706</a>(<script language="JavaScript">print_time(new Date("2007/08/31 02:10 GMT"));</script><noscript>2007/08/31 02:10 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/scala/">
	  Scala
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #efffef;">1/1=1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  
<p>ライブラリを使ったら面白くないので、自分で書いてみた。思ったよりすっきりかけた気がする。
</p>



	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43</pre></td><td class="code"><div class="highlight"><pre>import java.util.regex._
class ExtendedString(self:String) {
  def gsub(reg:Pattern, f:(Matcher)=&gt;String):String = {
    val result = new StringBuffer
    val m = reg.matcher(self)
    while(m.find) m.appendReplacement(result, f(m))
    m.appendTail(result)
    result.toString
  }
  def gsub(reg:String, f:(Matcher)=&gt;String):String = gsub(Pattern.compile(reg), f)
}
implicit def string2ext(self:String) = new ExtendedString(self);


object htmlEscape{
  lazy val tagRegex = Pattern.compile(
    &quot;&quot;&quot;(&lt;/?)([^&quot;&#39;&lt; &gt;]*)([^&quot;&#39;&lt;&gt;]*(?:&quot;[^&quot;]*&quot;[^&quot;&#39;&lt;&gt;]*|&#39;[^&#39;]*&#39;[^&quot;&#39;&lt;&gt;]*)*)((?:&gt;|(?=&lt;)|$(?!\n)))&quot;&quot;&quot;
  )
  lazy val attrRegex = Pattern.compile(
    &quot;&quot;&quot;[\s&#39;&quot;](\w+)\s*=\s*([^\s&#39;&quot;&gt;]+|&#39;[^&#39;]+&#39;|\&quot;[^&quot;]+&quot;)&quot;&quot;&quot;
  , Pattern.DOTALL | Pattern.CASE_INSENSITIVE)
  lazy val tagAllowed = Set(&quot;a&quot;, &quot;br&quot;, &quot;strong&quot;)
  lazy val attrAllowed = Map(&quot;a&quot; -&gt; Set(&quot;href&quot;, &quot;name&quot;))

  def apply(html:String) = {
    html.gsub(tagRegex, (m:Matcher) =&gt; {
      val tag = m.group(2).toLowerCase.replace(&quot;/&quot;,&quot;&quot;)
      (if(tagAllowed.contains(tag)){
        val attrs = m.group(3).gsub(attrRegex, (m2:Matcher) =&gt; {
          if(attrAllowed.getOrElse(tag, Set[String]()).contains(m2.group(1).toLowerCase)) {
            m2.group(0)
          }else {
            &quot;&quot;
          }
        })
        List(m.group(1),m.group(2), attrs, m.group(4))
      }else {
        List(m.group(1).replace(&quot;&lt;&quot;, &quot;&amp;lt;&quot;), m.group(2), m.group(3), m.group(4))
      }).mkString(&quot;&quot;)
    })
  }
}
println(htmlEscape(&quot;&quot;&quot;&lt;a href=&#39;www.google.com&#39;&gt;link&lt;/a&gt; &lt;blink&gt;and&lt;/blink&gt; &lt;strong onClick=&#39;alert(&quot;NG&quot;)&#39;&gt;click&lt;br/&gt;me!&lt;/strong&gt;&quot;&quot;&quot;))
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2706/addtag/" class="addtag" id="addtag_2706">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/scala/">
		Scala
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2706/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2706/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #efffef;"
  >1/1=1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2706"
  >-</span><span
  class="button yellow"
  id="rating_z_2706"
  >0</span><span 
  class="button green"
  id="rating_p_2706"
  >+</span></span></span>
  
<p>

  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2706/">
  返信
  </a>]
  </div>
</div>
</div>



  


  

  

  
    




<div class="comment" id="comment2763"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/402/" target="_top">tea</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2763/">#2763</a>(<script language="JavaScript">print_time(new Date("2007/09/01 03:06 GMT"));</script><noscript>2007/09/01 03:06 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/python/">
	  Python
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>HTMLParser,htmllibを使わずに、スクラッチから書いてみました。
フィルタの登録が簡単にできます。

※ 字句解析部分は、十分にテストしてないので、全然 自信なしです。エンティティ等も未サポート・・・どころか誤動作起こす恐れもあり。

※ フィルタの適用部分は、余計なメソッド呼び出しがたくさん発生する、冗長（無駄の多い）な実装です。

※ 終了タグの扱いがad-hoc。(scan_htmlとpack_tag)

ということなので、最初は汎用性とか考えて書いてた割りに、下の実装の品質は低いです。

</pre>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152</pre></td><td class="code"><div class="highlight"><pre><span class="k">import</span> <span class="nn">sys</span>
<span class="k">import</span> <span class="nn">string</span>
<span class="k">from</span> <span class="nn">cgi</span> <span class="k">import</span> <span class="n">escape</span>
<span class="k">from</span> <span class="nn">urllib</span> <span class="k">import</span> <span class="n">quote</span>
<span class="k">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">imap</span>

<span class="n">letters</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span>
<span class="n">TAG</span><span class="p">,</span> <span class="n">ATTR</span><span class="p">,</span> <span class="n">QUOTE</span><span class="p">,</span> <span class="n">TEXT</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">scan_html</span><span class="p">(</span><span class="n">html</span><span class="p">):</span>

    <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">value</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">TEXT</span>
    <span class="n">quoted</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">closed</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">escaped</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">html</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">TAG</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&quot;&gt;&quot;</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">TAG</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="bp">None</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">TEXT</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;/&#39;</span> <span class="ow">and</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">+=</span> <span class="n">c</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">letters</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">+=</span> <span class="n">c</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">whitespace</span><span class="p">:</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">ATTR</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="n">ATTR</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">letters</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">+=</span> <span class="n">c</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">whitespace</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;=&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quoted</span><span class="p">:</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">QUOTE</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">+=</span> <span class="n">c</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">TAG</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;&gt;&#39;</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">TAG</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="bp">None</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">TEXT</span>
            
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="n">QUOTE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">quoted</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">quoted</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">escaped</span><span class="p">:</span>
                        <span class="n">escaped</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="n">value</span> <span class="o">+=</span> <span class="n">c</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">attr</span><span class="p">,</span><span class="n">value</span><span class="p">))</span>
                        <span class="n">state</span> <span class="o">=</span> <span class="n">TAG</span>
                <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">:</span>
                    <span class="n">escaped</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">value</span> <span class="o">+=</span> <span class="n">c</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">+=</span> <span class="n">c</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&quot;&#39;&quot;</span><span class="p">):</span>
                <span class="n">quoted</span> <span class="o">=</span> <span class="n">c</span>

        <span class="k">else</span><span class="p">:</span> <span class="c"># TEXT</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&quot;&lt;&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">TEXT</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">text</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">TAG</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="n">c</span>

<span class="k">class</span> <span class="nc">MyHTMLParser</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag_filters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_filters</span> <span class="o">=</span> <span class="p">{}</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">text_filters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forbid_tags</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">text</span><span class="p">)):</span>
        <span class="n">find_filter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">state</span><span class="p">,</span><span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()),</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">)</span>

        <span class="n">tag</span><span class="p">,</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">find_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_filters</span><span class="p">)((</span><span class="n">tag</span><span class="p">,</span><span class="n">attrs</span><span class="p">))</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">find_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attr_filters</span><span class="p">)(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">find_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text_filters</span><span class="p">)(</span><span class="n">text</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">is_allowed_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_tags</span> <span class="ow">and</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_tags</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forbid_tags</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forbid_tags</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="bp">False</span>
        
        <span class="k">def</span> <span class="nf">pack_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="n">tag</span>
            <span class="k">elif</span> <span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s"> /&gt;&quot;</span> <span class="o">%</span> <span class="n">tag</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;/ &#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> /&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;/ &#39;</span><span class="p">),</span><span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span><span class="o">.</span><span class="n">__mod__</span><span class="p">,</span><span class="n">attrs</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="n">tag</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;/ &#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span><span class="o">.</span><span class="n">__mod__</span><span class="p">,</span><span class="n">attrs</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">imap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span> <span class="n">scan_html</span><span class="p">(</span><span class="n">html</span><span class="p">)):</span>
            <span class="n">state</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">attrs</span><span class="p">,</span><span class="n">text</span> <span class="o">=</span> <span class="n">event</span>
            <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">TAG</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_allowed_tag</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39; /&#39;</span><span class="p">)):</span>
                    <span class="n">output</span><span class="p">(</span><span class="n">pack_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">attrs</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output</span><span class="p">(</span><span class="n">escape</span><span class="p">(</span><span class="n">pack_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">attrs</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="n">TEXT</span><span class="p">:</span>
                <span class="n">output</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">html</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">allow_attrs</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">attrs</span><span class="p">:</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span><span class="n">quote</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">remove_all_attrs</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">MyHTMLParser</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">allow_tags</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;br&#39;</span><span class="p">,</span> <span class="s">&#39;strong&#39;</span><span class="p">]</span>
    <span class="n">p</span><span class="o">.</span><span class="n">attr_filters</span><span class="p">[(</span><span class="n">TAG</span><span class="p">,</span><span class="s">&#39;a&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">allow_attrs</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">)</span> 
    <span class="n">p</span><span class="o">.</span><span class="n">attr_filters</span><span class="p">[(</span><span class="n">TAG</span><span class="p">,</span><span class="s">&#39;br&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">remove_all_attrs</span>
    <span class="n">p</span><span class="o">.</span><span class="n">attr_filters</span><span class="p">[(</span><span class="n">TAG</span><span class="p">,</span><span class="s">&#39;strong&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">remove_all_attrs</span>
    <span class="n">p</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
    <span class="k">print</span>


<span class="n">test</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;script foo=&quot;&lt;script&gt;alert(&#39;bar&#39;)&lt;/script&gt;&quot;&gt;alert(&#39;foo&#39;)&lt;/script&gt;&#39;&#39;&#39;</span><span class="p">)</span>
<span class="n">test</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;script foo=&quot;&lt;a href=&#39;link&#39;&gt;link&lt;/a&gt;&quot;&gt;alert(&#39;foo&#39;)&lt;/script&gt;&#39;&#39;&#39;</span><span class="p">)</span>
<span class="n">test</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;a href=&#39;www.g&gt;oogle.com&#39;&gt;link&lt;/a&gt;&#39;&#39;&#39;</span><span class="p">)</span>
<span class="n">test</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;br /&gt;&#39;&#39;&#39;</span><span class="p">)</span>
<span class="n">test</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;img src=&quot;foo.jpg&quot; /&gt;&#39;&#39;&#39;</span><span class="p">)</span>
<span class="n">test</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;a href=&#39;www.google.com&#39;&gt;link&lt;/a&gt; &lt;blink&gt;and&lt;/blink&gt; &lt;strong onClick=&#39;alert(&quot;NG&quot;)&#39;&gt;click&lt;br/&gt;me!&lt;/strong&gt;&quot;&quot;&quot;</span><span class="p">)</span>
<span class="n">test</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;strong style=&quot;color:red;&quot;&gt;ok&lt;/strong&gt;&quot;&quot;&quot;</span><span class="p">)</span>
<span class="n">test</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;br /&gt;&lt;a href=&#39;localhost&#39;&gt;link&lt;/a&gt;&lt;strong onClick=&#39;alert(&quot;NG&quot;)&#39;&gt;ok&lt;/strong&gt;&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2763/addtag/" class="addtag" id="addtag_2763">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/python/">
		Python
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2763/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2763/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2763"
  >-</span><span
  class="button yellow"
  id="rating_z_2763"
  >0</span><span 
  class="button green"
  id="rating_p_2763"
  >+</span></span></span>
  
<p>

  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2763/">
  返信
  </a>]
  </div>
</div>
</div>



  


  

  

  

  
    




<div class="comment" id="comment2937"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/415/" target="_top">yohei</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2937/">#2937</a>(<script language="JavaScript">print_time(new Date("2007/09/07 07:47 GMT"));</script><noscript>2007/09/07 07:47 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/csharp/">
	  C#
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>この課題、非常に勉強になります。閉じタグ忘れに対応。
他の方ので、"&lt;!--" がエスケープされないのがいくつか上がってる気がします。</pre>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91</pre></td><td class="code"><div class="highlight"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text.RegularExpressions</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">HtmlFilter</span> <span class="k">{</span>
    <span class="k">private</span> <span class="n">Regex</span> <span class="n">_regFilter</span><span class="p">;</span>
        
    <span class="k">public</span> <span class="nf">HtmlFilter</span><span class="p">()</span> <span class="k">{</span>
        <span class="n">_regFilter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Regex</span><span class="p">(</span><span class="s">@&quot;(&lt;(?&lt;begin&gt;\w+)(?:\s+(?&lt;attr&gt;\w+\s*=\s*&quot;</span>
             <span class="p">+</span> <span class="s">&quot;(?:&#39;[^&#39;]*&#39;|\&quot;[^\&quot;]*\&quot;)&quot;</span> <span class="p">+</span> <span class="s">@&quot;\s*)*)?/?&gt;)|(&lt;/(?&lt;end&gt;\w+)\s*&gt;)&quot;</span><span class="p">,</span>
            <span class="n">RegexOptions</span><span class="p">.</span><span class="n">IgnoreCase</span> <span class="p">|</span> <span class="n">RegexOptions</span><span class="p">.</span><span class="n">Compiled</span><span class="p">);</span>
    <span class="k">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="nf">escape</span><span class="p">(</span><span class="kt">string</span> <span class="n">s</span><span class="p">)</span> <span class="k">{</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="s">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s">&quot;&amp;amp;&quot;</span><span class="p">).</span><span class="n">Replace</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s">&quot;&amp;lt;&quot;</span><span class="p">).</span><span class="n">Replace</span><span class="p">(</span><span class="s">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;&amp;gt;&quot;</span><span class="p">);</span>
    <span class="k">}</span>
    
    <span class="k">public</span> <span class="kt">string</span> <span class="nf">filter</span><span class="p">(</span><span class="kt">string</span> <span class="n">input</span><span class="p">)</span> <span class="k">{</span>
        <span class="kt">bool</span> <span class="n">tagA</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">tagStrong</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">Length</span> <span class="p">*</span> <span class="m">2</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">Match</span> <span class="n">m</span> <span class="p">=</span> <span class="n">_regFilter</span><span class="p">.</span><span class="n">Match</span><span class="p">(</span><span class="n">input</span><span class="p">);</span> <span class="n">m</span><span class="p">.</span><span class="n">Success</span><span class="p">;</span> <span class="n">m</span> <span class="p">=</span> <span class="n">_regFilter</span><span class="p">.</span><span class="n">Match</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span> <span class="k">{</span>
            <span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">escape</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">Index</span> <span class="p">-</span> <span class="n">index</span><span class="p">)));</span>
            <span class="n">index</span> <span class="p">=</span> <span class="n">m</span><span class="p">.</span><span class="n">Index</span> <span class="p">+</span> <span class="n">m</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="s">&quot;begin&quot;</span><span class="p">].</span><span class="n">Success</span><span class="p">)</span> <span class="k">{</span>
                <span class="k">switch</span> <span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="s">&quot;begin&quot;</span><span class="p">].</span><span class="n">Value</span><span class="p">.</span><span class="n">ToLower</span><span class="p">())</span> <span class="k">{</span>
                    <span class="k">case</span> <span class="s">&quot;a&quot;</span><span class="p">:</span>
                        <span class="kt">string</span> <span class="n">href</span> <span class="p">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
                        <span class="k">foreach</span> <span class="p">(</span><span class="n">Capture</span> <span class="n">capture</span> <span class="k">in</span> <span class="n">m</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="s">&quot;attr&quot;</span><span class="p">].</span><span class="n">Captures</span><span class="p">)</span> <span class="k">{</span>
                            <span class="kt">string</span><span class="p">[]</span> <span class="n">attribute</span> <span class="p">=</span> <span class="n">capture</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="sc">&#39;=&#39;</span><span class="p">);</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">attribute</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Trim</span><span class="p">().</span><span class="n">Equals</span><span class="p">(</span><span class="s">&quot;href&quot;</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">))</span> <span class="k">{</span>
                                <span class="n">href</span> <span class="p">=</span> <span class="s">&quot; href=&quot;</span> <span class="p">+</span> <span class="n">attribute</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Trim</span><span class="p">();</span>
                                <span class="k">break</span><span class="p">;</span>
                            <span class="k">}</span>
                        <span class="k">}</span>
                        <span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">tagA</span> <span class="p">?</span> <span class="s">&quot;&lt;/a&gt;&lt;a&quot;</span> <span class="p">:</span> <span class="s">&quot;&lt;a&quot;</span><span class="p">).</span><span class="n">Append</span><span class="p">(</span><span class="n">href</span><span class="p">).</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;&gt;&quot;</span><span class="p">);</span>
                        <span class="n">tagA</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s">&quot;strong&quot;</span><span class="p">:</span>
                        <span class="n">tagStrong</span><span class="p">++;</span>
                        <span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;&lt;strong&gt;&quot;</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s">&quot;br&quot;</span><span class="p">:</span>
                        <span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;&lt;br/&gt;&quot;</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">default</span><span class="p">:</span>
                        <span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">escape</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">Value</span><span class="p">));</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="k">}</span>
            <span class="k">}</span> <span class="k">else</span> <span class="k">{</span>
                <span class="k">switch</span> <span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="s">&quot;end&quot;</span><span class="p">].</span><span class="n">Value</span><span class="p">.</span><span class="n">ToLower</span><span class="p">())</span> <span class="k">{</span>
                    <span class="k">case</span> <span class="s">&quot;a&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">tagA</span><span class="p">)</span> <span class="k">{</span>
                            <span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;&lt;/a&gt;&quot;</span><span class="p">);</span>
                            <span class="n">tagA</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                        <span class="k">}</span> <span class="k">else</span> <span class="k">{</span>
                            <span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">escape</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">Value</span><span class="p">));</span>
                        <span class="k">}</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s">&quot;strong&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">tagStrong</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="k">{</span>
                            <span class="n">tagStrong</span><span class="p">--;</span>
                            <span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;&lt;/strong&gt;&quot;</span><span class="p">);</span>
                        <span class="k">}</span> <span class="k">else</span> <span class="k">{</span>
                            <span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">escape</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">Value</span><span class="p">));</span>
                        <span class="k">}</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">default</span><span class="p">:</span>
                        <span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">escape</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">Value</span><span class="p">));</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="k">}</span>
            <span class="k">}</span>
        <span class="k">}</span>

        <span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">escape</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">input</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="n">index</span><span class="p">)));</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">tagStrong</span><span class="p">--</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;&lt;/strong&gt;&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tagA</span><span class="p">)</span> <span class="n">sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="s">&quot;&lt;/a&gt;&quot;</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">sb</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
    <span class="k">}</span>
<span class="k">}</span>

<span class="k">class</span> <span class="nc">Program</span> <span class="k">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="k">{</span>
        <span class="n">HtmlFilter</span> <span class="n">f</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HtmlFilter</span><span class="p">();</span>
        <span class="kt">string</span> <span class="n">text</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">File</span><span class="p">.</span><span class="n">ReadAllText</span><span class="p">(</span><span class="s">&quot;hoge.txt&quot;</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">filter</span><span class="p">(</span><span class="n">text</span><span class="p">));</span>
    <span class="k">}</span>
<span class="k">}</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2937/addtag/" class="addtag" id="addtag_2937">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/csharp/">
		C#
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2937/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2937/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2937"
  >-</span><span
  class="button yellow"
  id="rating_z_2937"
  >0</span><span 
  class="button green"
  id="rating_p_2937"
  >+</span></span></span>
  
<p>

  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2937/">
  返信
  </a>]
  </div>
</div>
</div>



  


  

  
    




<div class="comment" id="comment2720"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/177/" target="_top">ocean</a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2720/">#2720</a>(<script language="JavaScript">print_time(new Date("2007/08/31 04:54 GMT"));</script><noscript>2007/08/31 04:54 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/python/">
	  Python
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>htmlって曖昧だから、あまり自信なし。例えば、
&lt;a href=foo.com&gt; みたいに属性がクオートされてない場合はサポートしていない。</pre>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></td><td class="code"><div class="highlight"><pre><span class="k">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="n">html</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">repl</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;(/?)\s*(a|br|strong)(\s.*|(/?))&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">S</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">beg_slash</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">end_slash</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="k">def</span> <span class="nf">attrs</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">):</span>
                <span class="k">yield</span> <span class="s">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s">r&quot;&quot;&quot;(\S+)\s*=\s*([&#39;&quot;]).+?\2&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">S</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">):</span>
                <span class="k">return</span> <span class="s">&quot;&lt;</span><span class="si">%s%s%s%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">beg_slash</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attrs</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">)),</span> <span class="n">end_slash</span> <span class="ow">or</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;a&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">combine</span><span class="p">(</span><span class="s">&quot;href&quot;</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">combine</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&quot;&amp;lt;&quot;</span> <span class="o">+</span> <span class="n">content</span> <span class="o">+</span> <span class="s">&quot;&gt;&quot;</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;&lt;([^&gt;]*)&gt;&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">repl</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">print</span> <span class="nb">filter</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;a href=&#39;www.google.com&#39;&gt;link&lt;/a&gt; &lt;blink&gt;and&lt;/blink&gt; &lt;strong onClick=&#39;alert(&quot;NG&quot;)&#39;&gt;click&lt;br/&gt;me!&lt;/strong&gt;&quot;&quot;&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2720/addtag/" class="addtag" id="addtag_2720">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/python/">
		Python
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2720/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2720/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2720"
  >-</span><span
  class="button yellow"
  id="rating_z_2720"
  >0</span><span 
  class="button green"
  id="rating_p_2720"
  >+</span></span></span>
  
<p>

  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2720/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2720/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2722"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/82/" target="_top">yuin</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2722/">#2722</a>(<script language="JavaScript">print_time(new Date("2007/08/31 05:28 GMT"));</script><noscript>2007/08/31 05:28 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #bfffbf;">4/4=1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>属性値の中の"&gt;"が考慮されていませんね。

&lt;a href='www.g&gt;oogle.com'&gt;link&lt;/a&gt;

というようなケースで

&lt;a&gt;oogle.com'&gt;link&lt;/a&gt;

となってしまいます。</pre>
	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2722/addtag/" class="addtag" id="addtag_2722">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #bfffbf;"
  >4/4=1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2722"
  >-</span><span
  class="button yellow"
  id="rating_z_2722"
  >0</span><span 
  class="button green"
  id="rating_p_2722"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2720/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2722/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2722/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2722/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2724"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/177/" target="_top">ocean</a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2724/">#2724</a>(<script language="JavaScript">print_time(new Date("2007/08/31 06:24 GMT"));</script><noscript>2007/08/31 06:24 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/python/">
	  Python
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffefef;">-1/1=-1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  なるほど、そんな場合があるのか・・・というわけで修正版です。<br/><br/>属性をパースする正規表現が二度出てくるのが美しくないですが・・・このあたりをPythonでうまく処理する方法ってあるのかな。
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></td><td class="code"><div class="highlight"><pre><span class="k">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="n">html</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">repl</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="n">beg_slash</span><span class="p">,</span> <span class="n">tag_name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">end_slash</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="n">beg_slash</span> <span class="o">+</span> <span class="n">tag_name</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s">r&quot;&quot;&quot;(\w+)\s*=\s*([&quot;&#39;]).+?\2&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">S</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="n">end_slash</span> <span class="o">+</span> <span class="s">&quot;&gt;&quot;</span>
        <span class="k">if</span> <span class="n">tag_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">combine</span><span class="p">(</span><span class="s">&quot;href&quot;</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tag_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;br&#39;</span><span class="p">,</span> <span class="s">&#39;strong&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">combine</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;&amp;lt;&quot;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;&quot;&quot;&lt;(/?)(\w+)((?:\s*\w+\s*=\s*([&quot;&#39;]).+?\4)*)\s*(/?)&gt;&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">repl</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">print</span> <span class="nb">filter</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;a href=&#39;www.google.com&#39;&gt;link&lt;/a&gt; &lt;blink&gt;and&lt;/blink&gt; &lt;strong onClick=&#39;alert(&quot;NG&quot;)&#39;&gt;click&lt;br/&gt;me!&lt;/strong&gt;&quot;&quot;&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2724/addtag/" class="addtag" id="addtag_2724">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/python/">
		Python
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2724/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2724/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffefef;"
  >-1/1=-1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2724"
  >-</span><span
  class="button yellow"
  id="rating_z_2724"
  >0</span><span 
  class="button green"
  id="rating_p_2724"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2722/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2724/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2724/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2724/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2727"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/41/" target="_top">shiro</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2727/">#2727</a>(<script language="JavaScript">print_time(new Date("2007/08/31 06:50 GMT"));</script><noscript>2007/08/31 06:50 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #bfffbf;">4/4=1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>oceanさんのコードで確かめたのでここにぶら下げますが、他のポストにも同じ問題があるかもしれません。

入力文字列が次のようなものだとまずいのでは：

  &lt;z foo='&lt;script&gt;alert("Boo")&lt;/script&gt;'&gt;
</pre>
	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2727/addtag/" class="addtag" id="addtag_2727">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #bfffbf;"
  >4/4=1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2727"
  >-</span><span
  class="button yellow"
  id="rating_z_2727"
  >0</span><span 
  class="button green"
  id="rating_p_2727"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2724/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2727/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2727/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2727/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2730"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/177/" target="_top">ocean</a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2730/">#2730</a>(<script language="JavaScript">print_time(new Date("2007/08/31 07:21 GMT"));</script><noscript>2007/08/31 07:21 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/diff/">
	  diff
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  なるほど、タグを無効化した場合、属性に含まれる&nbsp;&lt;&nbsp;を放置すると今度はそちらがタグとみなされるということですか。<br/><br/>というわけで再修正パッチです。でもきっとまだあるな・・・
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></td><td class="code"><div class="highlight"><pre><span class="gd">--- a.py.orig	Fri Aug 31 16:20:21 2007</span>
<span class="gi">+++ a.py	Fri Aug 31 16:20:35 2007</span>
<span class="gu">@@ -14,11 +14,12 @@</span>
         elif tag_name.lower() in (&#39;br&#39;, &#39;strong&#39;):
             return combine()
         else:
<span class="gd">-            return &quot;&amp;lt;&quot; + m.group(0)[1:]</span>
<span class="gi">+            return m.group(0).replace(&quot;&lt;&quot;, &quot;&amp;lt;&quot;)</span>
     return re.compile(r&quot;&quot;&quot;&lt;(/?)(\w+)((?:\s*\w+\s*=\s*([&quot;&#39;]).+?\4)*)\s*(/?)&gt;&quot;&quot;&quot;, re.S).sub(repl, html)
 
 def main():
     print filter(&quot;&quot;&quot;&lt;a href=&#39;www.google.com&#39;&gt;link&lt;/a&gt; &lt;blink&gt;and&lt;/blink&gt; &lt;strong onClick=&#39;alert(&quot;NG&quot;)&#39;&gt;click&lt;br/&gt;me!&lt;/strong&gt;&quot;&quot;&quot;)
<span class="gi">+    print filter(&quot;&quot;&quot; &lt;z foo=&#39;&lt;script&gt;alert(&quot;Boo&quot;)&lt;/script&gt;&#39;&gt;&quot;&quot;&quot;)</span>
 
 if __name__ == &#39;__main__&#39;:
     main()
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2730/addtag/" class="addtag" id="addtag_2730">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/diff/">
		diff
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2730/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2730/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2730"
  >-</span><span
  class="button yellow"
  id="rating_z_2730"
  >0</span><span 
  class="button green"
  id="rating_p_2730"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2727/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2730/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2730/">
  返信
  </a>]
  </div>
</div>
</div>



  


    </div>
  


    </div>
  


    </div>
  


    </div>
  


  

  

  
    




<div class="comment" id="comment2708"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/422/" target="_top">はま～ん</a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2708/">#2708</a>(<script language="JavaScript">print_time(new Date("2007/08/31 02:39 GMT"));</script><noscript>2007/08/31 02:39 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/javascript/">
	  JavaScript
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #efffef;">1/1=1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>inとoutにWSHを使ってます。

　cscript "javascriptファイル"  フィルタしたい文字列

で実行可能です。</pre>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">WScript</span><span class="p">.</span><span class="nx">Arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> 
	<span class="nx">WScript</span><span class="p">.</span><span class="nx">Quit</span><span class="p">();</span>
<span class="k">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">WScript</span><span class="p">.</span><span class="nx">Arguments</span><span class="p">.</span><span class="nx">item</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="k">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span>
	<span class="sr">/&lt;((\/?)([a-z]+)(.*?)(\/?))&gt;/ig</span><span class="o">,</span>
    <span class="k">function</span><span class="p">(</span><span class="nx">all</span><span class="o">,</span> <span class="nx">ins</span><span class="o">,</span> <span class="nx">head</span><span class="o">,</span> <span class="nx">tag</span><span class="o">,</span> <span class="nx">elms</span><span class="o">,</span> <span class="nx">tail</span><span class="p">){</span>
    	<span class="nx">switch</span> <span class="p">(</span><span class="nx">tag</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">())</span>
    	<span class="p">{</span>
			<span class="nx">case</span> <span class="s2">&quot;A&quot;</span><span class="o">:</span>
				<span class="k">var</span> <span class="nx">filterElms</span> <span class="o">=</span> <span class="nx">elms</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/ ?(href|name) *= *[^ \/&gt;]+/ig</span><span class="p">);</span>
				<span class="k">var</span> <span class="nx">newElement</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">filterElms</span><span class="p">)</span>
					<span class="k">for</span><span class="p">(</span><span class="k">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">filterElms</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
						<span class="nx">newElement</span> <span class="o">+=</span> <span class="nx">filterElms</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
				
				<span class="k">return</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="nx">head</span> <span class="o">+</span> <span class="nx">tag</span> <span class="o">+</span> <span class="nx">newElement</span> <span class="o">+</span> <span class="nx">tail</span> <span class="o">+</span><span class="s2">&quot;&gt;&quot;</span><span class="o">;</span>

			<span class="nx">case</span> <span class="s2">&quot;BR&quot;</span><span class="o">:</span>
			<span class="nx">case</span> <span class="s2">&quot;STRONG&quot;</span><span class="o">:</span>
				<span class="k">return</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="nx">head</span> <span class="o">+</span> <span class="nx">tag</span> <span class="o">+</span> <span class="nx">tail</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span><span class="o">;</span>

			<span class="nx">default</span><span class="o">:</span>
				<span class="k">return</span> <span class="s2">&quot;&amp;lt;&quot;</span> <span class="o">+</span> <span class="nx">ins</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span><span class="o">;</span>
				<span class="k">break</span><span class="o">;</span>
    	<span class="p">}</span>
    <span class="p">});</span>

<span class="nx">WScript</span><span class="p">.</span><span class="nx">Echo</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2708/addtag/" class="addtag" id="addtag_2708">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/javascript/">
		JavaScript
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2708/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2708/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #efffef;"
  >1/1=1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2708"
  >-</span><span
  class="button yellow"
  id="rating_z_2708"
  >0</span><span 
  class="button green"
  id="rating_p_2708"
  >+</span></span></span>
  
<p>

  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2708/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2708/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2728"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/422/" target="_top">はま～ん</a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2728/">#2728</a>(<script language="JavaScript">print_time(new Date("2007/08/31 06:51 GMT"));</script><noscript>2007/08/31 06:51 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/javascript/">
	  JavaScript
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffefef;">-1/1=-1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>＞http://ja.doukaku.org/comment/2722/
失念してました。

文中に"&gt;"等が入っても通るように正規表現修正。</pre>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">WScript</span><span class="p">.</span><span class="nx">Arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> 
	<span class="nx">WScript</span><span class="p">.</span><span class="nx">Quit</span><span class="p">();</span>
<span class="k">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">WScript</span><span class="p">.</span><span class="nx">Arguments</span><span class="p">.</span><span class="nx">item</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="k">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span>
	<span class="sr">/&lt;(\/?)(\w+)((\s*|\w+|\w+\s*=\s*(&#39;[^&#39;]*&#39;|&quot;[^&quot;]*&quot;|\w+))*)(\/?)&gt;/ig</span><span class="o">,</span>
    <span class="k">function</span><span class="p">(</span><span class="nx">all</span><span class="o">,</span> <span class="nx">head</span><span class="o">,</span> <span class="nx">tag</span><span class="o">,</span> <span class="nx">attr</span><span class="o">,</span> <span class="nx">nouse1</span><span class="o">,</span> <span class="nx">nouse2</span><span class="o">,</span> <span class="nx">tail</span><span class="p">){</span>
    	<span class="nx">switch</span> <span class="p">(</span><span class="nx">tag</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">())</span>
    	<span class="p">{</span>
			<span class="nx">case</span> <span class="s2">&quot;A&quot;</span><span class="o">:</span>
				<span class="k">var</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\s?(href|name)\s*=\s*(&#39;[^&#39;]*&#39;|&quot;[^&quot;]*&quot;|\w+)/ig</span><span class="p">);</span>
				<span class="k">var</span> <span class="nx">newAttr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">)</span>
					<span class="k">for</span><span class="p">(</span><span class="k">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">length</span><span class="o">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
						<span class="nx">newAttr</span> <span class="o">+=</span> <span class="nx">attrs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
				<span class="k">return</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="nx">head</span> <span class="o">+</span> <span class="nx">tag</span> <span class="o">+</span> <span class="nx">newAttr</span> <span class="o">+</span> <span class="nx">tail</span> <span class="o">+</span><span class="s2">&quot;&gt;&quot;</span><span class="o">;</span>

			<span class="nx">case</span> <span class="s2">&quot;BR&quot;</span><span class="o">:</span>
			<span class="nx">case</span> <span class="s2">&quot;STRONG&quot;</span><span class="o">:</span>
				<span class="k">return</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="nx">head</span> <span class="o">+</span> <span class="nx">tag</span> <span class="o">+</span> <span class="nx">tail</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span><span class="o">;</span>

			<span class="nx">default</span><span class="o">:</span>
				<span class="k">return</span> <span class="s2">&quot;&amp;lt;&quot;</span> <span class="o">+</span> <span class="nx">head</span> <span class="o">+</span> <span class="nx">tag</span> <span class="o">+</span> <span class="nx">attr</span> <span class="o">+</span> <span class="nx">tail</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span><span class="o">;</span>
    	<span class="p">}</span>
    <span class="p">});</span>

<span class="nx">WScript</span><span class="p">.</span><span class="nx">Echo</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2728/addtag/" class="addtag" id="addtag_2728">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/javascript/">
		JavaScript
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2728/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2728/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffefef;"
  >-1/1=-1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2728"
  >-</span><span
  class="button yellow"
  id="rating_z_2728"
  >0</span><span 
  class="button green"
  id="rating_p_2728"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2708/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2728/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2728/">
  返信
  </a>]
  </div>
</div>
</div>



  


    </div>
  


  

  

  
    




<div class="comment" id="comment2760"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/405/" target="_top">mc</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2760/">#2760</a>(<script language="JavaScript">print_time(new Date("2007/08/31 15:34 GMT"));</script><noscript>2007/08/31 15:34 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/commonlisp/">
	  Common Lisp
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffefef;">-1/1=-1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>ぴったりなライブラリはどこかにあると思うのですが、
見付けられませんでした…。
とりあえず、みつけられたurl-rewiteと
allegroのparse-htmlを使って作成してみました。
長くてぐちゃぐちゃですいません…。
嗚呼…。

ライブラリ:
http://opensource.franz.com/xmlutils/xmlutils-dist/phtml.htm
http://weitz.de/url-rewrite/</pre>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80</pre></td><td class="code"><div class="highlight"><pre>#+allegro (progn (require :phtml) (use-package :net.html.parser))

(defun html-filter (string &amp;optional in-prop-p)
  (let ((form (if in-prop-p 
		  (parse-html string)
		  (sanitize-html (parse-html string)))))
    (apply #&#39;concatenate &#39;string (build-html form in-prop-p))))

(defun sanitize-html (form)
  (mapcar (lambda (item)
	    (if (atom item)
		item
		(let ((keys `(,(car item) ,(and (consp (car item)) (caar item)))))
		  (cond ((member :a keys)
			 `(,(car item) ,@(sanitize-html (cdr item))))
			((member :strong keys)
			 `(:strong ,@(sanitize-html (cdr item))))
			((member :br keys) :br)
			(&#39;T item)))))
	  form))

(defun build-html (form &amp;optional in-prop-p)
  (if (atom form) 
      form
      (cond ((and (atom (car form)) (eq :br (car form)))
	     `(,(br in-prop-p) ,@(build-html (cdr form) in-prop-p)))
	    ((keywordp (car form)) (build-other form in-prop-p))
	    ((consp (car form))
	     `(,(let* ((top (car form))
		       (keys `(,(car top) ,(and (consp (car top)) (caar top)))))
		      (if in-prop-p
			  (cond ((member-if #&#39;keywordp keys) (build-other top in-prop-p))
				(&#39;T top))
			  (cond (member :a keys) (build-a top))
				((member :strong keys) (build-strong top))
				((member-if #&#39;keywordp keys) (build-other top in-prop-p))
				(&#39;T top))))
		,@(build-html (cdr form) in-prop-p)))
	    (&#39;T `(,(build-html (car form) in-prop-p)
		   ,@(build-html (cdr form) in-prop-p))))))

(defun br (&amp;optional in-prop-p)
  (if in-prop-p &quot;&amp;lt;br /&amp;gt;&quot; &quot;&lt;br /&gt;&quot;))

(defun build-strong (form)
  (format nil &quot;&lt;strong&gt;~{~A~}&lt;/strong&gt;&quot; (build-html (cdr form))))

(defun build-a (form)
  (let ((tag (car form))
	(body (build-html (cdr form))))
    (if (and (consp (car form)) 
	     (member (second tag) &#39;(:href :name)))
	(format nil &quot;&lt;a ~(~A~)=&#39;~A&#39;&gt;~{~A~}&lt;/a&gt; &quot; 
		(second tag) 
		(put-dot-slash-if-need (url-rewrite:url-encode (third tag))) body)
	(format nil &quot;&lt;a&gt;~{~A~}&lt;/a&gt; &quot; (build-html (cdr form))))))

(defun put-dot-slash-if-need (str)
  (let ((s (cl-ppcre:create-scanner &quot;^[Hh][Tt][Tt][Pp][Ss]*://&quot;)))
    (if (cl-ppcre:scan s str)
	str
	(concatenate &#39;string &quot;./&quot; str))))

(defun build-other (form &amp;optional in-prop-p)
  (let ((tag (car form))
	(body (build-html (cdr form))))
    (if (consp tag)
	(format nil &quot;~(&amp;lt;~A~{ ~A~}~)&amp;gt;~{~A~}~0@*&amp;lt;/~(~A~)&amp;gt; &quot; 
		(car tag) (prop-maker (cdr tag)) body)
	(if (and in-prop-p (eq :br tag))
	    &quot;&amp;lt;br&amp;gt;&quot;
	    (format nil &quot;~(&amp;lt;~A&amp;gt;~)~{~A~}~0@*&amp;lt;/~(~A~)&amp;gt;&quot;
		    tag (build-html (cdr form)))))))

(defun prop-maker (lst)
  (do ((l lst (cddr l))
       result)
      ((endp l) (nreverse result))
  (push (format nil &quot;~A=\&quot;~A\&quot;&quot; 
		(car l) (html-filter (cadr l) t)) result)))
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2760/addtag/" class="addtag" id="addtag_2760">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/commonlisp/">
		Common Lisp
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2760/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2760/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffefef;"
  >-1/1=-1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2760"
  >-</span><span
  class="button yellow"
  id="rating_z_2760"
  >0</span><span 
  class="button green"
  id="rating_p_2760"
  >+</span></span></span>
  
<p>

  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2760/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2760/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2897"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/405/" target="_top">mc</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2897/">#2897</a>(<script language="JavaScript">print_time(new Date("2007/09/04 09:49 GMT"));</script><noscript>2007/09/04 09:49 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>すいません、このコードの34行に開き括弧が一つ足りませんでした。
(cond ((mem
が正しいものです。</pre>
	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2897/addtag/" class="addtag" id="addtag_2897">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2897"
  >-</span><span
  class="button yellow"
  id="rating_z_2897"
  >0</span><span 
  class="button green"
  id="rating_p_2897"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2760/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2897/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2897/">
  返信
  </a>]
  </div>
</div>
</div>



  


    </div>
  


  

  
    




<div class="comment" id="comment2906"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/4/" target="_top">匿名</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2906/">#2906</a>(<script language="JavaScript">print_time(new Date("2007/09/04 16:37 GMT"));</script><noscript>2007/09/04 16:37 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/java/">
	  Java
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #dfffdf;">2/2=1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  SGMLのタグは非常に多様な形式を持つようです。もちろん全部の形式に対応すれば良いのですが、必ずしもブラウザが対応しているとは限らないため、正しい形式のタグであっても万一ブラウザが対応していない事によってセキュリティホールになってしまっては意味がありません。そこでごく一般的な形式のタグしか想定しない事にします。<br/><br/>方針<br/>間違っても、未処理のタグが残らないようにする（想定外であっても）。<br/>想定外の構造のタグが誤って変換されてしまう事はやむを得ないとする。<br/><br/>この条件を満たすため、以下の方法で処理する<br/><br/>変換対象のタグを前処理する<br/>全ての&nbsp;&lt;,&nbsp;&gt;&nbsp;を変換する<br/>前処理したタグを元に戻す<br/><br/>&amp;は題意から変換しないことにしました。尚、HTMLではURL中であっても文字参照は有効（ブラウザが解釈しなければならない）ため特別扱いはしていません。
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></td><td class="code"><div class="highlight"><pre><span class="k">import</span> <span class="nn">java.util.regex.*</span><span class="o">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">Sample</span> <span class="o">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">final</span> <span class="n">Pattern</span> <span class="n">TAG_FILTER</span> <span class="o">=</span> <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span>
        <span class="o">(</span><span class="s">&quot;&lt;(¥¥w+)((¥¥s+¥¥w+(¥¥s*=¥¥s*(¥&quot;</span><span class="o">[^</span><span class="err">¥</span><span class="s">&quot;]*¥&quot;</span><span class="o">|</span><span class="err">&#39;</span><span class="o">[^</span><span class="err">&#39;</span><span class="o">]*</span><span class="err">&#39;</span><span class="o">|[</span><span class="err">¥¥</span><span class="n">w</span><span class="o">-:]*))?)*)</span><span class="err">¥¥</span><span class="n">s</span><span class="o">*/?</span><span class="err">¥¥</span><span class="n">s</span><span class="o">*&gt;</span><span class="s">&quot;);</span>
<span class="s">    private static final Pattern END_TAG_FILTER = Pattern.compile</span>
<span class="s">        (&quot;</span><span class="o">(?</span><span class="n">i</span><span class="o">)&lt;/(</span><span class="n">A</span><span class="o">|</span><span class="n">BR</span><span class="o">|</span><span class="n">STRONG</span><span class="o">)</span><span class="err">¥¥</span><span class="n">s</span><span class="o">*&gt;</span><span class="s">&quot;);</span>
<span class="s">    private static final Pattern ATTR_FILTER = Pattern.compile</span>
<span class="s">        (&quot;</span><span class="o">(</span><span class="err">¥¥</span><span class="n">w</span><span class="o">+)</span><span class="err">¥¥</span><span class="n">s</span><span class="o">*=</span><span class="err">¥¥</span><span class="n">s</span><span class="o">*(</span><span class="err">¥</span><span class="s">&quot;[^¥&quot;</span><span class="o">]*</span><span class="err">¥</span><span class="s">&quot;|&#39;[^&#39;]*&#39;|[¥¥w-:]*)&quot;</span><span class="o">);</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">String</span> <span class="n">sanitizing</span><span class="o">(</span><span class="n">String</span> <span class="n">fragment</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">fragment</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">&quot;[¥¥p{Cntrl}&amp;&amp;[^¥¥s]]&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">);</span>
        <span class="n">Matcher</span> <span class="n">m</span> <span class="o">=</span> <span class="n">TAG_FILTER</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">fragment</span><span class="o">);</span>
        <span class="n">StringBuffer</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuffer</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">find</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="s">&quot;A&quot;</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">1</span><span class="o">)))</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">href</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">name</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">Matcher</span> <span class="n">m2</span> <span class="o">=</span> <span class="n">ATTR_FILTER</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">m2</span><span class="o">.</span><span class="na">find</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="s">&quot;href&quot;</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">m2</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">1</span><span class="o">)))</span> <span class="o">{</span>
                        <span class="n">href</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">m2</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">1</span><span class="o">)))</span> <span class="o">{</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">String</span> <span class="n">tag</span> <span class="o">=</span> <span class="s">&quot;¥001&quot;</span><span class="o">+</span><span class="n">m</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="o">((</span><span class="n">href</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)?</span><span class="s">&quot; href=&quot;</span><span class="o">+</span><span class="n">href</span>
                    <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="o">)</span> <span class="o">+</span> <span class="o">((</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)?</span> <span class="s">&quot; name=&quot;</span><span class="o">+</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot;¥002&quot;</span><span class="o">;</span>
                <span class="n">m</span><span class="o">.</span><span class="na">appendReplacement</span><span class="o">(</span><span class="n">sb</span><span class="o">,</span> <span class="n">m</span><span class="o">.</span><span class="na">quoteReplacement</span><span class="o">(</span><span class="n">tag</span><span class="o">));</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="s">&quot;BR&quot;</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span> <span class="o">||</span> 
                       <span class="s">&quot;STRONG&quot;</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">1</span><span class="o">)))</span> <span class="o">{</span>
                <span class="n">m</span><span class="o">.</span><span class="na">appendReplacement</span><span class="o">(</span><span class="n">sb</span><span class="o">,</span> <span class="s">&quot;¥001&quot;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot;¥002&quot;</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">m</span><span class="o">.</span><span class="na">appendTail</span><span class="o">(</span><span class="n">sb</span><span class="o">);</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">END_TAG_FILTER</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="n">fragment</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">&quot;¥001/$1¥002&quot;</span><span class="o">);</span>
        <span class="n">fragment</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">&quot;&lt;&quot;</span><span class="o">,</span> <span class="s">&quot;&amp;lt;&quot;</span><span class="o">);</span>
        <span class="n">fragment</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">&quot;&gt;&quot;</span><span class="o">,</span> <span class="s">&quot;&amp;gt;&quot;</span><span class="o">);</span>
        <span class="n">fragment</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">&quot;¥001&quot;</span><span class="o">,</span> <span class="s">&quot;&lt;&quot;</span><span class="o">);</span>
        <span class="n">fragment</span> <span class="o">=</span> <span class="n">fragment</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">&quot;¥002&quot;</span><span class="o">,</span> <span class="s">&quot;&gt;&quot;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">fragment</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="k">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">sanitizing</span><span class="o">(</span><span class="s">&quot;&lt;script&gt;&lt;abc&gt;&lt;def ghi=jkl&gt;&quot;</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">sanitizing</span><span class="o">(</span><span class="s">&quot;&lt;script foo=¥&quot;</span><span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span><span class="n">alert</span><span class="o">(</span><span class="err">¥&#39;</span><span class="n">bar</span><span class="err">¥&#39;</span><span class="o">)&lt;/</span><span class="n">script</span><span class="o">&gt;</span><span class="err">¥</span><span class="s">&quot;&gt;alert(¥&#39;foo¥&#39;)&lt;/script&gt;&quot;</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">sanitizing</span><span class="o">(</span><span class="s">&quot;&lt;script foo=¥&quot;</span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="err">¥&#39;</span><span class="n">link</span><span class="err">¥&#39;</span><span class="o">&gt;</span><span class="n">link</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span><span class="err">¥</span><span class="s">&quot; center&gt;alert(¥&#39;foo¥&#39;)&lt;/script&gt;&lt;BR/&gt;&quot;</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">sanitizing</span><span class="o">(</span><span class="s">&quot;&lt;a href=&#39;www.g&gt;oogle.com&#39; id=125&gt;link&lt;/a&gt;&quot;</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2906/addtag/" class="addtag" id="addtag_2906">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/java/">
		Java
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2906/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2906/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #dfffdf;"
  >2/2=1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2906"
  >-</span><span
  class="button yellow"
  id="rating_z_2906"
  >0</span><span 
  class="button green"
  id="rating_p_2906"
  >+</span></span></span>
  
<p>

  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2906/">
  返信
  </a>]
  </div>
</div>
</div>



  


  

  

  

  

  

  

  

  
    




<div class="comment" id="comment2761"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/88/" target="_top">sumim</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2761/">#2761</a>(<script language="JavaScript">print_time(new Date("2007/08/31 16:49 GMT"));</script><noscript>2007/08/31 16:49 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/smalltalk/">
	  Smalltalk
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  Squeak&nbsp;Smalltalk&nbsp;で。<br/><br/>例によって正規表現が使えないので手続き的に。この調子だと、より複雑なことが要求される続編が思いやられます…(^_^;)。
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></td><td class="code"><div class="highlight"><pre>| string in tag out save rest |
string := &#39;&lt;a href=&#39;&#39;www.google.com&#39;&#39;&gt;link&lt;/a&gt; &lt;blink&gt;and&lt;/blink&gt; &lt;strong onClick=&#39;&#39;alert(&quot;NG&quot;)&#39;&#39;&gt;click&lt;br/&gt;me!&lt;/strong&gt;&#39;.

in := string readStream.
out := String new writeStream.
[in atEnd] whileFalse: [
	out nextPutAll: (in upTo: $&lt;).
	in back.
	save := in position.
	tag := in upTo: Character space.
	(tag includes: $/) ifTrue: [in position: save. tag := in upTo: $&gt;. in back].
	out nextPutAll: ((#(&#39;&lt;a&#39; &#39;&lt;br/&#39; &#39;&lt;strong&#39; &#39;&lt;/a&#39; &#39;&lt;/strong&#39;) includes: tag asLowercase)
		ifTrue: [tag] ifFalse: [tag := &#39;&amp;lt;&#39;, tag allButFirst]).
	tag := tag asLowercase.
	[save := in position. (rest := in upTo: $&gt;) includes: $=] whileTrue: [
		| attr quote data |
		in position: save.
		attr := in upTo: $=.
		quote := (#($&#39; $&quot;) includes: in peek) ifTrue: [in next] ifFalse: [Character space].
		data := in upTo: quote.
		quote := quote = Character space ifTrue: [&#39;&#39;] ifFalse: [quote asString].
		data := attr, &#39;=&#39;, quote, data, quote.
		in skipSeparators.
		(tag = &#39;&lt;a&#39; and: [#(href name) includes: attr]) ifTrue: [out space; nextPutAll: data].
		(#(&#39;&lt;a&#39; &#39;&lt;br/&#39; &#39;&lt;strong&#39;) includes: tag) ifFalse: [
			out space.
			data do: [:chr | chr = $&lt; ifTrue: [out nextPutAll: &#39;&amp;lt;&#39;] ifFalse: [out nextPut: chr]]]].
	out nextPutAll: rest, &#39;&gt;&#39;].
^out contents

&quot;=&gt; &#39;&lt;a href=&#39;&#39;www.google.com&#39;&#39;&gt;link&lt;/a&gt; &amp;lt;blink&gt;and&amp;lt;/blink&gt; &lt;strong&gt;click&lt;br/&gt;me!&lt;/strong&gt;&#39; &quot;
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2761/addtag/" class="addtag" id="addtag_2761">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/smalltalk/">
		Smalltalk
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2761/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2761/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2761"
  >-</span><span
  class="button yellow"
  id="rating_z_2761"
  >0</span><span 
  class="button green"
  id="rating_p_2761"
  >+</span></span></span>
  
<p>

  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2761/">
    2
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2761/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2914"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/88/" target="_top">sumim</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2914/">#2914</a>(<script language="JavaScript">print_time(new Date("2007/09/05 10:00 GMT"));</script><noscript>2007/09/05 10:00 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/smalltalk/">
	  Smalltalk
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  次のお題向けに整理して書き直しました。
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></td><td class="code"><div class="highlight"><pre>| string accepts in out upToAnyOf letters separators |
string := &#39;&lt;a title=&quot;(&gt;_&lt;;)&quot; href=&#39;&#39;www.google.com&#39;&#39; name=&#39;&#39;hoge&#39;&#39; target=_blank&gt;link&lt;/a&gt; &lt;blink&gt;and&lt;/blink&gt; &lt;strong onClick=&#39;&#39;alert(&quot;NG&quot;)&#39;&#39;&gt;click&lt;br/&gt;me!&lt;/strong&gt;&#39;.

accepts := {#a-&gt;#(name href). #strong-&gt;#(). #br-&gt;#()} as: Dictionary.
string := string copyReplaceAll: &#39;&lt;br&gt;&#39; with: &#39;&lt;br/&gt;&#39;.
in := string readStream.
out := String new writeStream.
upToAnyOf := [:arr | String streamContents: [:ss |
    arr := arr copyWith: nil.
    [arr includes: in peek] whileFalse: [ss nextPut: in next]]].
letters := Character alphabet asArray, Character alphabet asUppercase.
separators := Character separators, #($/ $&gt;).

[out nextPutAll: (in upTo: $&lt;) escapeEntities. in atEnd] whileFalse: [
    | tag lt isClose isAccepted blank rest |
    (isClose := in peek == $/) ifTrue: [in next].
    tag := upToAnyOf value: separators.
    lt := &#39;&lt;&#39;, (isClose ifTrue: [&#39;/&#39;] ifFalse: [&#39;&#39;]).
    (isAccepted := accepts keys includes: tag asLowercase) ifFalse: [lt := lt escapeEntities].
    out nextPutAll: lt, tag.
    [blank := upToAnyOf value: letters, &#39;&gt;&#39;. {nil. $&gt;} includes: in peek] whileFalse: [
        | attr equal value quote |
        attr := upToAnyOf value: #($= $&gt;).
        equal := in peek == $= ifTrue: [in next asString] ifFalse: [&#39;&#39;].
        value := (#($&#39; $&quot;) includes: (quote := in peek))
            ifTrue: [quote asString, (in next; upTo: quote), quote asString]
            ifFalse: [upToAnyOf value: #($  $&gt;)].
        out nextPutAll: (isAccepted
            ifFalse: [blank, attr, equal, value escapeEntities]
            ifTrue: [((accepts at: tag) includes: attr)
                ifTrue: [blank, attr, equal, value] ifFalse: [&#39;&#39;]])].
    rest := blank, (in peek == $&gt; ifTrue: [in next asString] ifFalse: [&#39;&#39;]).
    out nextPutAll: (isAccepted ifTrue: [rest] ifFalse: [rest escapeEntities])].
World findATranscript: nil.
Transcript cr; show: out contents

&quot;=&gt; &lt;a href=&#39;www.google.com&#39; name=&#39;hoge&#39;&gt;link&lt;/a&gt; &amp;lt;blink&amp;gt;and&amp;lt;/blink&amp;gt; &lt;strong&gt;click&lt;br/&gt;me!&lt;/strong&gt; &quot;
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2914/addtag/" class="addtag" id="addtag_2914">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/smalltalk/">
		Smalltalk
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2914/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2914/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2914"
  >-</span><span
  class="button yellow"
  id="rating_z_2914"
  >0</span><span 
  class="button green"
  id="rating_p_2914"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2761/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2914/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2914/">
  返信
  </a>]
  </div>
</div>
</div>



  


    </div>
  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2762"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/82/" target="_top">yuin</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2762/">#2762</a>(<script language="JavaScript">print_time(new Date("2007/08/31 18:51 GMT"));</script><noscript>2007/08/31 18:51 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #efffef;">1/1=1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>正規表現ないとこれはキツそうですね・・・

&lt;br&gt;がエスケープされるので&lt;brをリストにいれたほうがいいと思います。あとattrがasLowercaseされていないような。HREFが削除されてしまいます。

</pre>
	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2762/addtag/" class="addtag" id="addtag_2762">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #efffef;"
  >1/1=1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2762"
  >-</span><span
  class="button yellow"
  id="rating_z_2762"
  >0</span><span 
  class="button green"
  id="rating_p_2762"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2761/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2762/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2762/">
  返信
  </a>]
  </div>
</div>
</div>



  


    </div>
  


  

  

  
    




<div class="comment" id="comment2769"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/348/" target="_top">naoya_t</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2769/">#2769</a>(<script language="JavaScript">print_time(new Date("2007/09/01 15:56 GMT"));</script><noscript>2007/09/01 15:56 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/awk/">
	  awk
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>まあ普通こういう処理はawkではしませんが・・・

% awk -f filter.awk
&lt;script foo="&lt;script&gt;alert('bar')&lt;/script&gt;"&gt;alert('foo')&lt;/script&gt;
&amp;lt;script foo="&amp;lt;script&amp;gt;alert('bar')&amp;lt;/script&amp;gt;"&amp;gt;alert('foo')&amp;lt;/script&amp;gt;

&lt;script foo="&lt;a href='link'&gt;link&lt;/a&gt;"&gt;alert('foo')&lt;/script&gt;
&amp;lt;script foo="&amp;lt;a href='link'&amp;gt;link&amp;lt;/a&amp;gt;"&amp;gt;alert('foo')&amp;lt;/script&amp;gt;

&lt;a href='www.g&gt;oogle.com'&gt;link&lt;/a&gt;
&lt;a href="./www.g%3Eoogle.com"&gt;link&lt;/a&gt;

なお、タグの途中に改行が含まれるケースには対応していません。
</pre>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99</pre></td><td class="code"><div class="highlight"><pre>BEGIN {
	ok_tag[&quot;A&quot;] = ok_tag[&quot;BR&quot;] = ok_tag[&quot;STRONG&quot;] = 1
}

/&lt;[A-Za-z]+/ {
	delete attributes
	s = $0
	while (match(s,/&lt;[A-Za-z]+/)) {
		if (RSTART &gt; 1) print substr(s,1,RSTART-1)
		tag = substr(s,RSTART+1,RLENGTH-1)
		s = substr(s,RSTART+RLENGTH)
		if (s ~ /^&gt;/) {
			s = substr(s,2)
		} else {
			while (s != &quot;&quot;) {
				gsub(/^[ \t\r\n]*/,&quot;&quot;,s)
				if (match(s,/^[A-Za-z]+=/)) {
					attribute = substr(s,1,RLENGTH-1)
					s = substr(s,RLENGTH+1)
					if (match(s,/^(&quot;[^&quot;]*&quot;|&#39;[^&#39;]*&#39;|[^&quot;&#39;&gt; ]*)/)) {
						value = substr(s,1,RLENGTH)
						attributes[attribute] = value
						s = substr(s,RLENGTH+1)
					}
				} else if (s ~ /^&gt;/) {
					s = substr(s,2)
					break
				} else {
					break
				}
			}
		}

		tag_ = toupper(tag)
		if (ok_tag[tag_]) {
			if (tag_ == &quot;A&quot;) {
				for (attr in attributes)
					if (toupper(attr) !~ /^(HREF|NAME)$/) delete attributes[attr]
			} else { #if (tag ~ /^(BR|STRONG)$/)
				delete attributes
			}
			printf(&quot;&lt;%s&quot;, tag)
			for (attr in attributes) {
				value = urlencode(attributes[attr])
				gsub(/(^[&quot;&#39;]|[&quot;&#39;]$)/,&quot;&quot;,value)
				if (toupper(attr) == &quot;HREF&quot;) {
					printf(&quot; %s=\&quot;./%s\&quot;&quot;, attr, value)
				} else {
					printf(&quot; %s=\&quot;%s\&quot;&quot;, attr, value)
				}
			}
			printf(&quot;&gt;&quot;)
		} else {
			printf(&quot;&amp;lt;%s&quot;, tag) # substr(s,RSTART+RLENGTH)
			for (attr in attributes) {
				printf(&quot; %s=%s&quot;, attr, escape(attributes[attr]))
			}
			printf(&quot;&amp;gt;&quot;)
		}
	}
	
	if (match(s,/&lt;\/[A-Za-z]+&gt;/)) {
		content = substr(s,1,RSTART-1)
		close_tag = substr(s,RSTART+2,RLENGTH-3)
		
		s = substr(s,RSTART+RLENGTH)
		if (content != &quot;&quot;) printf(&quot;%s&quot;, escape(content))

		tag_ = toupper(close_tag)
		if (ok_tag[tag_]) {
			printf(&quot;&lt;/%s&gt;&quot;, close_tag)
		} else {
			printf(&quot;&amp;lt;/%s&amp;gt;&quot;, close_tag)
		}
	} else if (s != &quot;&quot;) {
		printf(&quot;%s&quot;, s)
	}

	printf &quot;\n&quot;
	next
}

{ print }

function escape(s)
{
	gsub(/&lt;/,&quot;\\&amp;lt;&quot;,s)
	gsub(/&gt;/,&quot;\\&amp;gt;&quot;,s)
	return s
}

function urlencode(s)
{
#	gsub(/ /,&quot;%20&quot;,s)
	gsub(/&lt;/,&quot;%3C&quot;,s)
#	gsub(/=/,&quot;%3D&quot;,s)
	gsub(/&gt;/,&quot;%3E&quot;,s)
	return s
}
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2769/addtag/" class="addtag" id="addtag_2769">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/awk/">
		awk
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2769/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2769/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2769"
  >-</span><span
  class="button yellow"
  id="rating_z_2769"
  >0</span><span 
  class="button green"
  id="rating_p_2769"
  >+</span></span></span>
  
<p>

  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2769/">
  返信
  </a>]
  </div>
</div>
</div>



  


  

  
    




<div class="comment" id="comment2704"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/101/" target="_top">沢渡 みかげ</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2704/">#2704</a>(<script language="JavaScript">print_time(new Date("2007/08/31 01:06 GMT"));</script><noscript>2007/08/31 01:06 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/perl/">
	  Perl
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #dfffdf;">2/2=1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>TripletaiL フレームワークには一部のタグだけを許可する機能があります．
ただ，題意のサンプルのように，属性値を '' で括った場合は
うまく対応できないので，そこを変更しています．

また，閉じタグの自動修復機能が少しバグっていたので
以下のパッチを当てて実行しています．

--- lib/Tripletail/TagCheck.pm  27 Jun 2007 03:01:50 -0000      1.15
+++ lib/Tripletail/TagCheck.pm  31 Aug 2007 01:03:31 -0000
@@ -253,7 +253,9 @@
                                }

                                # スタックにプッシュ
-                               push @$open_stack, $elem;
+                               if(!$taginfo-&gt;mustBeEmpty) {
+                                       push @$open_stack, $elem;
+                               }
                        }
                }
        }

----
実行結果
&lt;&lt;&lt;&lt;

&lt;a href="www.google.com"&gt;link&lt;/a&gt; &lt;blink&gt;and&lt;/blink&gt;
&lt;strong onClick='alert("NG")'&gt;click&lt;br&gt;me!&lt;/strong&gt;
&gt;&gt;&gt;&gt;

&lt;a href="www.google.com"&gt;link&lt;/a&gt; &amp;lt;blink&amp;gt;and&amp;lt;/blink&amp;gt;
&lt;strong&gt;click&lt;br&gt;me!&lt;/strong&gt;
</pre>
	</div>
	
	<p class="link">
	  参考: <a href="/web/20100821161904/http://tripletail.jp/dl/latest/doc/Tripletail/TagCheck.html">TripletaiL TagCheck のマニュアル</a>
	</p>  
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></td><td class="code"><div class="highlight"><pre><span class="c1">#!/usr/bin/perl</span>

<span class="k">use</span> <span class="n">Tripletail</span> <span class="sx">qw(/dev/null)</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$input</span> <span class="o">=</span> <span class="sx">q{</span>
<span class="sx">&lt;a href=&quot;www.google.com&quot;&gt;link&lt;/a&gt; &lt;blink&gt;and&lt;/blink&gt;</span>
<span class="sx">&lt;strong onClick=&#39;alert(&quot;NG&quot;)&#39;&gt;click&lt;br&gt;me!&lt;/strong&gt;</span>
<span class="sx">}</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$tc</span> <span class="o">=</span> <span class="nv">$TL</span><span class="o">-&gt;</span><span class="n">newTagCheck</span><span class="p">;</span>
<span class="nv">$tc</span><span class="o">-&gt;</span><span class="n">setATarget</span><span class="p">(</span><span class="nb">undef</span><span class="p">);</span>
<span class="nv">$tc</span><span class="o">-&gt;</span><span class="n">setAllowTag</span><span class="p">(</span><span class="s">&#39;:BR;A(HREF,NAME);STRONG()&#39;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$output</span> <span class="o">=</span> <span class="nv">$tc</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">(</span><span class="nv">$input</span><span class="p">);</span>

<span class="k">print</span> <span class="s">&quot;&lt;&lt;&lt;&lt;\n&quot;</span><span class="p">;</span>
<span class="k">print</span> <span class="nv">$input</span><span class="p">;</span>
<span class="k">print</span> <span class="s">&quot;&gt;&gt;&gt;&gt;\n&quot;</span><span class="p">;</span>
<span class="k">print</span> <span class="nv">$output</span><span class="p">;</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2704/addtag/" class="addtag" id="addtag_2704">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/perl/">
		Perl
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2704/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2704/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #dfffdf;"
  >2/2=1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2704"
  >-</span><span
  class="button yellow"
  id="rating_z_2704"
  >0</span><span 
  class="button green"
  id="rating_p_2704"
  >+</span></span></span>
  
<p>

  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2704/">
  返信
  </a>]
  </div>
</div>
</div>



  


  

  

  
    




<div class="comment" id="comment2725"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/130/" target="_top">rucker</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2725/">#2725</a>(<script language="JavaScript">print_time(new Date("2007/08/31 06:39 GMT"));</script><noscript>2007/08/31 06:39 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/php/">
	  PHP
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>br以外の通したタグの閉じ忘れにも対応してみた。
(閉じる順番が間違ってる場合は今回は大目に見るとして。)</pre>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">safehtml</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="nv">$r</span><span class="o">=</span><span class="k">array</span><span class="p">();</span>
	<span class="nv">$tags</span><span class="o">=</span><span class="k">array</span><span class="p">();</span>
	<span class="nv">$offs</span><span class="o">=</span><span class="m">0</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="nf">preg_match</span><span class="p">(</span><span class="s1">&#39;!&lt;\s*(/|)\s*(([^&gt;\&#39;&quot;]+|\&#39;[^\&#39;]*\&#39;|&quot;[^&quot;]*&quot;)*)&gt;!&#39;</span><span class="p">,</span><span class="nv">$str</span><span class="p">,</span><span class="nv">$m1</span><span class="p">,</span><span class="nx">PREG_OFFSET_CAPTURE</span><span class="p">,</span><span class="nv">$offs</span><span class="p">))</span>
	<span class="p">{</span>	<span class="nv">$r</span><span class="p">[]</span><span class="o">=</span><span class="nf">substr</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span><span class="nv">$offs</span><span class="p">,</span><span class="nv">$m1</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="m">1</span><span class="p">]</span><span class="o">-</span><span class="nv">$offs</span><span class="p">);</span>
		<span class="nv">$offs</span><span class="o">=</span><span class="nv">$m1</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="m">1</span><span class="p">]</span><span class="o">+</span><span class="nf">strlen</span><span class="p">(</span><span class="nv">$m1</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="m">0</span><span class="p">]);</span>
		<span class="nf">preg_match_all</span><span class="p">(</span><span class="s1">&#39;!([a-z0-9_]+)(\s*=\s*(&quot;[^&quot;]*&quot;|\&#39;[^\&#39;]*\&#39;|[^\s]+)|)!im&#39;</span><span class="p">,</span><span class="nv">$m1</span><span class="p">[</span><span class="m">2</span><span class="p">][</span><span class="m">0</span><span class="p">],</span><span class="nv">$m2</span><span class="p">,</span><span class="nx">PREG_SET_ORDER</span><span class="p">);</span>
		<span class="k">switch</span><span class="p">(</span><span class="nf">strtolower</span><span class="p">(</span><span class="nv">$m2</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="m">1</span><span class="p">]))</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="s1">&#39;a&#39;</span><span class="o">:</span>
		<span class="k">case</span> <span class="s1">&#39;strong&#39;</span><span class="o">:</span>
			<span class="k">if</span><span class="p">(</span><span class="nv">$m1</span><span class="p">[</span><span class="m">1</span><span class="p">][</span><span class="m">0</span><span class="p">])</span>
			<span class="p">{</span>	<span class="k">if</span><span class="p">((</span><span class="nv">$i</span><span class="o">=</span><span class="nf">array_search</span><span class="p">(</span><span class="nv">$m2</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="m">1</span><span class="p">],</span><span class="nv">$tags</span><span class="p">))</span><span class="o">!==</span><span class="k">false</span><span class="p">)</span>
					<span class="nf">unset</span><span class="p">(</span><span class="nv">$tags</span><span class="p">[</span><span class="nv">$i</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="nf">array_unshift</span><span class="p">(</span><span class="nv">$tags</span><span class="p">,</span><span class="nv">$m2</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="m">1</span><span class="p">]);</span>
			<span class="nv">$t</span><span class="o">=</span><span class="k">array</span><span class="p">(</span><span class="nv">$m1</span><span class="p">[</span><span class="m">1</span><span class="p">][</span><span class="m">0</span><span class="p">]</span><span class="o">.</span><span class="nv">$m2</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="m">1</span><span class="p">]);</span>
			<span class="k">if</span><span class="p">(</span><span class="nf">strtolower</span><span class="p">(</span><span class="nv">$m2</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="m">1</span><span class="p">])</span><span class="o">==</span><span class="s1">&#39;a&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$m1</span><span class="p">[</span><span class="m">1</span><span class="p">][</span><span class="m">0</span><span class="p">])</span>
			<span class="p">{</span>	<span class="nf">array_shift</span><span class="p">(</span><span class="nv">$m2</span><span class="p">);</span>
				<span class="k">while</span><span class="p">(</span><span class="nv">$param</span><span class="o">=</span><span class="nf">array_shift</span><span class="p">(</span><span class="nv">$m2</span><span class="p">))</span>
				<span class="p">{</span>	<span class="k">switch</span><span class="p">(</span><span class="nf">strtolower</span><span class="p">(</span><span class="nv">$param</span><span class="p">[</span><span class="m">1</span><span class="p">]))</span>
					<span class="p">{</span>
					<span class="k">case</span> <span class="s1">&#39;href&#39;</span><span class="o">:</span>
					<span class="k">case</span> <span class="s1">&#39;name&#39;</span><span class="o">:</span>
						<span class="nv">$t</span><span class="p">[]</span><span class="o">=</span><span class="nv">$param</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="nv">$r</span><span class="p">[]</span><span class="o">=</span><span class="s1">&#39;&lt;&#39;</span><span class="o">.</span><span class="nf">implode</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="nv">$t</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;&gt;&#39;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="s1">&#39;br&#39;</span><span class="o">:</span>
			<span class="nv">$r</span><span class="p">[]</span><span class="o">=</span><span class="s1">&#39;&lt;br/&gt;&#39;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">default</span><span class="o">:</span>
			<span class="nv">$r</span><span class="p">[]</span><span class="o">=</span><span class="s1">&#39;&amp;lt;&#39;</span><span class="o">.</span><span class="nv">$m1</span><span class="p">[</span><span class="m">1</span><span class="p">][</span><span class="m">0</span><span class="p">]</span><span class="o">.</span><span class="nv">$m1</span><span class="p">[</span><span class="m">2</span><span class="p">][</span><span class="m">0</span><span class="p">]</span><span class="o">.</span><span class="s1">&#39;&amp;gt;&#39;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nv">$r</span><span class="p">[]</span><span class="o">=</span><span class="nf">substr</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span><span class="nv">$offs</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="nv">$tag</span><span class="o">=</span><span class="nf">array_shift</span><span class="p">(</span><span class="nv">$tags</span><span class="p">))</span> <span class="c">// 閉じわすれタグを閉じる</span>
		<span class="nv">$r</span><span class="p">[]</span><span class="o">=</span><span class="s2">&quot;&lt;/</span><span class="si">$tag</span><span class="s2">&gt;&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="nf">implode</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="nv">$r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">echo</span> <span class="nx">safehtml</span><span class="p">(</span><span class="s">&lt;&lt;&lt;EOT</span>
<span class="s">&lt;a href=&#39;www.google.com&#39; target=_blank&gt;link&lt;/a&gt; &lt;blink&gt;and&lt;/blink&gt; &lt;strong onClick=&#39;alert(&quot;NG&quot;)&#39;&gt;click&lt;br/&gt;me!&lt;/strong&gt;</span>
<span class="s">EOT</span>
<span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2725/addtag/" class="addtag" id="addtag_2725">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/php/">
		PHP
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2725/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2725/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2725"
  >-</span><span
  class="button yellow"
  id="rating_z_2725"
  >0</span><span 
  class="button green"
  id="rating_p_2725"
  >+</span></span></span>
  
<p>

  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2725/">
    2
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2725/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2736"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/130/" target="_top">rucker</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2736/">#2736</a>(<script language="JavaScript">print_time(new Date("2007/08/31 07:54 GMT"));</script><noscript>2007/08/31 07:54 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/php/">
	  PHP
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>#2727の指摘に対応。
タグの大文字小文字の問題修正と通すタグに関する情報をまとめて汎用化してみた。
タグは開いたのと逆順に閉じることを強制する。</pre>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51</pre></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">safehtml</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="nv">$safetag</span><span class="o">=</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">=&gt;</span><span class="k">array</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">)),</span><span class="s1">&#39;strong&#39;</span><span class="o">=&gt;</span><span class="k">array</span><span class="p">(</span><span class="m">1</span><span class="p">),</span><span class="s1">&#39;br&#39;</span><span class="o">=&gt;</span><span class="k">array</span><span class="p">(</span><span class="m">0</span><span class="p">));</span>
	<span class="nv">$r</span><span class="o">=</span><span class="k">array</span><span class="p">();</span>
	<span class="nv">$tags</span><span class="o">=</span><span class="k">array</span><span class="p">();</span>
	<span class="nv">$offs</span><span class="o">=</span><span class="m">0</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="nf">preg_match</span><span class="p">(</span><span class="s1">&#39;!&lt;(\s*(/|)\s*(([^&gt;\&#39;&quot;/]+|\&#39;[^\&#39;]*\&#39;|&quot;[^&quot;]*&quot;)*)(/|)\s*)&gt;!&#39;</span><span class="p">,</span><span class="nv">$str</span><span class="p">,</span><span class="nv">$m1</span><span class="p">,</span><span class="nx">PREG_OFFSET_CAPTURE</span><span class="p">,</span><span class="nv">$offs</span><span class="p">))</span>
	<span class="p">{</span>	<span class="nv">$r</span><span class="p">[]</span><span class="o">=</span><span class="nf">substr</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span><span class="nv">$offs</span><span class="p">,</span><span class="nv">$m1</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="m">1</span><span class="p">]</span><span class="o">-</span><span class="nv">$offs</span><span class="p">);</span>
		<span class="nv">$offs</span><span class="o">=</span><span class="nv">$m1</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="m">1</span><span class="p">]</span><span class="o">+</span><span class="nf">strlen</span><span class="p">(</span><span class="nv">$m1</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="m">0</span><span class="p">]);</span>
		<span class="nf">preg_match_all</span><span class="p">(</span><span class="s1">&#39;!([^\s\&#39;&quot;=]+)(\s*=\s*(&quot;[^&quot;]*&quot;|\&#39;[^\&#39;]*\&#39;|[^\s]+)|)!im&#39;</span><span class="p">,</span><span class="nv">$m1</span><span class="p">[</span><span class="m">3</span><span class="p">][</span><span class="m">0</span><span class="p">],</span><span class="nv">$m2</span><span class="p">,</span><span class="nx">PREG_SET_ORDER</span><span class="p">);</span>
		<span class="nv">$tag</span><span class="o">=</span><span class="nf">strtolower</span><span class="p">(</span><span class="nv">$m2</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="m">1</span><span class="p">]);</span>
		<span class="k">if</span><span class="p">(</span><span class="nf">isset</span><span class="p">(</span><span class="nv">$safetag</span><span class="p">[</span><span class="nv">$tag</span><span class="p">]))</span>
		<span class="p">{</span>	<span class="k">if</span><span class="p">(</span><span class="nv">$safetag</span><span class="p">[</span><span class="nv">$tag</span><span class="p">][</span><span class="m">0</span><span class="p">]</span><span class="o">&amp;</span><span class="m">1</span><span class="p">)</span>
			<span class="p">{</span>	<span class="k">if</span><span class="p">(</span><span class="nv">$m1</span><span class="p">[</span><span class="m">2</span><span class="p">][</span><span class="m">0</span><span class="p">])</span>
				<span class="p">{</span>	<span class="k">if</span><span class="p">(</span><span class="nf">array_search</span><span class="p">(</span><span class="nv">$tag</span><span class="p">,</span><span class="nv">$tags</span><span class="p">)</span><span class="o">===</span><span class="k">false</span><span class="p">)</span>
						<span class="k">continue</span><span class="p">;</span> <span class="c">// 開いてないタグは閉じない</span>
					<span class="k">while</span><span class="p">((</span><span class="nv">$t</span><span class="o">=</span><span class="nf">array_shift</span><span class="p">(</span><span class="nv">$tags</span><span class="p">)))</span> <span class="c">// 開いたのと逆順に閉じる</span>
					<span class="p">{</span>	<span class="nv">$r</span><span class="p">[]</span><span class="o">=</span><span class="s2">&quot;&lt;/</span><span class="si">$t</span><span class="s2">&gt;&quot;</span><span class="p">;</span>
						<span class="k">if</span><span class="p">(</span><span class="nv">$t</span><span class="o">==</span><span class="nv">$tag</span><span class="p">)</span>
							<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$m1</span><span class="p">[</span><span class="m">5</span><span class="p">][</span><span class="m">0</span><span class="p">])</span>
					<span class="nf">array_unshift</span><span class="p">(</span><span class="nv">$tags</span><span class="p">,</span><span class="nv">$tag</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="nv">$t</span><span class="o">=</span><span class="k">array</span><span class="p">(</span><span class="nv">$tag</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="nf">isset</span><span class="p">(</span><span class="nv">$safetag</span><span class="p">[</span><span class="nv">$tag</span><span class="p">][</span><span class="m">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$m1</span><span class="p">[</span><span class="m">2</span><span class="p">][</span><span class="m">0</span><span class="p">])</span>
			<span class="p">{</span>	<span class="nf">array_shift</span><span class="p">(</span><span class="nv">$m2</span><span class="p">);</span>
				<span class="k">while</span><span class="p">(</span><span class="nv">$param</span><span class="o">=</span><span class="nf">array_shift</span><span class="p">(</span><span class="nv">$m2</span><span class="p">))</span>
				<span class="p">{</span>	<span class="k">if</span><span class="p">(</span><span class="nf">array_search</span><span class="p">(</span><span class="nf">strtolower</span><span class="p">(</span><span class="nv">$param</span><span class="p">[</span><span class="m">1</span><span class="p">]),</span><span class="nv">$safetag</span><span class="p">[</span><span class="nv">$tag</span><span class="p">][</span><span class="m">1</span><span class="p">])</span><span class="o">!==</span><span class="k">false</span><span class="p">)</span>
						<span class="nv">$t</span><span class="p">[]</span><span class="o">=</span><span class="nv">$param</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="nv">$r</span><span class="p">[]</span><span class="o">=</span><span class="s1">&#39;&lt;&#39;</span><span class="o">.</span><span class="nv">$m1</span><span class="p">[</span><span class="m">2</span><span class="p">][</span><span class="m">0</span><span class="p">]</span><span class="o">.</span><span class="nf">implode</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="nv">$t</span><span class="p">)</span><span class="o">.</span><span class="nv">$m1</span><span class="p">[</span><span class="m">5</span><span class="p">][</span><span class="m">0</span><span class="p">]</span><span class="o">.</span><span class="s1">&#39;&gt;&#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="nv">$r</span><span class="p">[]</span><span class="o">=</span><span class="nf">str_replace</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span><span class="s1">&#39;&gt;&#39;</span><span class="p">),</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;&amp;lt;&#39;</span><span class="p">,</span><span class="s1">&#39;&amp;gt;&#39;</span><span class="p">),</span><span class="nv">$m1</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="m">0</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="nv">$r</span><span class="p">[]</span><span class="o">=</span><span class="nf">substr</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span><span class="nv">$offs</span><span class="p">);</span>
	<span class="k">while</span><span class="p">((</span><span class="nv">$tag</span><span class="o">=</span><span class="nf">array_shift</span><span class="p">(</span><span class="nv">$tags</span><span class="p">)))</span> <span class="c">// 閉じわすれタグを閉じる</span>
		<span class="nv">$r</span><span class="p">[]</span><span class="o">=</span><span class="s2">&quot;&lt;/</span><span class="si">$tag</span><span class="s2">&gt;&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="nf">implode</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="nv">$r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">echo</span> <span class="nx">safehtml</span><span class="p">(</span><span class="s">&lt;&lt;&lt;EOT</span>
<span class="s">&lt;a href=&#39;www.google.com&#39; target=_blank&gt;link&lt;/a&gt; &lt;blink dummy=&#39;&lt;&#39;&gt;and&lt;/blink&gt; &lt;strong onClick=&#39;alert(&quot;NG&quot;)&#39;&gt;click&lt;br/&gt;me!&lt;/strong&gt; &lt;z foo=&#39;&lt;script&gt;alert(&quot;Boo&quot;)&lt;/script&gt;&#39;&gt;</span>
<span class="s">EOT</span>
<span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2736/addtag/" class="addtag" id="addtag_2736">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/php/">
		PHP
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2736/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2736/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2736"
  >-</span><span
  class="button yellow"
  id="rating_z_2736"
  >0</span><span 
  class="button green"
  id="rating_p_2736"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2725/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2736/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2736/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2736/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2737"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/130/" target="_top">rucker</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2737/">#2737</a>(<script language="JavaScript">print_time(new Date("2007/08/31 08:05 GMT"));</script><noscript>2007/08/31 08:05 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>そういえば
  &lt;z foo='&lt;a href='www.google.com'&gt;link&lt;/a&gt;'&gt;
みたいなのは全部エスケープしちゃいますけどそれでいいですよね…</pre>
	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2737/addtag/" class="addtag" id="addtag_2737">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2737"
  >-</span><span
  class="button yellow"
  id="rating_z_2737"
  >0</span><span 
  class="button green"
  id="rating_p_2737"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2736/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2737/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2737/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2737/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2743"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/1/" target="_top">にしお</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2743/">#2743</a>(<script language="JavaScript">print_time(new Date("2007/08/31 09:38 GMT"));</script><noscript>2007/08/31 09:38 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>はい。
お題に追記してみました。</pre>
	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2743/addtag/" class="addtag" id="addtag_2743">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2743"
  >-</span><span
  class="button yellow"
  id="rating_z_2743"
  >0</span><span 
  class="button green"
  id="rating_p_2743"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2737/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2743/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2743/">
  返信
  </a>]
  </div>
</div>
</div>



  


    </div>
  


    </div>
  


    </div>
  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2729"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/130/" target="_top">rucker</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2729/">#2729</a>(<script language="JavaScript">print_time(new Date("2007/08/31 06:58 GMT"));</script><noscript>2007/08/31 06:58 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>あ、いけね。開いたタグと閉じたタグで大文字小文字が合ってないと閉じ忘れ扱いになってしまう。
かさばるので修正版は続編のときに…。</pre>
	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2729/addtag/" class="addtag" id="addtag_2729">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2729"
  >-</span><span
  class="button yellow"
  id="rating_z_2729"
  >0</span><span 
  class="button green"
  id="rating_p_2729"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2725/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2729/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2729/">
  返信
  </a>]
  </div>
</div>
</div>



  


    </div>
  


  

  
    




<div class="comment" id="comment2753"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/4/" target="_top">匿名</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2753/">#2753</a>(<script language="JavaScript">print_time(new Date("2007/08/31 12:43 GMT"));</script><noscript>2007/08/31 12:43 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>些細な突っ込みですが…
HTMLだとするとサンプルあった“&lt;br/&gt;”は“&amp;lt;br/&gt;”にしなきゃいけないんじゃないんでしょうか？
無論“&lt;br&gt;”は“&lt;br&gt;”として</pre>
	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2753/addtag/" class="addtag" id="addtag_2753">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2753"
  >-</span><span
  class="button yellow"
  id="rating_z_2753"
  >0</span><span 
  class="button green"
  id="rating_p_2753"
  >+</span></span></span>
  
<p>

  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2753/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2753/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2756"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/1/" target="_top">にしお</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2756/">#2756</a>(<script language="JavaScript">print_time(new Date("2007/08/31 13:25 GMT"));</script><noscript>2007/08/31 13:25 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  
<p>うむむ。「一部の属性を生かす必要があるタグ」「閉じタグのあるタグ」「閉じタグのないタグ」という選定のつもりでしたが、確かに&lt;br/&gt;がエスケープされるべきかどうか明言しておいた方がよかったですね。今回はどちらの解答でも題意を満たしているものとします。
</p>
<p>「日記サービスでユーザに一部のHTMLを許可する」というユースケースをイメージして作ったお題なので、続編からは「&lt;br/&gt;も&lt;br&gt;も両方許容せよ」というようになると思います。
</p>



	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2756/addtag/" class="addtag" id="addtag_2756">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2756"
  >-</span><span
  class="button yellow"
  id="rating_z_2756"
  >0</span><span 
  class="button green"
  id="rating_p_2756"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2753/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2756/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2756/">
  返信
  </a>]
  </div>
</div>
</div>



  


    </div>
  


  

  
    




<div class="comment" id="comment3638"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/481/" target="_top">mtsuyugu</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/3638/">#3638</a>(<script language="JavaScript">print_time(new Date("2007/10/31 16:10 GMT"));</script><noscript>2007/10/31 16:10 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/c/">
	  C
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>ごり押しですが、strncasecmp に救われた気がします。</pre>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72</pre></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>

<span class="cp">#define BUFSIZE 1024</span>
<span class="kt">char</span> <span class="n">in</span><span class="p">[</span><span class="n">BUFSIZE</span><span class="p">];</span>


<span class="kt">int</span> <span class="n">main</span><span class="p">(</span> <span class="kt">void</span> <span class="p">){</span>

   <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
   <span class="kt">char</span> <span class="n">q</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="sc">&#39;&lt;&#39;</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">len</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">remain</span><span class="p">;</span>

   <span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">remain</span> <span class="o">=</span> <span class="n">fgets</span><span class="p">(</span> <span class="n">in</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">BUFSIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="n">stdin</span> <span class="p">))</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">in</span><span class="p">;</span><span class="o">*</span><span class="n">p</span><span class="p">;</span><span class="n">p</span><span class="o">++</span><span class="p">){</span>
         <span class="k">if</span><span class="p">(</span> <span class="n">remain</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span> <span class="n">p</span> <span class="p">))</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;&lt;string&quot;</span><span class="p">)</span> <span class="p">){</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">len</span> <span class="p">);</span>
            <span class="n">strcpy</span><span class="p">(</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">p</span> <span class="p">);</span>
            <span class="n">strcpy</span><span class="p">(</span> <span class="n">in</span><span class="p">,</span> <span class="n">tmp</span> <span class="p">);</span>
            <span class="n">free</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">if</span><span class="p">(</span> <span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;&lt;&#39;</span> <span class="p">){</span>
            <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;&gt;&#39;</span> <span class="p">){</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;&amp;gt;&quot;</span><span class="p">);</span> <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;&quot;&#39;</span> <span class="p">){</span> <span class="n">putchar</span><span class="p">(</span><span class="n">s</span><span class="o">=*</span><span class="n">p</span><span class="p">);</span> <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;&lt;&#39;</span> <span class="p">){</span> <span class="n">putchar</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span> <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">strncasecmp</span><span class="p">(</span> <span class="n">p</span><span class="p">,</span> <span class="s">&quot;&lt;/a&gt;&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="p">){</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;&lt;/a&gt;&quot;</span><span class="p">),</span> <span class="n">attr</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">p</span><span class="o">+=</span><span class="mi">3</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">strncasecmp</span><span class="p">(</span> <span class="n">p</span><span class="p">,</span> <span class="s">&quot;&lt;br&quot;</span><span class="p">,</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">){</span>
               <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;&gt;&#39;</span> <span class="p">){</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;&lt;br&gt;&quot;</span><span class="p">);</span> <span class="n">p</span><span class="o">+=</span><span class="mi">3</span><span class="p">;</span> <span class="p">}</span>
               <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span> <span class="p">){</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;&lt;br&quot;</span><span class="p">);</span>  <span class="n">p</span><span class="o">+=</span><span class="mi">3</span><span class="p">;</span> <span class="n">s</span><span class="o">=</span><span class="sc">&#39;&gt;&#39;</span><span class="p">;</span> <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">strncasecmp</span><span class="p">(</span> <span class="n">p</span><span class="p">,</span> <span class="s">&quot;&lt;strong&quot;</span><span class="p">,</span> <span class="mi">7</span> <span class="p">)</span> <span class="p">){</span>
               <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;&gt;&#39;</span> <span class="p">){</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;&lt;strong&gt;&quot;</span><span class="p">);</span> <span class="n">p</span><span class="o">+=</span><span class="mi">7</span><span class="p">;</span> <span class="p">}</span>
               <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span> <span class="p">){</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;&lt;strong&quot;</span><span class="p">);</span>  <span class="n">p</span><span class="o">+=</span><span class="mi">7</span><span class="p">;</span> <span class="n">s</span><span class="o">=</span><span class="sc">&#39;&gt;&#39;</span><span class="p">;</span> <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">strncasecmp</span><span class="p">(</span> <span class="n">p</span><span class="p">,</span> <span class="s">&quot;&lt;a&quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">){</span>
               <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;&gt;&#39;</span> <span class="p">){</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;&lt;a&gt;&quot;</span><span class="p">);</span> <span class="n">p</span><span class="o">+=</span><span class="mi">2</span><span class="p">;</span> <span class="p">}</span>
               <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span> <span class="p">){</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;&lt;a&quot;</span><span class="p">);</span>  <span class="n">p</span><span class="o">+=</span><span class="mi">2</span><span class="p">;</span> <span class="n">s</span><span class="o">=</span><span class="sc">&#39;@&#39;</span><span class="p">;</span> <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span><span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;&amp;lt;&quot;</span><span class="p">);</span> <span class="p">}</span>
         <span class="p">}</span>
         <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;&gt;&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;&gt;&#39;</span> <span class="p">){</span> <span class="n">putchar</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span> <span class="n">s</span><span class="o">=</span><span class="sc">&#39;&lt;&#39;</span><span class="p">;</span> <span class="p">}</span>
         <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;@&#39;</span> <span class="p">){</span>
            <span class="n">q</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">5</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;&gt;&#39;</span> <span class="p">){</span> <span class="n">putchar</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span> <span class="n">s</span><span class="o">=</span><span class="sc">&#39;&lt;&#39;</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">strncasecmp</span><span class="p">(</span> <span class="n">p</span><span class="p">,</span> <span class="s">&quot;href=&quot;</span><span class="p">,</span> <span class="mi">5</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">||</span> <span class="n">q</span> <span class="o">==</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">)</span> <span class="p">){</span>
               <span class="n">printf</span><span class="p">(</span><span class="s">&quot; href=%c&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">q</span> <span class="p">);</span> <span class="n">p</span><span class="o">+=</span><span class="mi">6</span><span class="p">;</span> <span class="n">attr</span><span class="o">=</span><span class="sc">&#39;h&#39;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">strncasecmp</span><span class="p">(</span> <span class="n">p</span><span class="p">,</span> <span class="s">&quot;name=&quot;</span><span class="p">,</span> <span class="mi">5</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">||</span> <span class="n">q</span> <span class="o">==</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">)</span> <span class="p">){</span>
               <span class="n">printf</span><span class="p">(</span><span class="s">&quot; name=%c&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">q</span> <span class="p">);</span> <span class="n">p</span><span class="o">+=</span><span class="mi">6</span><span class="p">;</span> <span class="n">attr</span><span class="o">=</span><span class="sc">&#39;n&#39;</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;&quot;&#39;</span> <span class="o">||</span> <span class="n">s</span> <span class="o">==</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="p">){</span>
            <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">attr</span> <span class="p">){</span>
               <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;&lt;&#39;</span> <span class="p">){</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;&amp;lt;&quot;</span><span class="p">);</span> <span class="p">}</span>
               <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;&gt;&#39;</span> <span class="p">){</span>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;&amp;gt;&quot;</span><span class="p">);</span> <span class="p">}</span>
               <span class="k">else</span><span class="p">{</span> <span class="n">putchar</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span> <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span><span class="p">{</span>
               <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="n">s</span> <span class="p">){</span> <span class="n">putchar</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="n">s</span><span class="o">=</span><span class="sc">&#39;@&#39;</span><span class="p">;</span> <span class="p">}</span>
               <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">s</span> <span class="p">){</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">%c&quot;</span><span class="p">,</span><span class="n">s</span><span class="p">),</span> <span class="n">p</span><span class="o">+=</span><span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
               <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">attr</span><span class="o">==</span><span class="sc">&#39;h&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="s">&quot;!#$%&#39;=|^</span><span class="se">\\</span><span class="s">[]`{}+&lt;&gt;&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span> <span class="p">))</span> <span class="p">){</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%%%X&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">);</span> <span class="p">}</span>
               <span class="k">else</span><span class="p">{</span> <span class="n">putchar</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span> <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/3638/addtag/" class="addtag" id="addtag_3638">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/c/">
		C
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/3638/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/3638/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_3638"
  >-</span><span
  class="button yellow"
  id="rating_z_3638"
  >0</span><span 
  class="button green"
  id="rating_p_3638"
  >+</span></span></span>
  
<p>

  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/3638/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/3638/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment3651"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/481/" target="_top">mtsuyugu</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/3651/">#3651</a>(<script language="JavaScript">print_time(new Date("2007/11/01 14:52 GMT"));</script><noscript>2007/11/01 14:52 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  無効なタグの引用符で囲まれた部分の扱いなどにバグがありましたので、続きの問題への投稿 #3650 で修正しています。
	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/3651/addtag/" class="addtag" id="addtag_3651">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_3651"
  >-</span><span
  class="button yellow"
  id="rating_z_3651"
  >0</span><span 
  class="button green"
  id="rating_p_3651"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/3638/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/3651/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/3651/">
  返信
  </a>]
  </div>
</div>
</div>



  


    </div>
  


  

  

  
    




<div class="comment" id="comment2733"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/343/" target="_top">shimakuma</a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2733/">#2733</a>(<script language="JavaScript">print_time(new Date("2007/08/31 07:48 GMT"));</script><noscript>2007/08/31 07:48 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/javascript/">
	  JavaScript
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffefef;">-1/1=-1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  &nbsp;DOM&nbsp;を使った方がより&nbsp;JavaScript&nbsp;らしいのかもしれないが…。<br/>
<br/>
javascript:document.body.innerHTML=(function(s,r,x){r=/\b(?:name|href)&nbsp;*=&nbsp;*(?:".*?"|'.*?'|[^&nbsp;&gt;]*)/gi;x=/^\/?(a)|br|strong\b/i;return&nbsp;s.replace(/&lt;([^&nbsp;&gt;]+&nbsp;?)((?:".*?"|'.*?'|[^\/&gt;])*)/g,function(m,t,a){return&nbsp;x.test(t)?'&lt;'+t+(RegExp.$1&amp;&amp;(m=a.match(r))?m.join('&nbsp;'):''):'&amp;lt;'+t+a})})(document.body.innerHTML)


	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre>1
2
3
4
5
6
7
8</pre></td><td class="code"><div class="highlight"><pre><span class="k">function</span> <span class="nx">doukaku54</span><span class="p">(</span><span class="nx">s</span><span class="p">){</span>
  <span class="k">var</span> <span class="nx">rx_nh</span> <span class="o">=</span> <span class="sr">/\b(?:name|href) *= *(?:&quot;.*?&quot;|&#39;.*?&#39;|[^ &gt;]*)/gi</span><span class="o">;</span>
  <span class="k">var</span> <span class="nx">rx_ok</span> <span class="o">=</span> <span class="sr">/^\/?(a)|br|strong\b/i</span><span class="o">,</span> <span class="nx">LT</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span><span class="o">,</span> <span class="nx">lt</span> <span class="o">=</span> <span class="s1">&#39;&amp;lt;&#39;</span><span class="o">,</span> <span class="nx">sp</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">;</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;([^ &gt;]+ ?)((?:&quot;.*?&quot;|&#39;.*?&#39;|[^\/&gt;])*)/g</span><span class="o">,</span> <span class="k">function</span><span class="p">(</span><span class="nx">m</span><span class="o">,</span> <span class="nx">tag</span><span class="o">,</span> <span class="nx">ats</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">rx_ok</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">tag</span><span class="p">)</span>
      <span class="o">?</span> <span class="nx">LT</span> <span class="o">+</span> <span class="nx">tag</span> <span class="o">+</span> <span class="p">(</span><span class="nb">RegExp</span><span class="p">.</span><span class="nx">$1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">m</span> <span class="o">=</span> <span class="nx">ats</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">rx_nh</span><span class="p">))</span> <span class="o">?</span> <span class="nx">m</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">sp</span><span class="p">)</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
      <span class="o">:</span> <span class="nx">lt</span> <span class="o">+</span> <span class="nx">tag</span> <span class="o">+</span> <span class="nx">ats</span> <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2733/addtag/" class="addtag" id="addtag_2733">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/javascript/">
		JavaScript
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2733/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2733/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffefef;"
  >-1/1=-1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2733"
  >-</span><span
  class="button yellow"
  id="rating_z_2733"
  >0</span><span 
  class="button green"
  id="rating_p_2733"
  >+</span></span></span>
  
<p>

  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2733/">
    2
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2733/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2747"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/343/" target="_top">shimakuma</a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2747/">#2747</a>(<script language="JavaScript">print_time(new Date("2007/08/31 10:05 GMT"));</script><noscript>2007/08/31 10:05 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/javascript/">
	  JavaScript
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  &nbsp;色々と間違っていたのを修整。(要素中の&lt;&gt;にエスケープが要らないとは知らなんだ。)<br/>&nbsp;この程度の処理だと大して効果が無いようなので，文字列のキャッシュはやめにした。<br/><br/>javascript:with(document.body)(function(s,r,g,x){r=/\b(?:name|href)&nbsp;*=&nbsp;*(?:".*?"|'.*?'|[^&nbsp;&gt;]*)/gi;g=/&lt;/g;x=/^&lt;\/?(?:(a)|br|strong)\b/i;innerHTML=s.replace(/(&lt;[^&nbsp;&gt;]+&nbsp;?)((?:".*?"|'.*?'|[^&gt;])*?)(?=\/?&gt;)/g,function(m,t,a){return&nbsp;x.test(t)?t+(RegExp.$1&amp;&amp;(m=a.match(r))?m.join('&nbsp;'):''):m.replace(g,'&amp;lt;')})})(innerHTML)
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre>1
2
3
4
5
6
7
8</pre></td><td class="code"><div class="highlight"><pre><span class="k">function</span> <span class="nx">doukaku54</span><span class="p">(</span><span class="nx">s</span><span class="p">){</span>
  <span class="k">var</span> <span class="nx">rx_nh</span> <span class="o">=</span> <span class="sr">/\b(?:name|href) *= *(?:&quot;.*?&quot;|&#39;.*?&#39;|[^ &gt;]*)/gi</span><span class="o">,</span>
      <span class="nx">rx_ok</span> <span class="o">=</span> <span class="sr">/^&lt;\/?(?:(a)|br|strong)\b/i</span><span class="o">,</span> <span class="nx">rx_lt</span> <span class="o">=</span> <span class="sr">/&lt;/g</span><span class="o">;</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(&lt;[^ &gt;]+ ?)((?:&quot;.*?&quot;|&#39;.*?&#39;|[^&gt;])*?)(?=\/?&gt;)/g</span><span class="o">,</span> <span class="k">function</span><span class="p">(</span><span class="nx">m</span><span class="o">,</span> <span class="nx">tag</span><span class="o">,</span> <span class="nx">ats</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">rx_ok</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">tag</span><span class="p">)</span>
      <span class="o">?</span> <span class="nx">tag</span> <span class="o">+</span> <span class="p">(</span><span class="nb">RegExp</span><span class="p">.</span><span class="nx">$1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">m</span> <span class="o">=</span> <span class="nx">ats</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">rx_nh</span><span class="p">))</span> <span class="o">?</span> <span class="nx">m</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
      <span class="o">:</span> <span class="nx">m</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">rx_lt</span><span class="o">,</span> <span class="s1">&#39;&amp;lt;&#39;</span><span class="p">)</span> <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2747/addtag/" class="addtag" id="addtag_2747">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/javascript/">
		JavaScript
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2747/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2747/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2747"
  >-</span><span
  class="button yellow"
  id="rating_z_2747"
  >0</span><span 
  class="button green"
  id="rating_p_2747"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2733/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2747/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2747/">
  返信
  </a>]
  </div>
</div>
</div>



  


    </div>
  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2746"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/411/" target="_top">管理者</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2746/">#2746</a>(<script language="JavaScript">print_time(new Date("2007/08/31 10:00 GMT"));</script><noscript>2007/08/31 10:00 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>横に長く貫通しているのはpreを使っているせいなのかと思ったら、単に空白が間に入ってないから改行されないだけなんですねぇ。
とりあえずスクロールバーをつけてみました。</pre>
	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2746/addtag/" class="addtag" id="addtag_2746">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2746"
  >-</span><span
  class="button yellow"
  id="rating_z_2746"
  >0</span><span 
  class="button green"
  id="rating_p_2746"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2733/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2746/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2746/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2746/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2751"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/343/" target="_top">shimakuma</a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2751/">#2751</a>(<script language="JavaScript">print_time(new Date("2007/08/31 11:29 GMT"));</script><noscript>2007/08/31 11:29 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  &nbsp;ありゃ，すみません。Firefox&nbsp;だと突き抜けるんですね。
	</div>
	
	<p class="link">
	  参考: <a href="javascript:void(confirm(&#39;使うほうがいいのかな？&#39;))"> いっそこの欄を…</a>
	</p>  
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2751/addtag/" class="addtag" id="addtag_2751">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2751"
  >-</span><span
  class="button yellow"
  id="rating_z_2751"
  >0</span><span 
  class="button green"
  id="rating_p_2751"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2746/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2751/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2751/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2751/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2754"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/1/" target="_top">にしお</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2754/">#2754</a>(<script language="JavaScript">print_time(new Date("2007/08/31 13:01 GMT"));</script><noscript>2007/08/31 13:01 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>あ、なるほど、IEだと折り返されているんですねぇ…。
PREで囲っちゃうとFirefoxではOKになったけども
IEでは逆に突き抜けるように…うむむ。
とりあえずPREは外しておきます。</pre>
	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2754/addtag/" class="addtag" id="addtag_2754">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2754"
  >-</span><span
  class="button yellow"
  id="rating_z_2754"
  >0</span><span 
  class="button green"
  id="rating_p_2754"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2751/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2754/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2754/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2754/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2755"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/1/" target="_top">にしお</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2755/">#2755</a>(<script language="JavaScript">print_time(new Date("2007/08/31 13:12 GMT"));</script><noscript>2007/08/31 13:12 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>コードとコメント本文に対して下のスクリプトを適用するといいのかも…。</pre>
	</div>
	
	<p class="link">
	  参考: <a href="/web/20100821161904/http://caetla.oops.jp/blog2/archives/2005/09/27_1630.php">やむやむ: Firefoxで長いURLなんかを折り返してくれるJavaScript</a>
	</p>  
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2755/addtag/" class="addtag" id="addtag_2755">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2755"
  >-</span><span
  class="button yellow"
  id="rating_z_2755"
  >0</span><span 
  class="button green"
  id="rating_p_2755"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2754/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2755/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2755/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2755/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2891"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/1/" target="_top">にしお</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2891/">#2891</a>(<script language="JavaScript">print_time(new Date("2007/09/04 06:48 GMT"));</script><noscript>2007/09/04 06:48 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>適用しました。</pre>
	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2891/addtag/" class="addtag" id="addtag_2891">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2891"
  >-</span><span
  class="button yellow"
  id="rating_z_2891"
  >0</span><span 
  class="button green"
  id="rating_p_2891"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2755/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2891/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2891/">
  返信
  </a>]
  </div>
</div>
</div>



  


    </div>
  


    </div>
  


    </div>
  


    </div>
  


    </div>
  


  

  

  
    




<div class="comment" id="comment2734"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/4/" target="_top">匿名</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2734/">#2734</a>(<script language="JavaScript">print_time(new Date("2007/08/31 07:48 GMT"));</script><noscript>2007/08/31 07:48 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/python/">
	  Python
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #efffef;">1/1=1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>素直にライブラリを使いましたが、お題によれば無効にしたタグ部分は
置き換えた文字以外、そのままにすべきなんでしょうが
(例えば大文字小文字など)、ライブラリの都合上、end側タグまわりの情報が劣化しています(27行目あたり)。
これは基底クラスのソース見てなんとかする必要がありそうなので
とりあえず手抜き版として投稿させていただきます。

</pre>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></td><td class="code"><div class="highlight"><pre><span class="k">from</span> <span class="nn">HTMLParser</span> <span class="k">import</span> <span class="n">HTMLParser</span>

<span class="k">class</span> <span class="nc">HTMLParser2</span><span class="p">(</span><span class="n">HTMLParser</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">HTMLParser</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s">&#39;&lt;a &#39;</span><span class="o">+</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;href&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">]])</span><span class="o">+</span><span class="s">&#39;&gt;&#39;</span>
        <span class="k">elif</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;br&#39;</span><span class="p">,</span> <span class="s">&#39;strong&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s">&#39;&lt;</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="n">tag</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_starttag_text</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&#39;&amp;lt;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_startendtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;br&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s">&#39;&lt;br/&gt;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_starttag_text</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&#39;&amp;lt;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_endtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;br&#39;</span><span class="p">,</span> <span class="s">&#39;strong&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s">&#39;&lt;/</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="n">tag</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s">&#39;&amp;lt;/</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="n">tag</span>

    <span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">data</span>

<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;&lt;a href=&#39;www.google.com&#39;&gt;link&lt;/a&gt; &lt;blink&gt;and&lt;/blink&gt; &lt;strong onClick=&#39;al</span>
<span class="s">ert(&quot;NG&quot;)&#39;&gt;click&lt;br/&gt;me!&lt;/strong&gt;&quot;&quot;&quot;</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">HTMLParser2</span><span class="p">()</span>
<span class="n">h</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="k">print</span> <span class="n">h</span><span class="o">.</span><span class="n">buf</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2734/addtag/" class="addtag" id="addtag_2734">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/python/">
		Python
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2734/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2734/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #efffef;"
  >1/1=1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2734"
  >-</span><span
  class="button yellow"
  id="rating_z_2734"
  >0</span><span 
  class="button green"
  id="rating_p_2734"
  >+</span></span></span>
  
<p>

  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2734/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2734/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2759"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/4/" target="_top">匿名</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2759/">#2759</a>(<script language="JavaScript">print_time(new Date("2007/08/31 15:13 GMT"));</script><noscript>2007/08/31 15:13 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/python/">
	  Python
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #dfffdf;">2/2=1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>お題の更新に対応してみました。
一応「&amp;」も「&amp;amp;」に置き換えるようにしました。
&lt;BR&gt;と&lt;BR/&gt;を受付け&lt;/BR&gt;は置き換えるように変更しました。

ただし、サイズが少々でかすぎますね。
</pre>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56</pre></td><td class="code"><div class="highlight"><pre><span class="k">from</span> <span class="nn">HTMLParser</span> <span class="k">import</span> <span class="n">HTMLParser</span>
<span class="k">from</span> <span class="nn">urllib</span> <span class="k">import</span> <span class="n">quote</span>

<span class="k">class</span> <span class="nc">HTMLParser2</span><span class="p">(</span><span class="n">HTMLParser</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">HTMLParser</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__endtag_text</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

  <span class="k">def</span> <span class="nf">parse_endtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawdata</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__endtag_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawdata</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> 
    <span class="k">except</span><span class="p">:</span>
      <span class="k">pass</span>
    <span class="k">return</span> <span class="n">HTMLParser</span><span class="o">.</span><span class="n">parse_endtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">get_endtag_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__endtag_text</span>

  <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s">&#39;&amp;amp;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&#39;&amp;lt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&amp;gt;&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s">&#39;&lt;a &#39;</span><span class="o">+</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">quote</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;href&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">]])</span><span class="o">+</span><span class="s">&#39;&gt;&#39;</span>
    <span class="k">elif</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;br&#39;</span><span class="p">,</span> <span class="s">&#39;strong&#39;</span><span class="p">]:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s">&#39;&lt;</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="n">tag</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_starttag_text</span><span class="p">())</span>

  <span class="k">def</span> <span class="nf">handle_startendtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;br&#39;</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s">&#39;&lt;br/&gt;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_starttag_text</span><span class="p">())</span>

  <span class="k">def</span> <span class="nf">handle_endtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;strong&#39;</span><span class="p">]:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="s">&#39;&lt;/</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="n">tag</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_endtag_text</span><span class="p">())</span>

  <span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
  <span class="n">h</span> <span class="o">=</span> <span class="n">HTMLParser2</span><span class="p">()</span>
  <span class="n">h</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  <span class="k">print</span> <span class="n">s</span>
  <span class="k">print</span> <span class="n">h</span><span class="o">.</span><span class="n">buf</span>

<span class="n">f</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;script foo=&quot;&lt;script&gt;alert(&#39;bar&#39;)&lt;/script&gt;&quot;&gt;alert(&#39;foo&#39;)&lt;/script&gt;&#39;&#39;&#39;</span><span class="p">)</span>
<span class="n">f</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;script foo=&quot;&lt;a href=&#39;link&#39;&gt;link&lt;/a&gt;&quot;&gt;alert(&#39;foo&#39;)&lt;/script&gt;&#39;&#39;&#39;</span><span class="p">)</span>
<span class="n">f</span><span class="p">(</span><span class="s">&#39;&#39;&#39;&lt;a href=&#39;www.g&gt;oogle.com&#39;&gt;link&lt;/a&gt;&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2759/addtag/" class="addtag" id="addtag_2759">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/python/">
		Python
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2759/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2759/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #dfffdf;"
  >2/2=1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2759"
  >-</span><span
  class="button yellow"
  id="rating_z_2759"
  >0</span><span 
  class="button green"
  id="rating_p_2759"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2734/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2759/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2759/">
  返信
  </a>]
  </div>
</div>
</div>



  


    </div>
  


  

  

  

  

  

  

  

  

  
    




<div class="comment" id="comment2707"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/322/" target="_top">sawat</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2707/">#2707</a>(<script language="JavaScript">print_time(new Date("2007/08/31 02:30 GMT"));</script><noscript>2007/08/31 02:30 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/javascript/">
	  JavaScript
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>正規表現置換でごり押し。
可読性最悪ですみません。</pre>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></td><td class="code"><div class="highlight"><pre><span class="k">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="s2">&quot;&lt;a href=&#39;www.google.com&#39; name=&#39;hoge&#39; title=\&quot;fuga\&quot;&gt;\</span>
<span class="s2">link&lt;/a&gt;&lt;blink&gt;and&lt;/blink&gt; &lt;strong onClick=&#39;alert(\&quot;NG\&quot;)&#39;&gt;click&lt;br/&gt;me!&lt;/strong&gt;&quot;</span><span class="o">;</span>


<span class="k">var</span> <span class="nx">reg</span> <span class="o">=</span> <span class="sr">/&lt;\s*(a|strong|br)((?:\s+\w+\s*=\s*([&quot;&#39;]).*?\3)*)?\s*(?:&gt;(([^&lt;]*|&lt;[^&lt;&gt;]*[^\/]&gt;|&lt;[^&lt;&gt;]*\/&gt;)*)&lt;\/s*\1\s*&gt;|\/&gt;)/gmi</span><span class="o">;</span>

<span class="k">function</span> <span class="nx">deleteAttr</span><span class="p">(</span><span class="nx">attr</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+(\w+)\s*=\s*([&quot;&#39;])(.*?)\2/g</span><span class="o">,</span> <span class="k">function</span><span class="p">(</span><span class="nx">all</span><span class="o">,</span> <span class="nx">name</span><span class="o">,</span> <span class="nx">q</span><span class="o">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">name</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/name|href/i</span><span class="p">))</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">;</span>
    <span class="k">else</span> <span class="k">return</span> <span class="nx">all</span><span class="o">;</span>
  <span class="p">});</span>
<span class="p">}</span>
<span class="k">function</span> <span class="nx">eacapeTags</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">var</span> <span class="nx">escaped</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="nx">str</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">reg</span><span class="o">,</span> <span class="k">function</span><span class="p">(</span><span class="nx">all</span><span class="o">,</span> <span class="nx">tag</span><span class="o">,</span> <span class="nx">attr</span><span class="o">,</span> <span class="nx">q</span><span class="o">,</span> <span class="nx">inner</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">attr</span> <span class="o">=</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span> <span class="o">?</span> <span class="nx">deleteAttr</span><span class="p">(</span><span class="nx">attr</span><span class="p">)</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="o">;</span>
    <span class="nx">escaped</span> <span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tag</span><span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">attr</span><span class="o">,</span> <span class="nx">inner</span><span class="p">);</span>
    <span class="k">return</span> <span class="s2">&quot;&lt;A/&gt;&quot;</span><span class="o">;</span>
  <span class="p">}).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;/g</span><span class="o">,</span> <span class="s2">&quot;&amp;lt;&quot;</span><span class="p">);</span>
  <span class="nx">str</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;lt;A\/&gt;/g</span><span class="o">,</span> <span class="k">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nx">tag</span> <span class="o">=</span> <span class="nx">escaped</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span><span class="o">,</span> <span class="nx">inner</span> <span class="o">=</span> <span class="nx">escaped</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">inner</span><span class="p">)</span> <span class="k">return</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="nx">tag</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span> <span class="o">+</span> <span class="nx">eacapeTags</span><span class="p">(</span><span class="nx">inner</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&lt;/&quot;</span> <span class="o">+</span> <span class="nx">tag</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span><span class="o">;</span>
    <span class="k">else</span> <span class="k">return</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="nx">tag</span> <span class="o">+</span> <span class="s2">&quot;/&gt;&quot;</span><span class="o">;</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">str</span><span class="o">;</span>
<span class="p">}</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">innerHTML</span><span class="o">=</span><span class="p">(</span><span class="nx">eacapeTags</span><span class="p">(</span><span class="nx">input</span><span class="p">));</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2707/addtag/" class="addtag" id="addtag_2707">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/javascript/">
		JavaScript
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2707/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2707/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2707"
  >-</span><span
  class="button yellow"
  id="rating_z_2707"
  >0</span><span 
  class="button green"
  id="rating_p_2707"
  >+</span></span></span>
  
<p>

  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2707/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2707/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2718"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/322/" target="_top">sawat</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2718/">#2718</a>(<script language="JavaScript">print_time(new Date("2007/08/31 04:36 GMT"));</script><noscript>2007/08/31 04:36 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/javascript/">
	  JavaScript
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #cfffaf;">3/5=0.60</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>ちょっと無駄に難しく作りすぎました。
開きタグと閉じタグは個別に扱っても構わなかったのか。
ところで、（要件に含まれるのかわかりませんが）属性に"&gt;"が含まれるケースを考慮してない回答が結構ありますね。</pre>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></td><td class="code"><div class="highlight"><pre><span class="k">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="s2">&quot;&lt;a title=\&quot;(&gt;_&lt;;)\&quot; href=&#39;www.google.com&#39; name=&#39;hoge&#39;&gt;\</span>
<span class="s2">link&lt;/a&gt;&lt;blink&gt;and&lt;/blink&gt; &lt;strong onClick=&#39;alert(\&quot;NG\&quot;)&#39;&gt;click&lt;br/&gt;me!&lt;/strong&gt;&quot;</span><span class="o">;</span>

<span class="k">function</span> <span class="nx">deleteAttr</span><span class="p">(</span><span class="nx">attr</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+(\w+)\s*=\s*([&quot;&#39;])(.*?)\2/g</span><span class="o">,</span> <span class="k">function</span><span class="p">(</span><span class="nx">all</span><span class="o">,</span> <span class="nx">name</span><span class="o">,</span> <span class="nx">q</span><span class="o">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">name</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/name|href/i</span><span class="p">)</span> <span class="o">?</span> <span class="nx">all</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="o">;</span>
  <span class="p">});</span>
<span class="p">}</span>
<span class="k">function</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">html</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;(\/?)(\w+)((?:\s+\w+\s*=\s*([&quot;&#39;]).*?\4)*)?(\/?)&gt;/gmi</span><span class="o">,</span>
      <span class="k">function</span><span class="p">(</span><span class="nx">all</span><span class="o">,</span> <span class="nx">fslash</span><span class="o">,</span> <span class="nx">tag</span><span class="o">,</span> <span class="nx">attrs</span><span class="o">,</span> <span class="nx">q</span><span class="o">,</span> <span class="nx">rslash</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">switch</span><span class="p">(</span><span class="nx">tag</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">())</span> <span class="p">{</span>
           <span class="nx">case</span> <span class="s1">&#39;STRONG&#39;</span> <span class="o">:</span>  <span class="c">// drop through</span>
           <span class="nx">case</span> <span class="s1">&#39;BR&#39;</span> <span class="o">:</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">;</span> <span class="k">break</span><span class="o">;</span>
           <span class="nx">case</span> <span class="s1">&#39;A&#39;</span> <span class="o">:</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="nx">deleteAttr</span><span class="p">(</span><span class="nx">attrs</span><span class="p">);</span> <span class="k">break</span><span class="o">;</span>
           <span class="nx">default</span> <span class="o">:</span> <span class="k">return</span> <span class="nx">all</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="o">,</span> <span class="s1">&#39;&amp;amp;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="o">,</span> <span class="s1">&#39;&amp;lt;&#39;</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="k">return</span> <span class="s1">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="nx">fslash</span> <span class="o">+</span> <span class="nx">tag</span> <span class="o">+</span> <span class="nx">attrs</span> <span class="o">+</span> <span class="nx">rslash</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span><span class="o">;</span>
      <span class="p">});</span>
<span class="p">}</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">innerHTML</span><span class="o">=</span><span class="nx">filter</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2718/addtag/" class="addtag" id="addtag_2718">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/javascript/">
		JavaScript
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2718/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2718/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #cfffaf;"
  >3/5=0.60</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2718"
  >-</span><span
  class="button yellow"
  id="rating_z_2718"
  >0</span><span 
  class="button green"
  id="rating_p_2718"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2707/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2718/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2718/">
    2
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2718/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2741"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/1/" target="_top">にしお</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2741/">#2741</a>(<script language="JavaScript">print_time(new Date("2007/08/31 09:19 GMT"));</script><noscript>2007/08/31 09:19 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #efffef;">1/1=1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  
<p>&gt;属性に&quot;&gt;&quot;が含まれるケースを考慮してない回答が結構ありますね。
</p>
<p>ちなみに僕はどのコードがダメなのか公表してしまった方が(そのコードを書いた人が将来その罠に気づかずに脆弱性のあるプログラムを書いてしまうよりは)いいと思っているので、その手の指摘はたいがいプラス評価しています。
</p>



	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2741/addtag/" class="addtag" id="addtag_2741">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #efffef;"
  >1/1=1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2741"
  >-</span><span
  class="button yellow"
  id="rating_z_2741"
  >0</span><span 
  class="button green"
  id="rating_p_2741"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2718/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2741/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2741/">
  返信
  </a>]
  </div>
</div>
</div>



  


    </div>
  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2750"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/322/" target="_top">sawat</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2750/">#2750</a>(<script language="JavaScript">print_time(new Date("2007/08/31 10:40 GMT"));</script><noscript>2007/08/31 10:40 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/diff/">
	  diff
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #efffef;">1/1=1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>バグありました… orz
</pre>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre>1
2
3
4
5</pre></td><td class="code"><div class="highlight"><pre><span class="gu">@@ -15,3 +15,3 @@</span>
            case &#39;A&#39; : attrs = deleteAttr(attrs); break;
<span class="gd">-           default : return all.replace(&#39;&amp;&#39;, &#39;&amp;amp;&#39;).replace(&#39;&lt;&#39;, &#39;&amp;lt;&#39;);</span>
<span class="gi">+           default : return all.replace(/&amp;/g, &#39;&amp;amp;&#39;).replace(/&lt;/g, &#39;&amp;lt;&#39;);</span>
          }
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2750/addtag/" class="addtag" id="addtag_2750">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/diff/">
		diff
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2750/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/2750/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #efffef;"
  >1/1=1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2750"
  >-</span><span
  class="button yellow"
  id="rating_z_2750"
  >0</span><span 
  class="button green"
  id="rating_p_2750"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2718/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2750/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2750/">
  返信
  </a>]
  </div>
</div>
</div>



  


    </div>
  


    </div>
  


  

  

  
    




<div class="comment" id="comment4913"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/618/" target="_top">lieutar</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/4913/">#4913</a>(<script language="JavaScript">print_time(new Date("2007/12/21 08:15 GMT"));</script><noscript>2007/12/21 08:15 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/perl/">
	  Perl
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>短かさにこだわってみました. 
&amp;#x3C; とかは反則ですか?</pre>
	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre>1
2
3
4
5
6
7
8</pre></td><td class="code"><div class="highlight"><pre><span class="c1">#! /usr/bin/perl</span>
<span class="k">sub </span><span class="nf">E</span><span class="p">($){</span> <span class="nb">local</span> <span class="nv">$_</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span> <span class="sr">s/([&amp;&lt;&gt;&quot;&#39;])/sprintf(&#39;&amp;#x%02X;&#39;,ord $1)/eg</span><span class="p">;</span> <span class="nv">$_</span><span class="p">;</span> <span class="p">}</span>
<span class="k">sub </span><span class="nf">T</span><span class="p">($){</span> <span class="nb">local</span> <span class="nv">$_</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span> <span class="nb">no</span> <span class="n">warnings</span><span class="p">;</span>
          <span class="n">s</span><span class="c1">#^&lt;(/?(?:br|strong))\b.*$#&lt;$1&gt;#i ? $_ :</span>
            <span class="n">s</span><span class="c1">#^&lt;(/?a\b)[^&gt;]*?(\s?(?:href|name)=(?:&#39;[^&#39;]*&#39;|&quot;[^&quot;]*&quot;|[^&gt;\s]*))?</span>
              <span class="p">[</span><span class="o">^&gt;</span><span class="p">]</span><span class="o">*</span><span class="p">?(</span><span class="o">\</span><span class="n">s</span><span class="p">?(?:</span><span class="n">href</span><span class="o">|</span><span class="n">name</span><span class="p">)</span><span class="o">=</span><span class="p">(?:</span><span class="s">&#39;[^&#39;</span><span class="p">]</span><span class="o">*</span><span class="s">&#39;|&quot;[^&quot;]*&quot;|[^&gt;\s]*))?[^&gt;]*?&gt;</span>
<span class="s">              #&lt;$1$2$3&gt;#xi ? $_ : E $_;  }</span>
<span class="s">$_ = join &#39;</span><span class="err">&#39;</span><span class="p">,</span> <span class="o">&lt;&gt;</span><span class="p">;</span> <span class="n">s</span><span class="c1">#(.*?)(&lt;/?\w+\b[^&gt;]*&gt;)#E($1).T($2)#eg; print;</span>
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/4913/addtag/" class="addtag" id="addtag_4913">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/perl/">
		Perl
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/4913/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/4913/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_4913"
  >-</span><span
  class="button yellow"
  id="rating_z_4913"
  >0</span><span 
  class="button green"
  id="rating_p_4913"
  >+</span></span></span>
  
<p>

  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/4913/">
  返信
  </a>]
  </div>
</div>
</div>



  


  

  
    




<div class="comment" id="comment2703"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/4/" target="_top">匿名</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2703/">#2703</a>(<script language="JavaScript">print_time(new Date("2007/08/30 23:44 GMT"));</script><noscript>2007/08/30 23:44 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffefef;">-1/1=-1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>タグを無効化するために「&lt;」のサニタイズするのなら
「;」も対象にしたほうが良い予感?

</pre>
	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2703/addtag/" class="addtag" id="addtag_2703">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #ffefef;"
  >-1/1=-1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2703"
  >-</span><span
  class="button yellow"
  id="rating_z_2703"
  >0</span><span 
  class="button green"
  id="rating_p_2703"
  >+</span></span></span>
  
<p>

  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2703/">
    2
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2703/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2709"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/1/" target="_top">にしお</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2709/">#2709</a>(<script language="JavaScript">print_time(new Date("2007/08/31 03:01 GMT"));</script><noscript>2007/08/31 03:01 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>それはなぜですか？</pre>
	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2709/addtag/" class="addtag" id="addtag_2709">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2709"
  >-</span><span
  class="button yellow"
  id="rating_z_2709"
  >0</span><span 
  class="button green"
  id="rating_p_2709"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2703/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2709/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2709/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2709/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2714"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/4/" target="_top">匿名</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2714/">#2714</a>(<script language="JavaScript">print_time(new Date("2007/08/31 03:40 GMT"));</script><noscript>2007/08/31 03:40 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffefef;">-1/1=-1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>エンティティの無効化です。
このお題で必要かと問われると怪しいですけど、
きっとタグが有効になると何か影響でちゃうのですよね？
タグが特別なものであるとしてとらえると
タグを無効化する必要のある処理であるならば
エンティティも一緒に無効化しても良いかなと。

個人的な好みが強いですが片手落ちというイメージが。。。
</pre>
	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2714/addtag/" class="addtag" id="addtag_2714">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #ffefef;"
  >-1/1=-1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2714"
  >-</span><span
  class="button yellow"
  id="rating_z_2714"
  >0</span><span 
  class="button green"
  id="rating_p_2714"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2709/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2714/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2714/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2714/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2745"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/1/" target="_top">にしお</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2745/">#2745</a>(<script language="JavaScript">print_time(new Date("2007/08/31 09:54 GMT"));</script><noscript>2007/08/31 09:54 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  
<p>なるほど。エンティティや実体参照を許すとどういう脆弱性につながるのかは寡聞にして知りませんが、セミコロンをエスケープしても要件を満たしていそうなので気になるのならそうしてもいいと思います。
</p>
<p>ちなみに&amp;hearts;のセミコロンを&amp;semicolon;に置き換えてもハートマークは表示されるみたいですね。
</p>
<p>このサイトはセミコロンをエスケープしていませんが、アンパサンドはエスケープしています。
</p>



	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2745/addtag/" class="addtag" id="addtag_2745">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2745"
  >-</span><span
  class="button yellow"
  id="rating_z_2745"
  >0</span><span 
  class="button green"
  id="rating_p_2745"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2714/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2745/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  <a href="/web/20100821161904/http://ja.doukaku.org/comment/2745/">
    1
    reply
  </a>

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2745/">
  返信
  </a>]
  </div>
</div>
</div>



  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2748"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/4/" target="_top">匿名</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2748/">#2748</a>(<script language="JavaScript">print_time(new Date("2007/08/31 10:06 GMT"));</script><noscript>2007/08/31 10:06 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <pre class='compact'>きゅ～勘違いしてました。
「;」のエンティティって存在しないみたいです。
「&amp;」で十分です。

昔、エンティティを無効にするときは「;」というのを読んだ気がしたんだけど、うーんソースが見つからない。

なんでエンティティを無効にしないといけなかったんだっけな～？
何か理由があったはずなんだけど。</pre>
	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2748/addtag/" class="addtag" id="addtag_2748">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2748"
  >-</span><span
  class="button yellow"
  id="rating_z_2748"
  >0</span><span 
  class="button green"
  id="rating_p_2748"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2745/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2748/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2748/">
  返信
  </a>]
  </div>
</div>
</div>



  


    </div>
  


    </div>
  


    </div>
  


    </div>
  
    <div class="indent compact" style="position: relative;">
      <img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/1x1dark_green.png" width=10 style="position: absolute;top:-10px;margin-left:8px;">
      




<div class="comment" id="comment2713"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/4/" target="_top">匿名</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2713/">#2713</a>(<script language="JavaScript">print_time(new Date("2007/08/31 03:40 GMT"));</script><noscript>2007/08/31 03:40 GMT</noscript>)
	
	
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #efffef;">1/1=1.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  実体参照の話であれば ; というよりも &amp; を &amp;amp; にしなくていいいのかということですよね。違うかな。。
	</div>
	
	
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/2713/addtag/" class="addtag" id="addtag_2713">タグ</a>:
	なし&nbsp;

	

  
  <span class="rating">
  評価<span style="background-color: #efffef;"
  >1/1=1.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_2713"
  >-</span><span
  class="button yellow"
  id="rating_z_2713"
  >0</span><span 
  class="button green"
  id="rating_p_2713"
  >+</span></span></span>
  
<p>

  
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2703/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoparent.png" alt="parent"></a>
    <a href="/web/20100821161904/http://ja.doukaku.org/comment/2713/root/"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/gotoroot.png" alt="thread root"></a>
  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/2713/">
  返信
  </a>]
  </div>
</div>
</div>



  


    </div>
  


  

  
    




<div class="comment" id="comment9613"><!--dj-->
  <p class="banner"><a href="/web/20100821161904/http://ja.doukaku.org/user/793/" target="_top">genzou</a><a href="/web/20100821161904/http://ja.doukaku.org/qa/#anomark" target="_top"><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/anomark.png" border=0/></a>

	
	&nbsp;
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/9613/">#9613</a>(<script language="JavaScript">print_time(new Date("2009/09/28 04:10 GMT"));</script><noscript>2009/09/28 04:10 GMT</noscript>)
	
	
	
	[<a href="/web/20100821161904/http://ja.doukaku.org/lang/groovy/">
	  Groovy
	</a>]
	
	
	
	&nbsp;
<span class="rating">評価<span style="background-color: #ffffff;">0/0=0.00</span></span>
  </p>

  <div class="comment_content" >
	<div class="comment_body">
	  <p>たぶんこれでできているのではないかな？</p>

	</div>
	
	
	
    <div class="compact">
      <table><tr><td class="linenos"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></td><td class="code"><div class="highlight"><pre>#!/usr/bin/env groovy

String.metaClass.define{
    escapeHtml{
        delegate.replace(&quot;&lt;&quot;, &quot;&amp;lt;&quot;).replace(&quot;&gt;&quot;, &quot;&amp;gt;&quot;)
    }
}

def text = System.in.text
// 属性値の置換
text = text.replaceAll(/(?&lt;=&quot;|&#39;).+?[^\\](?=&#39;|&quot;)/){
    it.escapeHtml()
}
// HTMLタグの置換
text = text.replaceAll(/&lt;\/?(\w+).*?\/?&gt;/){ all, name -&gt;
    def ret = &quot;&quot;
    switch( name ){
        case ~/(?i)a/:
            // aタグhref属性のみURLエンコード処理
            ret = all.replaceAll(/(?&lt;=href=&quot;|&#39;).+?[^\\](?=&#39;|&quot;)/){
                it.replace(&quot;&amp;lt;&quot;,&quot;%3C&quot;).replace(&quot;&amp;gt;&quot;, &quot;%3E&quot;)
            }
            break
        case ~/(?i)br|strong/:
            ret = &quot;&lt;${name} /&gt;&quot;
            break
        default:
            ret = all.escapeHtml()
            break
    }
    ret
}

println text
</pre></div>
</td></tr></table>
    </div>
	

  
  <div align = "right" class="banner">
	
	<a href="/web/20100821161904/http://ja.doukaku.org/comment/9613/addtag/" class="addtag" id="addtag_9613">タグ</a>:
	なし&nbsp;

	
      [<a href="/web/20100821161904/http://ja.doukaku.org/lang/groovy/">
		Groovy
      </a>]
	  
      [<a href="/web/20100821161904/http://ja.doukaku.org/comment/9613/download/">
		ダウンロード
      </a>]
	  [<a href="/web/20100821161904/http://ja.doukaku.org/comment/9613/download_html/">
		HTML
      </a>]<p>
	

  
  <span class="rating">
  評価<span style="background-color: #ffffff;"
  >0/0=0.00</span
  ><span class="buttons"><span 
  class="button red"
  id="rating_n_9613"
  >-</span><span
  class="button yellow"
  id="rating_z_9613"
  >0</span><span 
  class="button green"
  id="rating_p_9613"
  >+</span></span></span>
  
<p>

  

  

  [<a href="/web/20100821161904/http://ja.doukaku.org/54/reply_to/9613/">
  返信
  </a>]
  </div>
</div>
</div>



  


  







</div>

<div id="side_menu" class="compact">

<iframe src="/web/20100821161904if_/http://ja.doukaku.org/login_info/" frameborder=0 width=100% id="login_info">
iframe required
</iframe>

<h4 class="semi_compact">一覧</h4>

<ul>
<li><a href="/web/20100821161904/http://ja.doukaku.org/lang/">言語</a>
<li><a href="/web/20100821161904/http://ja.doukaku.org/challenge/">お題</a>
<li><a href="/web/20100821161904/http://ja.doukaku.org/topic/">トピック</a>
<li><a href="/web/20100821161904/http://ja.doukaku.org/comment/">投稿</a>
<li><a href="/web/20100821161904/http://ja.doukaku.org/good_comments/">評価の高い投稿</a>
<li><a href="/web/20100821161904/http://ja.doukaku.org/tag/">タグ</a>
</ul>

<h4 class="compact">フィード</h4>
<ul>
<li><a href="/web/20100821161904/http://ja.doukaku.org/feeds/topics/">最新のトピック</a><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/feed_icon.png">
<li><a href="/web/20100821161904/http://ja.doukaku.org/feeds/comments/">新着投稿</a><img src="/web/20100821161904im_/http://ja.doukaku.org/static/image/feed_icon.png">
</ul>

<h4 class="compact">その他</h4>
<ul>
<li><a href="/web/20100821161904/http://ja.doukaku.org/qa/">Q&amp;A</a>
<li><a href="/web/20100821161904/http://ja.doukaku.org/feedback/">フィードバック</a>
<!--<li><a href="/terms">用語集</a>-->
</ul>


<h4 class="compact">リンク</h4>
<ul>
<li><a href="/web/20100821161904/http://labs.cybozu.co.jp/">サイボウズ・ラボ</a>
<li><a href="/web/20100821161904/http://www.djangoproject.com/">Django</a>
</ul>


</div>
</div>


<div id="page_foot" class="bordered">
<a rel="license" href="/web/20100821161904/http://creativecommons.org/licenses/by/2.1/jp/">
<img alt="Creative Commons License" style="border-width:0" src="/web/20100821161904im_/http://i.creativecommons.org/l/by/2.1/jp/88x31.png" /></a>
このサイトの内容は、
<a rel="license" href="/web/20100821161904/http://creativecommons.org/licenses/by/2.1/jp/">クリエイティブ・コモンズ・ライセンス</a>の下でライセンスされています。
<a href="/web/20100821161904/http://ja.doukaku.org/qa/#licence">[詳細]</a>
</div>

</body>



<script type="text/javascript">
$(document).ready(function(){$("#doukaku_org").after("<script src='/web/20100821161904/http://api.pathtraq.com/pages?url=http%3A%2F%2Fja.doukaku.org%2Fcomment%2F*%2F%20desc%3A%E3%81%A9%E3%81%86%E6%9B%B8%E3%81%8Forg&api=json&callback=addPathtraq'><" + "/script>")});
</script>

<script src="/web/20100821161904js_/http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-2136157-1";
urchinTracker();
</script>



</html>





<!--
     FILE ARCHIVED ON 16:19:04 Aug 21, 2010 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 15:15:23 Nov 16, 2013.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
